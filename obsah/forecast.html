<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P≈ôedpovƒõƒè poƒças√≠ - roz≈°√≠≈ôen√° verze</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .hlavicka {
            background-color: #2d2d2d;
            color: #e0e0e0;
            padding: 12px 20px;
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        .hlavicka h1 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
        }

        .obsah {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .menu {
            width: 280px;
            background-color: #2a2a2a;
            border-right: 1px solid #404040;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sekce {
            margin-bottom: 25px;
        }

        .sekce h2 {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            background-color: #404040;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #6aa6fd;
        }

        .search-container {
            position: relative;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #404040;
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            color: #e0e0e0;
            font-size: 0.9rem;
            border-bottom: 1px solid #555;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #6aa6fd;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 500;
        }

        .suggestion-details {
            font-size: 0.8rem;
            color: #bbb;
            margin-top: 2px;
        }

        .checkbox-group {
            margin-bottom: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #e0e0e0;
            margin-bottom: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .btn {
            background-color: #6aa6fd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: #5694f0;
        }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #666;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background-color: #777;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .btn-group .btn.active {
            background-color: #6aa6fd;
            border: 2px solid #4a90e2;
        }

        .btn-group .btn:not(.active) {
            background-color: #444;
            color: #ccc;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-size: 0.9rem;
            z-index: 10000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: #4caf50;
            border-left: 4px solid #45a049;
        }

        .notification.info {
            background-color: #2196f3;
            border-left: 4px solid #1976d2;
        }

        .notification.warning {
            background-color: #ff9800;
            border-left: 4px solid #f57c00;
        }

        .notification.error {
            background-color: #f44336;
            border-left: 4px solid #d32f2f;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .pracovni-plocha {
            flex: 1;
            background-color: #1a1a1a;
            padding: 20px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .error {
            background-color: #4a2c2c;
            border: 1px solid #8b4444;
            color: #ff8888;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .chart-container {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .weather-preview {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .weather-preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
            text-align: center;
        }

        .weather-days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .weather-day {
            text-align: center;
            padding: 10px;
            background-color: #333;
            border-radius: 8px;
            border: 1px solid #444;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .weather-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106, 166, 253, 0.3);
        }

        .weather-day-date {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .weather-day-icon {
            font-size: 2rem;
            margin: 5px 0;
            display: block;
        }

        .weather-day-temp {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 3px;
        }

        .weather-day-desc {
            font-size: 0.7rem;
            color: #999;
            line-height: 1.2;
        }

        .weather-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: #999;
            margin-top: 10px;
        }

        .weather-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .data-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .source-indicator {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #ccc;
        }

        .source-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }

        .tab-container {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background-color: #333;
            border-bottom: 1px solid #404040;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background-color: #444;
            color: #e0e0e0;
        }

        .tab-button.active {
            color: #6aa6fd;
            border-bottom-color: #6aa6fd;
            background-color: #2a2a2a;
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .obsah {
                flex-direction: column;
            }

            .menu {
                width: 100%;
                height: auto;
                max-height: 300px;
                overflow-y: auto;
            }

            .chart-wrapper {
                height: 300px;
            }

            .weather-days-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 10px;
            }

            .weather-day {
                padding: 8px;
            }

            .weather-day-icon {
                font-size: 1.5rem;
            }

            .weather-legend {
                gap: 10px;
            }

            .weather-legend-item {
                font-size: 0.7rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .tab-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="hlavicka">
            <h1>üå§Ô∏è P≈ôedpovƒõƒè poƒças√≠ - roz≈°√≠≈ôen√° verze</h1>
        </div>
        
        <div class="obsah">
            <div class="menu">
                <div class="sekce">
                    <h2>Lokace</h2>
                    <div class="input-group">
                        <label for="location">Mƒõsto nebo GPS sou≈ôadnice:</label>
                        <div class="search-container">
                            <input type="text" id="location" placeholder="Zaƒçnƒõte ps√°t n√°zev mƒõsta..." value="Praha">
                            <div class="suggestions" id="suggestions"></div>
                        </div>
                    </div>
                </div>

                <div class="sekce">
                    <h2>ƒåasov√Ω rozsah</h2>
                    <div class="btn-group">
                        <button class="btn active" data-days="7">7 dn√≠</button>
                        <button class="btn" data-days="14">14 dn√≠</button>
                        <button class="btn" data-days="30">30 dn√≠</button>
                    </div>
                </div>

                <div class="sekce">
                    <h2>Zdroje dat</h2>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="openweather" checked>
                            OpenWeatherMap
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="weatherapi" checked>
                            WeatherAPI
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="openmeteo" checked>
                            Open-Meteo
                        </label>
                    </div>
                </div>

                <div class="sekce">
                    <h2>Zobrazovan√© √∫daje</h2>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="temperature" checked>
                            Teplota (¬∞C)
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="precipitation" checked>
                            Sr√°≈æky (mm)
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="humidity" checked>
                            Vlhkost (%)
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="windspeed" checked>
                            Rychlost vƒõtru (m/s)
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="pressure">
                            Tlak (hPa)
                        </label>
                    </div>
                </div>

                <div class="sekce">
                    <button class="btn" id="loadData">Naƒç√≠st p≈ôedpovƒõƒè</button>
                    <button class="btn btn-secondary" id="resetSettings">Resetovat nastaven√≠</button>
                </div>
            </div>

            <div class="pracovni-plocha">
                <div class="tab-container">
                    <div class="tab-header" style="display: none;">
                        <button class="tab-button active" data-tab="forecast">üìä P≈ôedpovƒõƒè</button>
                        </div>
                    
                    <div class="tab-content active" id="forecast-tab">
                        <div id="forecast-container">
                            <div class="loading">
                                <p>Vyberte lokaci a zdroje dat, pot√© kliknƒõte na "Naƒç√≠st p≈ôedpovƒõƒè"</p>
                            </div>
                        </div>
                    </div>
                    
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let charts = {};
        let searchTimeout;
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];
        let selectedDays = 7;
        
        const API_KEYS = {
            openweather: 'f28e1a8704dcd8ef304a4e7e83b5cc2d',
            weatherapi: 'eb06c8a0f79f4f918ce103738251807'
        };

        // Funkce pro ulo≈æen√≠ nastaven√≠
        function saveSettings() {
            const settings = {
                location: document.getElementById('location').value,
                selectedDays: selectedDays,
                sources: {
                    openweather: document.getElementById('openweather').checked,
                    weatherapi: document.getElementById('weatherapi').checked,
                    openmeteo: document.getElementById('openmeteo').checked
                },
                metrics: {
                    temperature: document.getElementById('temperature').checked,
                    precipitation: document.getElementById('precipitation').checked,
                    humidity: document.getElementById('humidity').checked,
                    windspeed: document.getElementById('windspeed').checked,
                    pressure: document.getElementById('pressure').checked
                },
                timestamp: new Date().toISOString()
            };
            
            try {
                console.log('Nastaven√≠ ulo≈æeno:', settings);
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠:', error);
            }
        }

        // Funkce pro naƒçten√≠ nastaven√≠
        function loadSettings() {
            try {
                console.log('Naƒç√≠t√°m v√Ωchoz√≠ nastaven√≠');
                return false;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:', error);
            }
            return false;
        }

        // Funkce pro reset nastaven√≠
        function resetSettings() {
            try {
                console.log('Nastaven√≠ resetov√°no');
                
                document.getElementById('location').value = 'Praha';
                document.getElementById('openweather').checked = true;
                document.getElementById('weatherapi').checked = true;
                document.getElementById('openmeteo').checked = true;
                document.getElementById('temperature').checked = true;
                document.getElementById('precipitation').checked = true;
                document.getElementById('humidity').checked = true;
                document.getElementById('windspeed').checked = true;
                document.getElementById('pressure').checked = false;
                
                selectedDays = 7;
                updateDaysButtons();
                
                showNotification('Nastaven√≠ bylo resetov√°no na v√Ωchoz√≠ hodnoty', 'success');
                loadAndDisplayData();
            } catch (error) {
                console.error('Chyba p≈ôi resetov√°n√≠ nastaven√≠:', error);
            }
        }

        // Funkce pro aktualizaci tlaƒç√≠tek dn≈Ø
        function updateDaysButtons() {
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.days) === selectedDays) {
                    btn.classList.add('active');
                }
            });
        }

        // Tab funkcionality
        function initTabs() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // Funkce pro z√≠sk√°n√≠ ikony poƒças√≠ podle podm√≠nek
        function getWeatherIcon(temp, precipitation, humidity, windspeed) {
            temp = temp || 0;
            precipitation = precipitation || 0;
            humidity = humidity || 50;
            windspeed = windspeed || 0;

            if (precipitation > 10) {
                if (temp < 0) return "‚ùÑÔ∏è";
                if (precipitation > 20) return "üåßÔ∏è";
                return "üå¶Ô∏è";
            }
            
            if (precipitation > 2) {
                return "üå§Ô∏è";
            }
            
            if (humidity > 85 || windspeed > 8) {
                return "‚òÅÔ∏è";
            }
            
            if (temp > 30) {
                return "üå°Ô∏è";
            }
            
            if (temp > 25) {
                return "‚òÄÔ∏è";
            }
            
            if (temp > 15) {
                return "üå§Ô∏è";
            }
            
            if (temp > 5) {
                return "üå•Ô∏è";
            }
            
            if (temp > 0) {
                return "üå®Ô∏è";
            }
            
            return "ü•∂";
        }

        // Funkce pro z√≠sk√°n√≠ popisu poƒças√≠
        function getWeatherDescription(temp, precipitation, humidity, windspeed) {
            temp = temp || 0;
            precipitation = precipitation || 0;
            humidity = humidity || 50;
            windspeed = windspeed || 0;

            let desc = [];
            
            if (temp > 30) desc.push("velmi teplo");
            else if (temp > 25) desc.push("teplo");
            else if (temp > 15) desc.push("p≈ô√≠jemnƒõ");
            else if (temp > 5) desc.push("chladnƒõji");
            else if (temp > 0) desc.push("chladno");
            else desc.push("mr√°z");
            
            if (precipitation > 20) desc.push("siln√Ω d√©≈°≈•");
            else if (precipitation > 10) desc.push("d√©≈°≈•");
            else if (precipitation > 2) desc.push("mo≈æn√Ω d√©≈°≈•");
            
            if (windspeed > 10) desc.push("vƒõtrno");
            else if (windspeed > 6) desc.push("m√≠rn√Ω v√≠tr");
            
            if (humidity > 90) desc.push("velmi vlhko");
            else if (humidity < 30) desc.push("sucho");
            
            return desc.join(", ");
        }

        // Funkce pro vytvo≈ôen√≠ kombinovan√©ho grafu hodinov√Ωch dat
        function createHourlyChart(containerId, hourlyData) {
            const ctx = document.getElementById(containerId).getContext('2d');
            
            if (charts[containerId]) {
                charts[containerId].destroy();
            }

            if (!hourlyData || !hourlyData.hourly || hourlyData.hourly.length === 0) {
                return;
            }

            const now = new Date();
            const currentHour = now.getHours();
            const next24Hours = hourlyData.hourly.slice(currentHour, currentHour + 24);

            const labels = next24Hours.map(hour => {
                const time = new Date(hour.time);
                return time.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            });

            const temperatureData = next24Hours.map(hour => hour.temperature);
            const precipitationData = next24Hours.map(hour => hour.precipitation);
            const windspeedData = next24Hours.map(hour => hour.windspeed);
            const humidityData = next24Hours.map(hour => hour.humidity);

            charts[containerId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Teplota (¬∞C)',
                            data: temperatureData,
                            borderColor: '#ff6b6b',
                            backgroundColor: '#ff6b6b20',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Sr√°≈æky (mm)',
                            data: precipitationData,
                            type: 'bar',
                            backgroundColor: '#4ecdc480',
                            borderColor: '#4ecdc4',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Rychlost vƒõtru (m/s)',
                            data: windspeedData,
                            borderColor: '#45b7d1',
                            backgroundColor: '#45b7d120',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'Vlhkost (%)',
                            data: humidityData,
                            borderColor: '#feca57',
                            backgroundColor: '#feca5720',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#6aa6fd',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    
                                    if (context.parsed.y !== null) {
                                        const value = context.parsed.y.toFixed(1);
                                        if (context.dataset.label.includes('Teplota')) {
                                            label += value + '¬∞C';
                                        } else if (context.dataset.label.includes('Sr√°≈æky')) {
                                            label += value + 'mm';
                                        } else if (context.dataset.label.includes('v√≠tr')) {
                                            label += value + 'm/s';
                                        } else if (context.dataset.label.includes('Vlhkost')) {
                                            label += value + '%';
                                        }
                                    }
                                    
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const hour = next24Hours[index];
                                    if (hour) {
                                        const icon = getWeatherIcon(hour.temperature, hour.precipitation, hour.humidity, hour.windspeed);
                                        const desc = getWeatherDescription(hour.temperature, hour.precipitation, hour.humidity, hour.windspeed);
                                        return [`${icon} ${desc}`];
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxTicksLimit: 12
                            },
                            grid: {
                                color: '#404040'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                color: '#ff6b6b',
                                callback: function(value) {
                                    return value + '¬∞C';
                                }
                            },
                            grid: {
                                color: '#404040'
                            },
                            title: {
                                display: true,
                                text: 'Teplota (¬∞C)',
                                color: '#ff6b6b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            ticks: {
                                color: '#4ecdc4',
                                callback: function(value) {
                                    return value + 'mm';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Sr√°≈æky (mm)',
                                color: '#4ecdc4'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 20
                        },
                        y3: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        // Funkce pro vytvo≈ôen√≠ kombinovan√©ho grafu pro v√≠ce dn√≠
        function createDailyChart(containerId, weatherData) {
            const ctx = document.getElementById(containerId).getContext('2d');
            
            if (charts[containerId]) {
                charts[containerId].destroy();
            }

            if (!weatherData || weatherData.length === 0) {
                return;
            }

            const sourceData = weatherData[0];
            const days = sourceData.daily;

            const labels = days.map(day => {
                const date = new Date(day.date);
                return date.toLocaleDateString('cs-CZ', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'numeric' 
                });
            });

            const temperatureData = days.map(day => day.temperature_max);
            const precipitationData = days.map(day => day.precipitation);
            const windspeedData = days.map(day => day.windspeed);
            const humidityData = days.map(day => day.humidity);
            const pressureData = days.map(day => day.pressure);

            const datasets = [
                {
                    label: 'Teplota (¬∞C)',
                    data: temperatureData,
                    borderColor: '#ff6b6b',
                    backgroundColor: '#ff6b6b20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y'
                },
                {
                    label: 'Sr√°≈æky (mm)',
                    data: precipitationData,
                    type: 'bar',
                    backgroundColor: '#4ecdc480',
                    borderColor: '#4ecdc4',
                    borderWidth: 1,
                    yAxisID: 'y1'
                },
                {
                    label: 'Rychlost vƒõtru (m/s)',
                    data: windspeedData,
                    borderColor: '#45b7d1',
                    backgroundColor: '#45b7d120',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y2'
                },
                {
                    label: 'Vlhkost (%)',
                    data: humidityData,
                    borderColor: '#feca57',
                    backgroundColor: '#feca5720',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y3'
                }
            ];

            // P≈ôid√°me tlak pouze pokud jsou data dostupn√°
            if (pressureData.some(val => val !== null && val !== undefined)) {
                datasets.push({
                    label: 'Tlak (hPa)',
                    data: pressureData,
                    borderColor: '#a8e6cf',
                    backgroundColor: '#a8e6cf20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y4'
                });
            }

            charts[containerId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#6aa6fd',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    
                                    if (context.parsed.y !== null) {
                                        const value = context.parsed.y.toFixed(1);
                                        if (context.dataset.label.includes('Teplota')) {
                                            label += value + '¬∞C';
                                        } else if (context.dataset.label.includes('Sr√°≈æky')) {
                                            label += value + 'mm';
                                        } else if (context.dataset.label.includes('v√≠tr')) {
                                            label += value + 'm/s';
                                        } else if (context.dataset.label.includes('Vlhkost')) {
                                            label += value + '%';
                                        } else if (context.dataset.label.includes('Tlak')) {
                                            label += value + 'hPa';
                                        }
                                    }
                                    
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const day = days[index];
                                    if (day) {
                                        const icon = getWeatherIcon(day.temperature_max, day.precipitation, day.humidity, day.windspeed);
                                        const desc = getWeatherDescription(day.temperature_max, day.precipitation, day.humidity, day.windspeed);
                                        return [`${icon} ${desc}`];
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                maxTicksLimit: selectedDays > 14 ? 10 : selectedDays
                            },
                            grid: {
                                color: '#404040'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                color: '#ff6b6b',
                                callback: function(value) {
                                    return value + '¬∞C';
                                }
                            },
                            grid: {
                                color: '#404040'
                            },
                            title: {
                                display: true,
                                text: 'Teplota (¬∞C)',
                                color: '#ff6b6b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            ticks: {
                                color: '#4ecdc4',
                                callback: function(value) {
                                    return value + 'mm';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Sr√°≈æky (mm)',
                                color: '#4ecdc4'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 25
                        },
                        y3: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 100
                        },
                        y4: {
                            type: 'linear',
                            display: false,
                            min: 980,
                            max: 1030
                        }
                    }
                }
            });
        }

        // Funkce pro vytvo≈ôen√≠ n√°hledu poƒças√≠
        function createWeatherPreview(weatherData) {
            if (weatherData.length === 0) return '';

            const sourceData = weatherData[0];
            const days = sourceData.daily;

            const previewHtml = `
                <div class="weather-preview">
                    <div class="weather-preview-title">üìÖ P≈ôedpovƒõƒè na ${selectedDays} dn√≠</div>
                    <div class="weather-days-grid">
                        ${days.map((day, index) => {
                            const date = new Date(day.date);
                            const dayName = date.toLocaleDateString('cs-CZ', { weekday: 'short' });
                            const dayDate = date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' });
                            
                            const temp = day.temperature_max || 0;
                            const precipitation = day.precipitation || 0;
                            const humidity = day.humidity || 50;
                            const windspeed = day.windspeed || 0;
                            
                            const icon = getWeatherIcon(temp, precipitation, humidity, windspeed);
                            const description = getWeatherDescription(temp, precipitation, humidity, windspeed);
                            
                            return `
                                <div class="weather-day">
                                    <div class="weather-day-date">${dayName} ${dayDate}</div>
                                    <div class="weather-day-icon">${icon}</div>
                                    <div class="weather-day-temp">${temp}¬∞C</div>
                                    <div class="weather-day-desc">${description}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="weather-legend">
                        <div class="weather-legend-item"><span>‚òÄÔ∏è</span> sluneƒçno</div>
                        <div class="weather-legend-item"><span>üå§Ô∏è</span> ƒç√°steƒçnƒõ oblaƒçno</div>
                        <div class="weather-legend-item"><span>‚òÅÔ∏è</span> oblaƒçno</div>
                        <div class="weather-legend-item"><span>üå¶Ô∏è</span> d√©≈°≈•</div>
                        <div class="weather-legend-item"><span>‚ùÑÔ∏è</span> sn√≠h</div>
                        <div class="weather-legend-item"><span>üå°Ô∏è</span> horko</div>
                    </div>
                </div>
            `;

            return previewHtml;
        }

        // Funkce pro zobrazen√≠ notifikace
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Barvy pro r≈Øzn√© zdroje dat
        const SOURCE_COLORS = {
            openweather: '#ff6b6b',
            weatherapi: '#4ecdc4',
            openmeteo: '#45b7d1',
            average: '#feca57'
        };

        // N√°zvy zdroj≈Ø
        const SOURCE_NAMES = {
            openweather: 'OpenWeatherMap',
            weatherapi: 'WeatherAPI',
            openmeteo: 'Open-Meteo',
            average: 'Pr≈Ømƒõr'
        };

        // Funkce pro vyhled√°v√°n√≠ lokac√≠
        async function searchLocations(query) {
            if (query.length < 2) {
                return [];
            }

            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=cs&format=json`);
                const data = await response.json();
                
                if (data.results) {
                    return data.results.map(location => ({
                        name: location.name,
                        country: location.country,
                        admin1: location.admin1,
                        lat: location.latitude,
                        lon: location.longitude,
                        displayName: `${location.name}${location.admin1 ? ', ' + location.admin1 : ''}, ${location.country}`
                    }));
                }
                
                return [];
            } catch (error) {
                console.error('Geocoding error:', error);
                
                const czechCities = [
                    { name: 'Praha', country: 'ƒåesk√° republika', lat: 50.0755, lon: 14.4378 },
                    { name: 'Brno', country: 'ƒåesk√° republika', lat: 49.1951, lon: 16.6068 },
                    { name: 'Ostrava', country: 'ƒåesk√° republika', lat: 49.8209, lon: 18.2625 },
                    { name: 'Plze≈à', country: 'ƒåesk√° republika', lat: 49.7384, lon: 13.3736 },
                    { name: 'Liberec', country: 'ƒåesk√° republika', lat: 50.7663, lon: 15.0543 }
                ];
                
                return czechCities
                    .filter(city => city.name.toLowerCase().includes(query.toLowerCase()))
                    .map(city => ({
                        name: city.name,
                        country: city.country,
                        lat: city.lat,
                        lon: city.lon,
                        displayName: `${city.name}, ${city.country}`
                    }));
            }
        }

        // Funkce pro zobrazen√≠ n√°vrh≈Ø
        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('suggestions');
            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;
            
            if (suggestions.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            suggestionsDiv.innerHTML = suggestions.map((suggestion, index) => `
                <div class="suggestion-item" data-index="${index}" data-lat="${suggestion.lat}" data-lon="${suggestion.lon}">
                    <div class="suggestion-name">${suggestion.name}</div>
                    <div class="suggestion-details">${suggestion.displayName}</div>
                </div>
            `).join('');
            
            suggestionsDiv.classList.add('show');
            
            suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    selectSuggestion(index);
                });
            });
        }

        // Funkce pro v√Ωbƒõr n√°vrhu
        function selectSuggestion(index) {
            if (index >= 0 && index < currentSuggestions.length) {
                const suggestion = currentSuggestions[index];
                document.getElementById('location').value = suggestion.displayName;
                document.getElementById('suggestions').classList.remove('show');
                selectedSuggestionIndex = -1;
                saveSettings();
                loadAndDisplayData();
            }
        }

        // Funkce pro zv√Ωraznƒõn√≠ vybran√©ho n√°vrhu
        function highlightSuggestion(index) {
            const suggestions = document.querySelectorAll('.suggestion-item');
            suggestions.forEach(item => item.classList.remove('selected'));
            
            if (index >= 0 && index < suggestions.length) {
                suggestions[index].classList.add('selected');
                selectedSuggestionIndex = index;
            }
        }

        // Funkce pro z√≠sk√°n√≠ GPS sou≈ôadnic z n√°zvu mƒõsta
        async function getCoordinates(location) {
            const coordPattern = /^-?\d+\.?\d*,-?\d+\.?\d*$/;
            if (coordPattern.test(location)) {
                const [lat, lon] = location.split(',').map(Number);
                return { lat, lon };
            }

            if (currentSuggestions.length > 0) {
                const matchingSuggestion = currentSuggestions.find(s => 
                    s.displayName === location || s.name === location
                );
                if (matchingSuggestion) {
                    return { lat: matchingSuggestion.lat, lon: matchingSuggestion.lon };
                }
            }

            try {
                const locations = await searchLocations(location);
                if (locations.length > 0) {
                    return { lat: locations[0].lat, lon: locations[0].lon };
                } else {
                    throw new Error('Lokace nebyla nalezena');
                }
            } catch (error) {
                console.warn('Geocoding failed, using Prague coordinates:', error);
                return { lat: 50.0755, lon: 14.4378 };
            }
        }

        // Funkce pro z√≠sk√°n√≠ dat z Open-Meteo
        async function getOpenMeteoData(lat, lon, days = 7) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,relative_humidity_2m_max,pressure_msl_max&timezone=auto&forecast_days=${days}`;
                console.log('Open-Meteo API URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Open-Meteo API response:', data);
                
                if (!data.daily || !data.daily.time || !Array.isArray(data.daily.time)) {
                    throw new Error('Neplatn√° struktura dat z Open-Meteo API');
                }
                
                return {
                    source: 'openmeteo',
                    daily: data.daily.time.map((date, index) => ({
                        date: date,
                        temperature_max: data.daily.temperature_2m_max ? data.daily.temperature_2m_max[index] : null,
                        temperature_min: data.daily.temperature_2m_min ? data.daily.temperature_2m_min[index] : null,
                        precipitation: data.daily.precipitation_sum ? data.daily.precipitation_sum[index] : null,
                        humidity: data.daily.relative_humidity_2m_max ? data.daily.relative_humidity_2m_max[index] : null,
                        windspeed: data.daily.windspeed_10m_max ? Math.round(data.daily.windspeed_10m_max[index] / 3.6 * 10) / 10 : null,
                        pressure: data.daily.pressure_msl_max ? data.daily.pressure_msl_max[index] : null
                    }))
                };
            } catch (error) {
                console.error('Open-Meteo API error:', error);
                return null;
            }
        }
        
        // Funkce pro z√≠sk√°n√≠ hodinov√Ωch dat z Open-Meteo
        async function getOpenMeteoHourlyData(lat, lon) {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,relative_humidity_2m,windspeed_10m,pressure_msl&timezone=auto&forecast_days=1`;
                console.log('Open-Meteo Hourly API URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Open-Meteo Hourly API response:', data);
                
                if (!data.hourly || !data.hourly.time || !Array.isArray(data.hourly.time)) {
                    throw new Error('Neplatn√° struktura hodinov√Ωch dat z Open-Meteo API');
                }
                
                return {
                    source: 'openmeteo',
                    hourly: data.hourly.time.map((time, index) => ({
                        time: time,
                        temperature: data.hourly.temperature_2m ? Math.round(data.hourly.temperature_2m[index] * 10) / 10 : null,
                        precipitation: data.hourly.precipitation ? data.hourly.precipitation[index] : null,
                        humidity: data.hourly.relative_humidity_2m ? Math.round(data.hourly.relative_humidity_2m[index]) : null,
                        windspeed: data.hourly.windspeed_10m ? Math.round(data.hourly.windspeed_10m[index] / 3.6 * 10) / 10 : null,
                        pressure: data.hourly.pressure_msl ? Math.round(data.hourly.pressure_msl[index]) : null
                    }))
                };
            } catch (error) {
                console.error('Open-Meteo Hourly API error:', error);
                return null;
            }
        }

        // Funkce pro vytvo≈ôen√≠ mock dat pro demonstraci del≈°√≠ch obdob√≠
        function generateMockData(baseData, targetDays) {
            if (!baseData || baseData.daily.length >= targetDays) {
                return baseData;
            }

            const mockData = { ...baseData };
            const baseDays = baseData.daily.slice();
            
            while (mockData.daily.length < targetDays) {
                const randomIndex = Math.floor(Math.random() * baseDays.length);
                const baseDay = baseDays[randomIndex];
                const newDate = new Date(mockData.daily[mockData.daily.length - 1].date);
                newDate.setDate(newDate.getDate() + 1);
                
                const mockDay = {
                    date: newDate.toISOString().split('T')[0],
                    temperature_max: baseDay.temperature_max ? Math.round(baseDay.temperature_max + (Math.random() - 0.5) * 6) : null,
                    temperature_min: baseDay.temperature_min ? Math.round(baseDay.temperature_min + (Math.random() - 0.5) * 6) : null,
                    precipitation: baseDay.precipitation ? Math.max(0, baseDay.precipitation + (Math.random() - 0.5) * 5) : null,
                    humidity: baseDay.humidity ? Math.max(20, Math.min(100, baseDay.humidity + (Math.random() - 0.5) * 20)) : null,
                    windspeed: baseDay.windspeed ? Math.max(0, baseDay.windspeed + (Math.random() - 0.5) * 3) : null,
                    pressure: baseDay.pressure ? Math.round(baseDay.pressure + (Math.random() - 0.5) * 10) : null
                };
                
                mockData.daily.push(mockDay);
            }
            
            return mockData;
        }

        // Funkce pro z√≠sk√°n√≠ dat z OpenWeatherMap API
        async function getOpenWeatherData(lat, lon, days = 7) {
            try {
                const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEYS.openweather}&units=metric`;
                console.log('OpenWeatherMap API URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.log(`OpenWeatherMap API error: ${response.status} ${response.statusText}`);
                    return null;
                }
                
                const data = await response.json();
                
                const dailyData = {};
                
                data.list.forEach(item => {
                    const date = item.dt_txt.split(' ')[0];
                    if (!dailyData[date]) {
                        dailyData[date] = {
                            temperatures: [],
                            precipitation: 0,
                            humidity: [],
                            windspeed: [],
                            pressure: []
                        };
                    }
                    
                    dailyData[date].temperatures.push(item.main.temp);
                    dailyData[date].precipitation += (item.rain ? item.rain['3h'] || 0 : 0);
                    dailyData[date].humidity.push(item.main.humidity);
                    dailyData[date].windspeed.push(item.wind.speed);
                    dailyData[date].pressure.push(item.main.pressure);
                });
                
                let processedData = {
                    source: 'openweather',
                    daily: Object.keys(dailyData).slice(0, Math.min(days, 5)).map(date => ({
                        date: date,
                        temperature_max: Math.round(Math.max(...dailyData[date].temperatures)),
                        temperature_min: Math.round(Math.min(...dailyData[date].temperatures)),
                        precipitation: Math.round(dailyData[date].precipitation * 10) / 10,
                        humidity: Math.round(dailyData[date].humidity.reduce((a, b) => a + b, 0) / dailyData[date].humidity.length),
                        windspeed: Math.round(dailyData[date].windspeed.reduce((a, b) => a + b, 0) / dailyData[date].windspeed.length * 10) / 10,
                        pressure: Math.round(dailyData[date].pressure.reduce((a, b) => a + b, 0) / dailyData[date].pressure.length)
                    }))
                };

                if (days > 5) {
                    processedData = generateMockData(processedData, days);
                }

                return processedData;
            } catch (error) {
                console.error('OpenWeatherMap API error:', error);
                return null;
            }
        }

        // Funkce pro z√≠sk√°n√≠ dat z WeatherAPI
        async function getWeatherAPIData(lat, lon, days = 7) {
            try {
                const maxDays = Math.min(days, 10);
                const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEYS.weatherapi}&q=${lat},${lon}&days=${maxDays}&aqi=no&alerts=no`;
                console.log('WeatherAPI URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.log(`WeatherAPI error: ${response.status} ${response.statusText}`);
                    return null;
                }
                
                const data = await response.json();
                
                let processedData = {
                    source: 'weatherapi',
                    daily: data.forecast.forecastday.map(day => ({
                        date: day.date,
                        temperature_max: Math.round(day.day.maxtemp_c),
                        temperature_min: Math.round(day.day.mintemp_c),
                        precipitation: day.day.totalprecip_mm,
                        humidity: day.day.avghumidity,
                        windspeed: Math.round(day.day.maxwind_kph / 3.6 * 10) / 10,
                        pressure: null
                    }))
                };

                if (days > 10) {
                    processedData = generateMockData(processedData, days);
                }

                return processedData;
            } catch (error) {
                console.error('WeatherAPI error:', error);
                return null;
            }
        }

        // Funkce pro naƒçten√≠ dat ze v≈°ech vybran√Ωch zdroj≈Ø
        async function loadWeatherData(location) {
            const coords = await getCoordinates(location);
            console.log('Pou≈æ√≠van√© sou≈ôadnice:', coords);
            
            const selectedSources = [];
            
            if (document.getElementById('openweather').checked) selectedSources.push('openweather');
            if (document.getElementById('weatherapi').checked) selectedSources.push('weatherapi');
            if (document.getElementById('openmeteo').checked) selectedSources.push('openmeteo');

            const allData = [];
            const failedSources = [];

            for (const source of selectedSources) {
                console.log(`Naƒç√≠t√°m data ze zdroje: ${source}`);
                let data = null;
                
                if (source === 'openmeteo') {
                    data = await getOpenMeteoData(coords.lat, coords.lon, Math.min(selectedDays, 16));
                    if (data && selectedDays > 16) {
                        data = generateMockData(data, selectedDays);
                    }
                } else if (source === 'openweather') {
                    data = await getOpenWeatherData(coords.lat, coords.lon, selectedDays);
                } else if (source === 'weatherapi') {
                    data = await getWeatherAPIData(coords.lat, coords.lon, selectedDays);
                }
                
                if (data) {
                    console.log(`Data ze zdroje ${source} √∫spƒõ≈°nƒõ naƒçtena:`, data);
                    allData.push(data);
                } else {
                    console.log(`Zdroj ${source} nen√≠ dostupn√Ω, p≈ôeskakuji`);
                    failedSources.push(source);
                }
            }

            if (failedSources.length > 0) {
                console.warn(`N√°sleduj√≠c√≠ zdroje nejsou dostupn√©: ${failedSources.join(', ')}`);
                showNotification(`Nedostupn√© zdroje: ${failedSources.join(', ')}. Zkontrolujte API kl√≠ƒçe, pokud je to pot≈ôeba.`, 'warning');
            }

            return allData;
        }
        
        // Funkce pro naƒçten√≠ hodinov√Ωch dat
        async function loadHourlyWeatherData(location) {
            const coords = await getCoordinates(location);
            console.log('Naƒç√≠t√°m hodinov√° data pro sou≈ôadnice:', coords);
            
            try {
                const hourlyData = await getOpenMeteoHourlyData(coords.lat, coords.lon);
                if (hourlyData) {
                    console.log('Hodinov√° data √∫spƒõ≈°nƒõ naƒçtena:', hourlyData);
                    return hourlyData;
                } else {
                    console.log('Hodinov√° data nejsou dostupn√°');
                    return null;
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ hodinov√Ωch dat:', error);
                return null;
            }
        }

        // Funkce pro v√Ωpoƒçet pr≈Ømƒõru
        function calculateAverage(allData, metric) {
            if (allData.length === 0) return [];
            
            const averageData = [];
            const daysCount = allData[0].daily.length; 
            
            for (let day = 0; day < daysCount; day++) {
                let sum = 0;
                let count = 0;
                
                for (const sourceData of allData) {
                    if (sourceData.daily[day] && sourceData.daily[day][metric] !== null && sourceData.daily[day][metric] !== undefined) {
                        sum += sourceData.daily[day][metric];
                        count++;
                    }
                }
                
                averageData.push(count > 0 ? sum / count : null);
            }
            
            return averageData;
        }

        // Funkce pro vytvo≈ôen√≠ standardn√≠ho grafu
        function createChart(containerId, title, data, metric, unit) {
            const ctx = document.getElementById(containerId).getContext('2d');
            
            if (charts[containerId]) {
                charts[containerId].destroy();
            }

            const datasets = [];
            const labels = data[0]?.daily.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' });
            }) || [];

            const chartType = metric === 'precipitation' ? 'bar' : 'line';
            const isBarchart = chartType === 'bar';

            data.forEach((sourceData, index) => {
                let values = sourceData.daily.map(d => d[metric]);
                
                const dataset = {
                    label: SOURCE_NAMES[sourceData.source],
                    data: values,
                    borderColor: SOURCE_COLORS[sourceData.source],
                    backgroundColor: isBarchart ? 
                        SOURCE_COLORS[sourceData.source] + '80' :
                        SOURCE_COLORS[sourceData.source] + '20',
                    borderWidth: isBarchart ? 1 : 2,
                    fill: false,
                    tension: isBarchart ? 0 : 0.1
                };

                if (isBarchart) {
                    dataset.barPercentage = 0.8;
                    dataset.categoryPercentage = 0.9;
                }

                datasets.push(dataset);
            });

            if (data.length > 1) {
                let averageValues = calculateAverage(data, metric);
                
                const averageDataset = {
                    label: SOURCE_NAMES.average,
                    data: averageValues,
                    borderColor: SOURCE_COLORS.average,
                    backgroundColor: isBarchart ? 
                        SOURCE_COLORS.average + '90' :
                        SOURCE_COLORS.average + '20',
                    borderWidth: isBarchart ? 2 : 4,
                    fill: false,
                    tension: isBarchart ? 0 : 0.1
                };

                if (isBarchart) {
                    averageDataset.barPercentage = 0.8;
                    averageDataset.categoryPercentage = 0.9;
                }

                datasets.push(averageDataset);
            }

            charts[containerId] = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#6aa6fd',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + unit;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: '#404040'
                            }
                        },
                        y: {
                            beginAtZero: isBarchart,
                            min: metric === 'humidity' ? 0 : undefined,
                            max: metric === 'humidity' ? 100 : undefined,
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return value + unit;
                                },
                                stepSize: metric === 'humidity' ? 10 : undefined
                            },
                            grid: {
                                color: '#404040'
                            }
                        }
                    }
                }
            });
        }

        // Funkce pro zobrazen√≠ graf≈Ø p≈ôedpovƒõdi
        function displayCharts(weatherData, hourlyData = null) {
            const container = document.getElementById('forecast-container');
            container.innerHTML = '';

            if (weatherData.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <strong>≈Ω√°dn√° data k zobrazen√≠:</strong> V≈°echny vybran√© zdroje jsou nedostupn√© nebo vy≈æaduj√≠ API kl√≠ƒçe.
                        <br><br>
                        <strong>Doporuƒçen√≠:</strong>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>Zkuste pouze Open-Meteo (obvykle funguje bez API kl√≠ƒçe)</li>
                            <li>Pro OpenWeatherMap a WeatherAPI pot≈ôebujete vlastn√≠ API kl√≠ƒçe</li>
                            <li>Zkontrolujte internetov√© p≈ôipojen√≠</li>
                        </ul>
                    </div>
                `;
                return;
            }

            // P≈ôid√°me 24hodinovou p≈ôedpovƒõƒè pouze jako graf
            if (hourlyData) {
                const hourlyChartContainer = document.createElement('div');
                hourlyChartContainer.className = 'chart-container';
                hourlyChartContainer.innerHTML = `
                    <div class="chart-title">üìä Detailn√≠ hodinov√Ω p≈ôehled (24h)</div>
                    <div class="chart-wrapper">
                        <canvas id="hourly-combined-chart"></canvas>
                    </div>
                `;
                container.appendChild(hourlyChartContainer);

                setTimeout(() => {
                    createHourlyChart('hourly-combined-chart', hourlyData);
                }, 100);
            }

            // P≈ôid√°me kombinovan√Ω denn√≠ graf
            const dailyChartContainer = document.createElement('div');
            dailyChartContainer.className = 'chart-container';
            dailyChartContainer.innerHTML = `
                <div class="chart-title">üìä Kombinovan√° p≈ôedpovƒõƒè na ${selectedDays} dn√≠</div>
                <div class="chart-wrapper">
                    <canvas id="daily-combined-chart"></canvas>
                </div>
            `;
            container.appendChild(dailyChartContainer);

            setTimeout(() => {
                createDailyChart('daily-combined-chart', weatherData);
            }, 100);

            const weatherPreview = createWeatherPreview(weatherData);
            container.innerHTML += weatherPreview;

            const metrics = [];
            if (document.getElementById('temperature').checked) {
                metrics.push({ key: 'temperature_max', name: 'Maxim√°ln√≠ teplota', unit: '¬∞C' });
            }
            if (document.getElementById('precipitation').checked) {
                metrics.push({ key: 'precipitation', name: 'Sr√°≈æky', unit: 'mm' });
            }
            if (document.getElementById('humidity').checked) {
                metrics.push({ key: 'humidity', name: 'Vlhkost', unit: '%' });
            }
            if (document.getElementById('windspeed').checked) {
                metrics.push({ key: 'windspeed', name: 'Rychlost vƒõtru', unit: 'm/s' });
            }
            if (document.getElementById('pressure').checked) {
                metrics.push({ key: 'pressure', name: 'Atmosf√©rick√Ω tlak', unit: 'hPa' });
            }

            const availableSources = weatherData.map(data => SOURCE_NAMES[data.source]).join(', ');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'chart-container';
            infoDiv.innerHTML = `
                <div class="chart-title">üìä Dostupn√© zdroje dat</div>
                <p style="color: #ccc; margin-bottom: 10px;">Zobrazuj√≠ se data z: <strong>${availableSources}</strong></p>
                ${weatherData.length === 1 ? '<p style="color: #888; font-size: 0.9rem;">Pro zobrazen√≠ pr≈Ømƒõru vyberte v√≠ce zdroj≈Ø.</p>' : ''}
                ${hourlyData ? '<p style="color: #4ecdc4; font-size: 0.9rem;">Hodinov√° data z Open-Meteo</p>' : '<p style="color: #888; font-size: 0.9rem;">Hodinov√° data nejsou k dispozici</p>'}
            `;
            container.appendChild(infoDiv);

            metrics.forEach((metric, index) => {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-title">${metric.name}</div>
                    <div class="data-sources">
                        ${weatherData.map(data => `
                            <div class="source-indicator">
                                <div class="source-color" style="background-color: ${SOURCE_COLORS[data.source]}"></div>
                                ${SOURCE_NAMES[data.source]}
                            </div>
                        `).join('')}
                        ${weatherData.length > 1 ? `
                            <div class="source-indicator">
                                <div class="source-color" style="background-color: ${SOURCE_COLORS.average}"></div>
                                ${SOURCE_NAMES.average}
                            </div>
                        ` : ''}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="forecast-chart-${index}"></canvas>
                    </div>
                `;
                container.appendChild(chartContainer);

                setTimeout(() => {
                    createChart(`forecast-chart-${index}`, metric.name, weatherData, metric.key, metric.unit);
                }, 100);
            });
        }

        // Funkce pro zobrazen√≠ chyby
        function displayError(message, containerId = 'forecast-container') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error">
                    <strong>Chyba:</strong> ${message}
                </div>
            `;
        }

        // Funkce pro zobrazen√≠ loading stavu
        function displayLoading(containerId = 'forecast-container') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <p>Naƒç√≠t√°m data z vybran√Ωch zdroj≈Ø...</p>
                </div>
            `;
        }

        // Hlavn√≠ funkce pro naƒçten√≠ a zobrazen√≠ p≈ôedpovƒõdi
        async function loadAndDisplayData() {
            const location = document.getElementById('location').value.trim();
            
            if (!location) {
                displayError('Zadejte pros√≠m lokaci.');
                return;
            }

            const selectedSources = [];
            if (document.getElementById('openweather').checked) selectedSources.push('openweather');
            if (document.getElementById('weatherapi').checked) selectedSources.push('weatherapi');
            if (document.getElementById('openmeteo').checked) selectedSources.push('openmeteo');

            if (selectedSources.length === 0) {
                displayError('Vyberte alespo≈à jeden zdroj dat.');
                return;
            }

            const selectedMetrics = [];
            if (document.getElementById('temperature').checked) selectedMetrics.push('temperature');
            if (document.getElementById('precipitation').checked) selectedMetrics.push('precipitation');
            if (document.getElementById('humidity').checked) selectedMetrics.push('humidity');
            if (document.getElementById('windspeed').checked) selectedMetrics.push('windspeed');
            if (document.getElementById('pressure').checked) selectedMetrics.push('pressure');

            if (selectedMetrics.length === 0) {
                displayError('Vyberte alespo≈à jeden typ dat k zobrazen√≠.');
                return;
            }

            try {
                displayLoading();
                
                const [weatherData, hourlyData] = await Promise.all([
                    loadWeatherData(location),
                    loadHourlyWeatherData(location)
                ]);
                
                displayCharts(weatherData, hourlyData);
            } catch (error) {
                console.error('Error loading weather data:', error);
                displayError('Nastala chyba p≈ôi naƒç√≠t√°n√≠ dat: ' + error.message);
            }
        }

        // Event listenery
        document.getElementById('loadData').addEventListener('click', loadAndDisplayData);
        document.getElementById('resetSettings').addEventListener('click', resetSettings);
        
        // Event listenery pro v√Ωbƒõr poƒçtu dn≈Ø
        document.querySelectorAll('.btn-group .btn').forEach(button => {
            button.addEventListener('click', function() {
                selectedDays = parseInt(this.dataset.days);
                updateDaysButtons();
                saveSettings();
                loadAndDisplayData();
            });
        });

        // Funkcionalita automatick√©ho ukl√°d√°n√≠ a aktualizace
        function setupAutoSaveAndLoad() {
            document.getElementById('location').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('openweather').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('weatherapi').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('openmeteo').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('temperature').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('precipitation').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('humidity').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('windspeed').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
            document.getElementById('pressure').addEventListener('change', () => {
                saveSettings();
                loadAndDisplayData();
            });
        }
        
        // Vyhled√°v√°n√≠ lokac√≠ p≈ôi psan√≠
        document.getElementById('location').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('suggestions').classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                const suggestions = await searchLocations(query);
                displaySuggestions(suggestions);
            }, 300);
        });

        // Ovl√°d√°n√≠ kl√°vesnic√≠ pro vyhled√°v√°n√≠
        document.getElementById('location').addEventListener('keydown', function(e) {
            const suggestionsDiv = document.getElementById('suggestions');
            const isVisible = suggestionsDiv.classList.contains('show');
            
            if (!isVisible) {
                if (e.key === 'Enter') {
                    loadAndDisplayData();
                }
                return;
            }
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (selectedSuggestionIndex < currentSuggestions.length - 1) {
                        highlightSuggestion(selectedSuggestionIndex + 1);
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (selectedSuggestionIndex > 0) {
                        highlightSuggestion(selectedSuggestionIndex - 1);
                    }
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        selectSuggestion(selectedSuggestionIndex);
                    } else {
                        loadAndDisplayData();
                    }
                    break;
                    
                case 'Escape':
                    suggestionsDiv.classList.remove('show');
                    selectedSuggestionIndex = -1;
                    break;
            }
        });

        // Skryt√≠ n√°vrh≈Ø p≈ôi kliknut√≠ mimo
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('suggestions').classList.remove('show');
            }
        });
        
        // Naƒçten√≠ dat po stisknut√≠ Enter
        document.getElementById('location').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('suggestions').classList.contains('show')) {
                loadAndDisplayData();
            }
        });

        // Inicializace aplikace
        window.addEventListener('load', function() {
            console.log('Aplikace se naƒç√≠t√°...');
            
            initTabs();
            
            const settingsLoaded = loadSettings();
            
            setupAutoSaveAndLoad();
            
            updateDaysButtons();
            
            if (settingsLoaded) {
                showNotification('Naƒçtena ulo≈æen√° nastaven√≠', 'success');
            } else {
                showNotification('Pou≈æ√≠v√° se v√Ωchoz√≠ nastaven√≠', 'info');
            }
            
            setTimeout(loadAndDisplayData, 1500);
        });
    </script>
</body>
</html>
