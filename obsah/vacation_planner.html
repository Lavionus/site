<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planovac dovolene</title>
  <style>
    :root {
      --editor-font-size: 0.8rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 1.6rem;
      font-weight: 600;
      margin: 0;
      margin-bottom: 5px;
      color: #e0e0e0;
    }

    .header-subtitle {
      font-size: 0.85rem;
      color: #888;
    }

    .controls-section {
      background-color: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .date-range-form {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-btn {
      background-color: #6aa6fd;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      height: fit-content;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn:hover {
      background-color: #5694f0;
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn.secondary {
      background-color: #505050;
    }

    .action-btn.secondary:hover {
      background-color: #606060;
    }

    .action-btn.print {
      background-color: #4caf50;
    }

    .action-btn.print:hover {
      background-color: #45a049;
    }

    .action-btn.export {
      background-color: #ff9800;
    }

    .action-btn.export:hover {
      background-color: #f57c00;
    }

    .btn-icon {
      font-size: 1rem;
    }

    /* Calendar picker styles */
    .calendar-picker-container {
      position: relative;
    }

    .calendar-display {
      background-color: #404040;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 10px 14px;
      color: #e0e0e0;
      font-size: 0.95rem;
      cursor: pointer;
      min-width: 320px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .calendar-display:hover {
      border-color: #6aa6fd;
      background-color: #4a4a4a;
    }

    .calendar-display-icon {
      font-size: 1.1rem;
    }

    .calendar-display-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .calendar-display-range {
      font-weight: 500;
    }

    .calendar-display-stats {
      font-size: 0.75rem;
      color: #888;
    }

    .calendar-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 5px;
      background-color: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 15px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .calendar-dropdown.show {
      display: block;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-nav {
      background: none;
      border: none;
      color: #6aa6fd;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .calendar-nav:hover {
      background-color: #404040;
    }

    .calendar-month-year {
      font-weight: 600;
      color: #e0e0e0;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: 5px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 0.75rem;
      color: #888;
      padding: 5px;
    }

    .calendar-weekday.weekend {
      color: #ff8a80;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .calendar-day {
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #e0e0e0;
      background-color: transparent;
      border: none;
      transition: all 0.15s ease;
    }

    .calendar-day:hover {
      background-color: #404040;
    }

    .calendar-day.other-month {
      color: #555;
    }

    .calendar-day.weekend:not(.other-month) {
      color: #ff8a80;
    }

    .calendar-day.selected-start,
    .calendar-day.selected-end {
      background-color: #6aa6fd;
      color: white;
      font-weight: 600;
    }

    .calendar-day.in-range {
      background-color: rgba(106, 166, 253, 0.3);
    }

    .calendar-day.today {
      border: 2px solid #6aa6fd;
      font-weight: 600;
    }

    .calendar-hint {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #888;
      text-align: center;
    }

    .timeline-section {
      background-color: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 20px 10px;
      overflow-x: auto;
    }

    .timeline-wrapper {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-width: fit-content;
      padding: 10px 0;
    }

    /* Kontejner pro dny nad osou */
    .days-container {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      width: 100%;
    }

    .day-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 100px;
      position: relative;
    }

    .day-card {
      background-color: #353535;
      border: 1px solid #505050;
      border-radius: 6px;
      padding: 6px;
      width: calc(100% - 4px);
      min-height: 300px;
      margin-bottom: 6px;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
    }

    .day-card:hover {
      border-color: #6aa6fd;
      box-shadow: 0 2px 8px rgba(106, 166, 253, 0.15);
    }

    .day-card.weekend {
      background-color: #3a3535;
      border-color: #5a4545;
    }

    .day-card.weekend:hover {
      border-color: #ff8a80;
      box-shadow: 0 2px 8px rgba(255, 138, 128, 0.15);
    }

    .day-card-header {
      font-size: 0.8rem;
      color: #6aa6fd;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: center;
      border-bottom: 1px solid #505050;
      padding-bottom: 4px;
    }

    .day-card.weekend .day-card-header {
      color: #ff8a80;
      border-bottom-color: #5a4545;
    }

    .day-card textarea {
      width: 100%;
      flex: 1;
      min-height: 216px;
      background-color: #404040;
      border: 1px solid #555;
      border-radius: 3px;
      color: #e0e0e0;
      font-size: var(--editor-font-size);
      padding: 4px;
      resize: none;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .day-card textarea:focus {
      outline: none;
      border-color: #6aa6fd;
    }

    .day-card.weekend textarea:focus {
      border-color: #ff8a80;
    }

    /* Svisl√° ƒç√°ra od karty k ƒçasov√© ose */
    .day-line {
      width: 2px;
      height: 20px;
      background-color: #6aa6fd;
    }

    .day-column.weekend .day-line {
      background-color: #ff8a80;
    }

    /* ƒåasov√° osa */
    .day-points-container {
      display: flex;
      position: relative;
      width: 100%;
    }

    .day-point-wrapper {
      flex: 1;
      min-width: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .day-point {
      width: 14px;
      height: 14px;
      background-color: #6aa6fd;
      border: 2px solid #2a2a2a;
      border-radius: 50%;
      z-index: 2;
      transition: transform 0.2s ease;
    }

    .day-point-wrapper:hover .day-point {
      transform: scale(1.3);
    }

    .day-point-wrapper.weekend .day-point {
      background-color: #ff8a80;
    }

    .day-point-label {
      position: absolute;
      top: 18px;
      font-size: 0.7rem;
      color: #888;
      white-space: nowrap;
    }

    /* Horizont√°ln√≠ ƒç√°ra osy pod body */
    .axis-background {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #505050, #6aa6fd, #505050);
      transform: translateY(-50%);
      border-radius: 2px;
      z-index: 1;
    }

    /* Kontejner pro noci pod osou */
    .nights-container {
      display: flex;
      gap: 0;
      margin-top: 20px;
      width: 100%;
      position: relative;
    }

    .night-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 100px;
    }

    .night-lines-container {
      display: flex;
      width: 100%;
      justify-content: space-around;
    }

    .night-line {
      width: 2px;
      height: 20px;
      background-color: #9c6afd;
    }

    .night-card {
      background-color: #2d2d3a;
      border: 1px solid #4a4a5a;
      border-radius: 6px;
      padding: 6px;
      width: calc(100% - 4px);
      min-height: 220px;
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .night-card:hover {
      border-color: #9c6afd;
      box-shadow: 0 2px 8px rgba(156, 106, 253, 0.15);
    }

    .night-card-header {
      font-size: 0.75rem;
      color: #9c6afd;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid #4a4a5a;
      padding-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .night-icon {
      font-size: 0.85rem;
    }

    .night-card .field-group {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .night-card .field-label {
      font-size: 0.65rem;
      color: #888;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .field-icon {
      font-size: 0.7rem;
    }

    .night-card input[type="text"] {
      width: 100%;
      background-color: #3a3a4a;
      border: 1px solid #5a5a6a;
      border-radius: 3px;
      color: #e0e0e0;
      font-size: var(--editor-font-size);
      padding: 4px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .night-card input[type="text"]:focus {
      outline: none;
      border-color: #9c6afd;
    }

    .night-card textarea {
      width: 100%;
      flex: 1;
      min-height: 120px;
      background-color: #3a3a4a;
      border: 1px solid #5a5a6a;
      border-radius: 3px;
      color: #e0e0e0;
      font-size: var(--editor-font-size);
      padding: 4px;
      resize: none;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .night-card textarea:focus {
      outline: none;
      border-color: #9c6afd;
    }

    /* Merge controls */
    .night-card-header-row {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #4a4a5a;
      padding-bottom: 4px;
      margin-bottom: 4px;
      position: relative;
    }

    .night-card-title {
      font-size: 0.75rem;
      color: #9c6afd;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Tlacitko rozdelit - absolutne pozicovane v rohu */
    .night-card-header-row .merge-btn.unmerge {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
    }

    /* Separator between nights with merge/split button */
    .night-separator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 80px;
      margin: 0 -8px;
      z-index: 10;
    }

    .merge-btn {
      background-color: #3a3a4a;
      border: 1px solid #5a5a6a;
      color: #9c6afd;
      font-size: 1rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }

    .merge-btn:hover {
      background-color: #4a4a5a;
      border-color: #9c6afd;
      transform: scale(1.1);
    }

    .merge-btn.unmerge {
      color: #ff8a80;
      border-color: #5a4545;
    }

    .merge-btn.unmerge:hover {
      background-color: #5a4545;
      border-color: #ff8a80;
    }

    /* Mensi tlacitko rozdelit uvnitr karty */
    .night-card-header-row .merge-btn.unmerge {
      width: 22px;
      height: 22px;
      padding: 0;
      font-size: 0.8rem;
    }

    .nights-count {
      font-size: 0.65rem;
      color: #9c6afd;
      background-color: #3a3a4a;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state p {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .empty-state span {
      font-size: 0.9rem;
      color: #555;
    }

    /* Scrollbar styling */
    .timeline-section::-webkit-scrollbar {
      height: 8px;
    }

    .timeline-section::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 4px;
    }

    .timeline-section::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    .timeline-section::-webkit-scrollbar-thumb:hover {
      background: #666;
    }

    .save-indicator {
      font-size: 0.8rem;
      color: #4caf50;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .save-indicator.show {
      opacity: 1;
    }

    /* Keyboard shortcut hints */
    .shortcut-hint {
      font-size: 0.65rem;
      color: #666;
      background-color: #333;
      padding: 2px 5px;
      border-radius: 3px;
      margin-left: 5px;
    }

    /* Hidden file input */
    .hidden-input {
      display: none;
    }

    /* Font size selector */
    .font-size-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .font-size-selector label {
      font-size: 0.85rem;
      color: #888;
    }

    .font-size-selector select {
      background-color: #404040;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px 12px;
      color: #e0e0e0;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .font-size-selector select:hover {
      border-color: #6aa6fd;
      background-color: #4a4a4a;
    }

    .font-size-selector select:focus {
      outline: none;
      border-color: #6aa6fd;
    }

    /* Print styles - svetle tema, optimalizovano pro landscape A4 */
    @media print {
      @page {
        size: landscape;
        margin: 10mm;
      }

      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      textarea, input {
        overflow: visible !important;
        resize: none !important;
      }

      textarea::-webkit-scrollbar {
        display: none !important;
      }

      body {
        background-color: white !important;
        color: #333 !important;
      }

      .container {
        max-width: 100%;
        padding: 5px;
      }

      .controls-section {
        display: none !important;
      }

      .header {
        margin-bottom: 10px;
      }

      .header h1 {
        color: #333 !important;
        font-size: 1.2rem;
        margin-bottom: 3px;
      }

      .header-subtitle {
        display: none;
      }

      .print-header {
        display: block !important;
        text-align: center;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #666 !important;
      }

      .timeline-section {
        background-color: white !important;
        border: 1px solid #ccc !important;
        padding: 8px;
        overflow: visible;
      }

      .timeline-wrapper {
        padding: 3px 0;
      }

      .day-card {
        background-color: #f8f8f8 !important;
        border: 1px solid #ccc !important;
        min-height: 300px !important;
      }

      .day-card.weekend {
        background-color: #fff5f5 !important;
        border-color: #e0a0a0 !important;
      }

      .day-card-header {
        color: #2563eb !important;
        border-bottom: 1px solid #ddd !important;
        font-size: 0.75rem;
        padding-bottom: 3px;
        margin-bottom: 3px;
      }

      .day-card.weekend .day-card-header {
        color: #dc2626 !important;
      }

      .day-card textarea {
        background-color: white !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
        min-height: 216px !important;
        overflow: visible !important;
        height: auto !important;
        font-size: var(--editor-font-size) !important;
      }

      .day-line {
        background-color: #2563eb !important;
        height: 15px !important;
      }

      .day-column.weekend .day-line {
        background-color: #dc2626 !important;
      }

      .day-point {
        background-color: #2563eb !important;
        border-color: white !important;
      }

      .day-point-wrapper.weekend .day-point {
        background-color: #dc2626 !important;
      }

      .day-point-label {
        color: #666 !important;
      }

      .axis-background {
        background: linear-gradient(90deg, #ccc, #2563eb, #ccc) !important;
      }

      .nights-container {
        margin-top: 12px !important;
        align-items: stretch !important;
      }

      .night-column {
        display: flex !important;
        flex-direction: column !important;
      }

      .night-lines-container {
        flex-shrink: 0 !important;
      }

      .night-card {
        background-color: #f5f5fa !important;
        border: 1px solid #bbb !important;
        min-height: 220px !important;
        flex: 1 !important;
      }

      .night-card-header {
        color: #7c3aed !important;
        border-bottom: 1px solid #ccc !important;
        font-size: 0.7rem;
      }

      .night-card-header-row {
        border-bottom: 1px solid #ccc !important;
      }

      .night-card-title {
        color: #7c3aed !important;
        font-size: 0.7rem;
      }

      .merge-btn {
        display: none !important;
      }

      .night-separator {
        display: none !important;
      }

      .nights-count {
        background-color: #e0e0e0 !important;
        color: #7c3aed !important;
      }

      .night-card .field-label {
        color: #666 !important;
        font-size: 0.6rem;
      }

      .night-card input[type="text"] {
        background-color: white !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
        font-size: var(--editor-font-size) !important;
      }

      .night-card textarea {
        background-color: white !important;
        border: 1px solid #ddd !important;
        color: #333 !important;
        min-height: 120px !important;
        overflow: visible !important;
        height: auto !important;
        font-size: var(--editor-font-size) !important;
      }

      .night-lines-container {
        display: flex !important;
        justify-content: space-around !important;
      }

      .night-line {
        background-color: #7c3aed !important;
        height: 15px !important;
      }
    }

    .print-header {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Planovac dovolene</h1>
      <div class="header-subtitle">Ctrl+P = tisk | Ctrl+S = ulozit | Ctrl+E = export</div>
      <div class="print-header" id="printHeader"></div>
    </div>

    <div class="controls-section">
      <div class="date-range-form">
        <div class="calendar-picker-container">
          <div class="calendar-display" id="calendarDisplay" onclick="toggleCalendar()">
            <span class="calendar-display-icon">üìÖ</span>
            <div class="calendar-display-info">
              <span class="calendar-display-range" id="dateRangeText">Vyberte rozsah dovolene</span>
              <span class="calendar-display-stats" id="dateStats"></span>
            </div>
          </div>
          <div class="calendar-dropdown" id="calendarDropdown">
            <div class="calendar-header">
              <button class="calendar-nav" onclick="changeMonth(-1)">‚óÄ</button>
              <span class="calendar-month-year" id="calendarMonthYear"></span>
              <button class="calendar-nav" onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="calendar-weekdays">
              <div class="calendar-weekday">Po</div>
              <div class="calendar-weekday">Ut</div>
              <div class="calendar-weekday">St</div>
              <div class="calendar-weekday">Ct</div>
              <div class="calendar-weekday">Pa</div>
              <div class="calendar-weekday weekend">So</div>
              <div class="calendar-weekday weekend">Ne</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
            <div class="calendar-hint">Kliknete pro vyber zacatku a konce dovolene</div>
          </div>
        </div>
        <div class="font-size-selector">
          <label for="fontSizeSelect">üìù Velikost pisma:</label>
          <select id="fontSizeSelect" onchange="setFontSize(this.value)">
            <option value="0.6rem">Maly (0.6)</option>
            <option value="0.7rem">Stredni (0.7)</option>
            <option value="0.8rem" selected>Normalni (0.8)</option>
            <option value="0.9rem">Vetsi (0.9)</option>
            <option value="1rem">Velky (1.0)</option>
          </select>
        </div>
        <button class="action-btn secondary" onclick="clearStorage()"><span class="btn-icon">üóë</span> Smazat data</button>
        <button class="action-btn export" onclick="exportData()"><span class="btn-icon">üì§</span> Export</button>
        <button class="action-btn secondary" onclick="document.getElementById('importInput').click()"><span class="btn-icon">üì•</span> Import</button>
        <input type="file" id="importInput" class="hidden-input" accept=".json" onchange="importData(event)">
        <button class="action-btn print" onclick="printPlan()"><span class="btn-icon">üñ®</span> Tisknout</button>
        <span class="save-indicator" id="saveIndicator"><span class="btn-icon">‚úì</span> Ulozeno</span>
      </div>
    </div>

    <div class="timeline-section">
      <div id="timelineContent">
        <div class="empty-state">
          <p>Zvolte rozsah dovolene pro zobrazeni casove osy</p>
          <span>Kliknete na kalendar vyse a vyberte zacatek a konec dovolene</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'vacation_planner_data';
    const FONT_SIZE_KEY = 'vacation_planner_font_size';
    let saveTimeout = null;

    // Font size functions
    function setFontSize(size) {
      document.documentElement.style.setProperty('--editor-font-size', size);
      localStorage.setItem(FONT_SIZE_KEY, size);
      document.getElementById('fontSizeSelect').value = size;
    }

    function loadFontSize() {
      const savedSize = localStorage.getItem(FONT_SIZE_KEY);
      if (savedSize) {
        setFontSize(savedSize);
      }
    }

    // Merge state - tracks which nights are merged
    // mergedNights[i] = number of nights merged starting from night i
    // e.g., mergedNights[0] = 3 means nights 0, 1, 2 are merged into one box
    let mergedNights = {};

    function mergeWithNext(nightIndex) {
      const totalNights = getDaysBetween(selectedStartDate, selectedEndDate).length - 1;

      // Find the current merge group this night belongs to
      let groupStart = nightIndex;
      for (let i = 0; i < nightIndex; i++) {
        if (mergedNights[i] && i + mergedNights[i] > nightIndex) {
          groupStart = i;
          break;
        }
      }

      // Current size of the group
      const currentSize = mergedNights[groupStart] || 1;
      const newEnd = groupStart + currentSize;

      // Can't merge if we're at the last night
      if (newEnd >= totalNights) return;

      // Check if next night is part of another group
      let nextGroupSize = mergedNights[newEnd] || 1;

      // Merge: extend current group to include next group
      mergedNights[groupStart] = currentSize + nextGroupSize;

      // Remove the old entry for the next group if it existed
      if (mergedNights[newEnd]) {
        delete mergedNights[newEnd];
      }

      saveToStorage();
      generateTimeline(true);
    }

    function unmergeNight(nightIndex) {
      // Find the merge group this night belongs to
      let groupStart = nightIndex;
      for (let i = 0; i <= nightIndex; i++) {
        if (mergedNights[i] && i + mergedNights[i] > nightIndex) {
          groupStart = i;
          break;
        }
      }

      // Reset to individual nights
      const groupSize = mergedNights[groupStart] || 1;
      delete mergedNights[groupStart];

      saveToStorage();
      generateTimeline(true);
    }

    function getMergeGroupForNight(nightIndex) {
      // Returns {start, size} for the merge group containing this night
      for (let i = 0; i <= nightIndex; i++) {
        if (mergedNights[i] && i + mergedNights[i] > nightIndex) {
          return { start: i, size: mergedNights[i] };
        }
      }
      return { start: nightIndex, size: 1 };
    }

    function getPrevGroupStart(nightIndex) {
      // Find the start of the previous group (the one ending just before nightIndex)
      for (let i = 0; i < nightIndex; i++) {
        const size = mergedNights[i] || 1;
        if (i + size === nightIndex) {
          return i;
        }
      }
      return nightIndex - 1;
    }

    // Calendar state
    let currentMonth = new Date();
    let selectedStartDate = null;
    let selectedEndDate = null;
    let selectionState = 0; // 0 = nic, 1 = vybran start, 2 = vybran konec

    const monthNames = ['Leden', 'Unor', 'Brezen', 'Duben', 'Kveten', 'Cerven',
                        'Cervenec', 'Srpen', 'Zari', 'Rijen', 'Listopad', 'Prosinec'];

    // Nacteni ulozenych dat z LocalStorage
    function loadFromStorage() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.error('Chyba pri nacitani dat:', e);
        }
      }
      return null;
    }

    // Ulozeni dat do LocalStorage
    function saveToStorage() {
      const days = {};
      const nights = {};

      document.querySelectorAll('[id^="day-"]').forEach(el => {
        days[el.id] = el.value;
      });

      document.querySelectorAll('[id^="night-"]').forEach(el => {
        nights[el.id] = el.value;
      });

      const data = {
        startDate: selectedStartDate ? formatDateISO(selectedStartDate) : null,
        endDate: selectedEndDate ? formatDateISO(selectedEndDate) : null,
        days,
        nights,
        mergedNights: { ...mergedNights }
      };

      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showSaveIndicator();
    }

    function formatDateISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Zobrazeni indikatoru ulozeni
    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }

    // Odlozene ukladani (debounce)
    function scheduleSave() {
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      saveTimeout = setTimeout(saveToStorage, 500);
    }

    // Smazani ulozenych dat
    function clearStorage() {
      if (confirm('Opravdu chcete smazat vsechna ulozena data?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // Export dat do JSON souboru
    function exportData() {
      const days = {};
      const nights = {};

      document.querySelectorAll('[id^="day-"]').forEach(el => {
        days[el.id] = el.value;
      });

      document.querySelectorAll('[id^="night-"]').forEach(el => {
        nights[el.id] = el.value;
      });

      const data = {
        exportDate: new Date().toISOString(),
        startDate: selectedStartDate ? formatDateISO(selectedStartDate) : null,
        endDate: selectedEndDate ? formatDateISO(selectedEndDate) : null,
        days,
        nights,
        mergedNights: { ...mergedNights }
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const filename = `dovolena_${formatDateISO(selectedStartDate)}_${formatDateISO(selectedEndDate)}.json`;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Import dat z JSON souboru
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.startDate && data.endDate) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            location.reload();
          } else {
            alert('Neplatny format souboru');
          }
        } catch (err) {
          alert('Chyba pri cteni souboru: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Tisk planu
    function printPlan() {
      if (selectedStartDate && selectedEndDate) {
        const nights = getDaysBetween(selectedStartDate, selectedEndDate).length - 1;
        document.getElementById('printHeader').textContent =
          `${formatDateWithYear(selectedStartDate)} - ${formatDateWithYear(selectedEndDate)} (${nights} noci)`;
      }
      window.print();
    }

    function formatDate(date) {
      const day = date.getDate();
      const month = date.getMonth() + 1;
      return `${day}.${month}.`;
    }

    function formatDateFull(date) {
      const days = ['Ne', 'Po', 'Ut', 'St', 'Ct', 'Pa', 'So'];
      const dayName = days[date.getDay()];
      const day = date.getDate();
      const month = date.getMonth() + 1;
      return `${dayName} ${day}.${month}.`;
    }

    function formatDateWithYear(date) {
      const days = ['Ne', 'Po', 'Ut', 'St', 'Ct', 'Pa', 'So'];
      const dayName = days[date.getDay()];
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return `${dayName} ${day}.${month}.${year}`;
    }

    function formatDateRange(start, end) {
      if (!start) return 'Vyberte rozsah dovolene';
      if (!end) return `${formatDateFull(start)} - ...`;
      return `${formatDateFull(start)} - ${formatDateFull(end)}`;
    }

    function getDaysBetween(start, end) {
      const days = [];
      const current = new Date(start);
      while (current <= end) {
        days.push(new Date(current));
        current.setDate(current.getDate() + 1);
      }
      return days;
    }

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    // Calendar functions
    function toggleCalendar() {
      const dropdown = document.getElementById('calendarDropdown');
      dropdown.classList.toggle('show');
      if (dropdown.classList.contains('show')) {
        renderCalendar();
      }
    }

    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      // Pondeli = 0, Nedele = 6
      let startDay = firstDay.getDay() - 1;
      if (startDay < 0) startDay = 6;

      const daysContainer = document.getElementById('calendarDays');
      daysContainer.innerHTML = '';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Dny z predchoziho mesice
      const prevMonth = new Date(year, month, 0);
      for (let i = startDay - 1; i >= 0; i--) {
        const dayNum = prevMonth.getDate() - i;
        const date = new Date(year, month - 1, dayNum);
        const btn = createDayButton(date, dayNum, true);
        daysContainer.appendChild(btn);
      }

      // Dny aktualniho mesice
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const btn = createDayButton(date, day, false);
        daysContainer.appendChild(btn);
      }

      // Dny z nasledujiciho mesice
      const remainingDays = 42 - daysContainer.children.length;
      for (let day = 1; day <= remainingDays; day++) {
        const date = new Date(year, month + 1, day);
        const btn = createDayButton(date, day, true);
        daysContainer.appendChild(btn);
      }
    }

    function createDayButton(date, dayNum, isOtherMonth) {
      const btn = document.createElement('button');
      btn.className = 'calendar-day';
      btn.textContent = dayNum;

      if (isOtherMonth) {
        btn.classList.add('other-month');
      }

      if (isWeekend(date)) {
        btn.classList.add('weekend');
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dateNormalized = new Date(date);
      dateNormalized.setHours(0, 0, 0, 0);

      if (dateNormalized.getTime() === today.getTime()) {
        btn.classList.add('today');
      }

      if (selectedStartDate) {
        const startNorm = new Date(selectedStartDate);
        startNorm.setHours(0, 0, 0, 0);
        if (dateNormalized.getTime() === startNorm.getTime()) {
          btn.classList.add('selected-start');
        }
      }

      if (selectedEndDate) {
        const endNorm = new Date(selectedEndDate);
        endNorm.setHours(0, 0, 0, 0);
        if (dateNormalized.getTime() === endNorm.getTime()) {
          btn.classList.add('selected-end');
        }
      }

      if (selectedStartDate && selectedEndDate) {
        const startNorm = new Date(selectedStartDate);
        startNorm.setHours(0, 0, 0, 0);
        const endNorm = new Date(selectedEndDate);
        endNorm.setHours(0, 0, 0, 0);
        if (dateNormalized > startNorm && dateNormalized < endNorm) {
          btn.classList.add('in-range');
        }
      }

      btn.onclick = (e) => {
        e.stopPropagation();
        selectDate(date);
      };

      return btn;
    }

    function selectDate(date) {
      if (selectionState === 0 || selectionState === 2) {
        // Prvni klik nebo treti klik (reset)
        selectedStartDate = new Date(date);
        selectedEndDate = null;
        selectionState = 1;
        // Reset stavu slucovani pri novem vyberu
        mergedNights = {};
      } else if (selectionState === 1) {
        // Druhy klik
        if (date < selectedStartDate) {
          // Pokud je druhe datum pred prvnim, prohodime
          selectedEndDate = new Date(selectedStartDate);
          selectedStartDate = new Date(date);
        } else {
          selectedEndDate = new Date(date);
        }
        selectionState = 2;
        // Zavrit kalendar po vyberu rozsahu
        document.getElementById('calendarDropdown').classList.remove('show');
        // Automaticky generovat timeline
        generateTimeline();
      }

      updateDateRangeDisplay();
      renderCalendar();
      if (selectionState === 1) {
        saveToStorage();
      }
    }

    function updateDateRangeDisplay() {
      document.getElementById('dateRangeText').textContent =
        formatDateRange(selectedStartDate, selectedEndDate);

      const statsEl = document.getElementById('dateStats');
      if (selectedStartDate && selectedEndDate) {
        const days = getDaysBetween(selectedStartDate, selectedEndDate);
        const nights = days.length - 1;
        statsEl.textContent = `${days.length} dni, ${nights} noci`;
      } else {
        statsEl.textContent = '';
      }
    }

    function generateTimeline(preserveData = false) {
      if (!selectedStartDate || !selectedEndDate) {
        return;
      }

      const days = getDaysBetween(selectedStartDate, selectedEndDate);
      const container = document.getElementById('timelineContent');
      const savedData = preserveData ? loadFromStorage() : null;

      let html = '<div class="timeline-wrapper">';

      // Karty dnu nad osou
      html += '<div class="days-container">';
      days.forEach((day, index) => {
        const savedValue = savedData?.days?.[`day-${index}`] || '';
        const weekendClass = isWeekend(day) ? 'weekend' : '';
        html += `
          <div class="day-column ${weekendClass}">
            <div class="day-card ${weekendClass}">
              <div class="day-card-header">${formatDateFull(day)}</div>
              <textarea id="day-${index}" oninput="scheduleSave()">${savedValue}</textarea>
            </div>
            <div class="day-line"></div>
          </div>
        `;
      });
      html += '</div>';

      // Casova osa s body
      html += '<div class="day-points-container">';
      html += '<div class="axis-background"></div>';
      days.forEach((day, index) => {
        const weekendClass = isWeekend(day) ? 'weekend' : '';
        html += `
          <div class="day-point-wrapper ${weekendClass}">
            <div class="day-point"></div>
            <div class="day-point-label">${formatDate(day)}</div>
          </div>
        `;
      });
      html += '</div>';

      // Karty noci pod osou (o jeden mene nez dnu) - vycentrovane presne mezi dny
      const totalNights = days.length - 1;
      if (totalNights > 0) {
        html += '<div class="nights-container">';
        // Pridame prazdny spacer na zacatek o polovine sirky
        html += '<div style="flex: 0.5; min-width: 50px;"></div>';

        let i = 0;
        let isFirst = true;
        while (i < totalNights) {
          const mergeSize = mergedNights[i] || 1;
          const startDay = days[i];
          const endDay = days[i + mergeSize];
          const nightLabel = `${formatDate(startDay)} - ${formatDate(endDay)}`;
          const savedName = savedData?.nights?.[`night-name-${i}`] || '';
          const savedCity = savedData?.nights?.[`night-city-${i}`] || '';
          const savedNotes = savedData?.nights?.[`night-notes-${i}`] || '';

          const isMerged = mergeSize > 1;
          const nightsCountBadge = isMerged ? `<span class="nights-count">${mergeSize} noci</span>` : '';

          // Separator s tlacitkem "+" mezi noci (krome prvni)
          if (!isFirst) {
            const prevGroupStart = getPrevGroupStart(i);
            html += `<div class="night-separator"><button class="merge-btn" onclick="mergeWithNext(${prevGroupStart})" title="Sloucit noci">+</button></div>`;
          }
          isFirst = false;

          // Tlacitko rozdelit pro sloucene noci
          const splitBtn = isMerged ? `<button class="merge-btn unmerge" onclick="unmergeNight(${i})" title="Rozdelit noci">‚úÇ</button>` : '';

          // Generovat spojovaci cary - jednu pro kazdou noc ve sloucene skupine
          let nightLinesHtml = '';
          if (mergeSize === 1) {
            nightLinesHtml = '<div class="night-line"></div>';
          } else {
            nightLinesHtml = '<div class="night-lines-container">';
            for (let j = 0; j < mergeSize; j++) {
              nightLinesHtml += '<div class="night-line"></div>';
            }
            nightLinesHtml += '</div>';
          }

          html += `
            <div class="night-column" style="flex: ${mergeSize}; min-width: ${mergeSize * 100}px;">
              ${nightLinesHtml}
              <div class="night-card">
                <div class="night-card-header-row">
                  <div class="night-card-title">
                    <span class="night-icon">üåô</span> Noc ${nightLabel}${nightsCountBadge}
                  </div>
                  ${splitBtn}
                </div>
                <div class="field-group">
                  <div class="field-label"><span class="field-icon">üè†</span> Nazev ubytovani</div>
                  <input type="text" id="night-name-${i}" value="${savedName}" oninput="scheduleSave()">
                </div>
                <div class="field-group">
                  <div class="field-label"><span class="field-icon">üìç</span> Obec</div>
                  <input type="text" id="night-city-${i}" value="${savedCity}" oninput="scheduleSave()">
                </div>
                <textarea id="night-notes-${i}" oninput="scheduleSave()">${savedNotes}</textarea>
              </div>
            </div>
          `;
          i += mergeSize;
        }
        // Pridame prazdny spacer na konec o polovine sirky
        html += '<div style="flex: 0.5; min-width: 50px;"></div>';
        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;

      // Ulozit datumy
      if (!preserveData) {
        saveToStorage();
      }
    }

    // Zavrit kalendar pri kliknuti mimo
    document.addEventListener('click', (e) => {
      const container = document.querySelector('.calendar-picker-container');
      if (!container.contains(e.target)) {
        document.getElementById('calendarDropdown').classList.remove('show');
      }
    });

    // Klavesove zkratky
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'p') {
          e.preventDefault();
          printPlan();
        } else if (e.key === 's') {
          e.preventDefault();
          saveToStorage();
        } else if (e.key === 'e') {
          e.preventDefault();
          exportData();
        }
      }
    });

    // Inicializace
    function init() {
      loadFontSize();
      const saved = loadFromStorage();

      if (saved && saved.startDate && saved.endDate) {
        selectedStartDate = new Date(saved.startDate);
        selectedEndDate = new Date(saved.endDate);
        selectionState = 2;
        currentMonth = new Date(selectedStartDate);
        // Nacist stav slucovani
        if (saved.mergedNights) {
          mergedNights = { ...saved.mergedNights };
        }
        updateDateRangeDisplay();
        generateTimeline(true);
      } else {
        // Nastaveni defaultnich datumu (dnesek + 7 dni)
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);

        selectedStartDate = today;
        selectedEndDate = nextWeek;
        selectionState = 2;
        mergedNights = {};
        updateDateRangeDisplay();
        generateTimeline();
      }
    }

    // Spustit inicializaci po nacteni stranky
    init();
  </script>
</body>
</html>
