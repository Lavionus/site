<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ ToDo Aplikace Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            align-items: start;
        }

        .main-content {
            min-width: 0;
        }

        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        h1 {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 2rem;
            font-weight: 600;
            grid-column: 1 / -1;
        }

        /* Tlaƒç√≠tko pro p≈ôid√°n√≠ √∫kolu */
        .add-task-btn-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .add-task-main-btn {
            background-color: #6aa6fd;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .add-task-main-btn:hover {
            background-color: #5694f0;
            transform: translateY(-2px);
        }

        /* Tlaƒç√≠tko undo */
        .undo-btn {
            background-color: #404040;
            color: #e0e0e0;
            padding: 10px 16px;
            border-radius: 4px;
            border: 1px solid #555;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .undo-btn:hover:not(:disabled) {
            background-color: #4a4a4a;
            transform: translateY(-1px);
        }

        .undo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Vyhled√°v√°n√≠ */
        .search-section {
            margin-bottom: 15px;
        }

        .search-box {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #404040;
            color: #e0e0e0;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #6aa6fd;
        }

        /* Mod√°ln√≠ okna */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404040;
        }

        .modal-header h2 {
            color: #e0e0e0;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #f44336;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #404040;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
            font-weight: 500;
        }

        /* Input sekce */
        input[type="text"], input[type="date"], select, textarea {
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #404040;
            color: #e0e0e0;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
            font-family: inherit;
            width: 100%;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input[type="text"]::placeholder, textarea::placeholder {
            color: #999;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6aa6fd;
        }

        select {
            cursor: pointer;
        }

        button {
            padding: 10px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        button:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background-color: #6aa6fd;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5694f0;
        }

        .btn-secondary {
            background-color: #404040;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        .btn-secondary:hover {
            background-color: #4a4a4a;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background-color: #45a049;
        }

        /* Filtry */
        .filter-section {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #404040;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 24px;
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #e0e0e0;
        }

        .filter-btn.active {
            background-color: #404040;
            color: #6aa6fd;
            border-color: #6aa6fd;
        }

        .filter-btn:hover:not(.active) {
            background-color: #353535;
        }

        /* Seznam √∫kol≈Ø - DVOUSLOUPCOV√â ZOBRAZEN√ç */
        #output {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (min-width: 900px) {
            #output {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .task-item {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
            break-inside: avoid;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-item.completed {
            opacity: 0.7;
        }

        /* Priorita barevn√© oznaƒçen√≠ */
        .task-item.priority-high {
            border-left: 4px solid #f44336;
        }

        .task-item.priority-medium {
            border-left: 4px solid #ff9800;
        }

        .task-item.priority-low {
            border-left: 4px solid #4caf50;
        }

        /* Expiruj√≠c√≠ √∫koly */
        .task-item.expiring {
            background-color: #3a2a1a;
        }

        .task-item.overdue {
            background-color: #3a1a1a;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .task-content {
            flex: 1;
            cursor: pointer;
        }

        .task-text {
            font-size: 1rem;
            color: #e0e0e0;
            display: block;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #888;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .task-date, .task-due {
            color: #aaa;
        }

        .task-due.overdue {
            color: #f44336;
            font-weight: 600;
        }

        .task-due.expiring-soon {
            color: #ff9800;
            font-weight: 600;
        }

        .task-priority-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .task-priority-badge.high {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .task-priority-badge.medium {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .task-priority-badge.low {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .task-actions button {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .task-notes {
            margin-top: 10px;
            padding: 10px;
            padding-left: 0;
            background-color: #353535;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #ccc;
            white-space: pre-wrap;
        }

        /* Pod√∫koly */
        .subtask-progress {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #404040;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #404040;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background-color: #4caf50;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #aaa;
        }

        .subtasks-section {
            margin-top: 10px;
        }

        .subtask-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #353535;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        .subtask-item.completed {
            opacity: 0.6;
        }

        .subtask-item:hover {
            background-color: #3a3a3a;
        }

        .subtask-text {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
            user-select: none;
        }

        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
            color: #888;
        }

        .subtask-actions {
            display: flex;
            gap: 5px;
        }

        .subtask-actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .add-subtask-section {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .subtask-input {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
        }

        .add-subtask-section button {
            padding: 8px 12px;
        }

        /* Statistiky */
        .stats {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stats h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #404040;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #ccc;
        }

        .stat-value {
            font-weight: 600;
            color: #6aa6fd;
        }

        /* Akce */
        .actions {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 15px;
        }

        .actions h3 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn {
            width: 100%;
            margin-bottom: 8px;
            justify-content: center;
        }

        .action-btn:last-child {
            margin-bottom: 0;
        }

        /* Pr√°zdn√Ω stav */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            font-size: 1.1rem;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Responsivita */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                order: 2;
            }

            h1 {
                font-size: 1.5rem;
            }

            .filter-section {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #output {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ ToDo Aplikace Pro</h1>
        
        <div class="main-content">
            <!-- Tlaƒç√≠tko pro p≈ôid√°n√≠ nov√©ho √∫kolu + Undo -->
            <div class="add-task-btn-container">
                <button class="add-task-main-btn" onclick="openAddTaskModal()">
                    ‚ûï P≈ôidat nov√Ω √∫kol
                </button>
                <button class="undo-btn" id="undoBtn" onclick="undo()" disabled>
                    ‚Ü©Ô∏è Zpƒõt
                </button>
            </div>

            <!-- Vyhled√°v√°n√≠ -->
            <div class="search-section">
                <input type="text" id="searchInput" class="search-box" placeholder="üîç Vyhledat √∫koly..." oninput="displayTasks()">
            </div>

            <!-- Filtry -->
            <div class="filter-section">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">üìã V≈°echny</button>
                <button class="filter-btn" data-filter="active" onclick="setFilter('active')">‚úèÔ∏è Aktivn√≠</button>
                <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">‚úÖ Dokonƒçen√©</button>
                <button class="filter-btn" data-filter="high" onclick="setFilter('high')">‚¨ÜÔ∏è Vysok√° priorita</button>
                <button class="filter-btn" data-filter="expiring" onclick="setFilter('expiring')">‚è∞ Expiruj√≠c√≠</button>
            </div>

            <!-- Seznam √∫kol≈Ø -->
            <ul id="output"></ul>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="stats">
                <h3>üìä Statistiky</h3>
                <div class="stat-item">
                    <span class="stat-label">Celkem</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Aktivn√≠</span>
                    <span class="stat-value" id="statActive">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dokonƒçen√©</span>
                    <span class="stat-value" id="statCompleted">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Expiruj√≠c√≠</span>
                    <span class="stat-value" id="statExpiring">0</span>
                </div>
            </div>

            <div class="actions">
                <h3>‚öôÔ∏è Akce</h3>
                <button class="action-btn btn-danger" onclick="openClearCompletedModal()">üóëÔ∏è Smazat dokonƒçen√©</button>
                <button class="action-btn btn-secondary" onclick="openExportModal()">üíæ Exportovat data</button>
                <button class="action-btn btn-secondary" onclick="openImportModal()">üìÇ Importovat data</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro p≈ôid√°n√≠ √∫kolu -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï P≈ôidat nov√Ω √∫kol</h2>
                <button class="modal-close" onclick="closeAddTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalTaskName">N√°zev √∫kolu *</label>
                    <input type="text" id="modalTaskName" placeholder="Co pot≈ôebuje≈° udƒõlat?">
                </div>
                <div class="form-group">
                    <label for="modalTaskDate">Datum vytvo≈ôen√≠</label>
                    <input type="date" id="modalTaskDate">
                </div>
                <div class="form-group">
                    <label for="modalTaskDueDate">Term√≠n splnƒõn√≠</label>
                    <input type="date" id="modalTaskDueDate">
                </div>
                <div class="form-group">
                    <label for="modalTaskPriority">Priorita</label>
                    <select id="modalTaskPriority">
                        <option value="low">‚¨áÔ∏è N√≠zk√°</option>
                        <option value="medium" selected>‚û°Ô∏è St≈ôedn√≠</option>
                        <option value="high">‚¨ÜÔ∏è Vysok√°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalTaskNotes">Pozn√°mky</label>
                    <textarea id="modalTaskNotes" placeholder="Dopl≈àuj√≠c√≠ informace..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddTaskModal()">Zru≈°it</button>
                <button class="btn-primary" onclick="addTaskFromModal()">‚ûï P≈ôidat √∫kol</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro potvrzen√≠ maz√°n√≠ -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmTitle">‚ùì Potvrzen√≠</h2>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: #ccc; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeConfirmModal()">Zru≈°it</button>
                <button class="btn-danger" id="confirmBtn" onclick="confirmAction()">Potvrdit</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro detail √∫kolu (p≈Øvodn√≠ funkce) -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Detail √∫kolu</h2>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTaskName">N√°zev √∫kolu</label>
                    <input type="text" id="editTaskName">
                </div>
                <div class="form-group">
                    <label for="editTaskDate">Datum vytvo≈ôen√≠</label>
                    <input type="date" id="editTaskDate">
                </div>
                <div class="form-group">
                    <label for="editTaskDueDate">Term√≠n splnƒõn√≠</label>
                    <input type="date" id="editTaskDueDate">
                </div>
                <div class="form-group">
                    <label for="editTaskPriority">Priorita</label>
                    <select id="editTaskPriority">
                        <option value="low">‚¨áÔ∏è N√≠zk√°</option>
                        <option value="medium">‚û°Ô∏è St≈ôedn√≠</option>
                        <option value="high">‚¨ÜÔ∏è Vysok√°</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTaskNotes">Pozn√°mky</label>
                    <textarea id="editTaskNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editTaskCompleted" style="width: auto; margin-right: 8px;">
                        √ökol je dokonƒçen
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeTaskModal()">Zav≈ô√≠t</button>
                <button class="btn-primary" onclick="saveTaskChanges()">üíæ Ulo≈æit zmƒõny</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro export -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üì§ Export dat</h2>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #ccc; line-height: 1.6; margin-bottom: 15px;">
                    Exportovat v≈°echny √∫koly do JSON souboru?
                </p>
                <p style="color: #999; font-size: 0.85rem;">
                    Soubor bude ulo≈æen jako: <br>
                    <code style="background: #404040; padding: 2px 6px; border-radius: 3px;">todo_backup_YYYY-MM-DD.json</code>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeExportModal()">Zru≈°it</button>
                <button class="btn-primary" onclick="confirmExport()">üì§ Exportovat</button>
            </div>
        </div>
    </div>

    <!-- Mod√°ln√≠ okno pro import -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üì• Import dat</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #ccc; line-height: 1.6; margin-bottom: 15px;">
                    Vyberte JSON soubor s exportovan√Ωmi √∫koly.
                </p>
                <p style="color: #ff9800; font-size: 0.85rem; margin-bottom: 15px;">
                    ‚ö†Ô∏è Pozor: Existuj√≠c√≠ √∫koly budou nahrazeny importovan√Ωmi daty!
                </p>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn-primary" onclick="document.getElementById('importFileInput').click()" style="width: 100%;">
                    üìÅ Vybrat soubor
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeImportModal()">Zru≈°it</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script>
        // === INICIALIZACE DATAB√ÅZE ===
        const db = new Dexie('TodoAppDB');
        db.version(3).stores({
            tasks: '++id, name, date, isCompleted, priority, dueDate, notes'
        });

        // === GLOB√ÅLN√ç PROMƒöNN√â ===
        let currentFilter = 'all';
        let currentTaskId = null;
        let confirmCallback = null;
        let undoHistory = [];
        const MAX_UNDO_HISTORY = 10;

        // === UNDO FUNKCE ===
        function saveToHistory(action, data) {
            undoHistory.push({ action, data, timestamp: Date.now() });
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
            updateUndoButton();
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            undoBtn.disabled = undoHistory.length === 0;
        }

        async function undo() {
            if (undoHistory.length === 0) return;

            const lastAction = undoHistory.pop();
            
            try {
                switch(lastAction.action) {
                    case 'add':
                        await db.tasks.delete(lastAction.data.id);
                        break;
                    case 'delete':
                        await db.tasks.add(lastAction.data);
                        break;
                    case 'update':
                        await db.tasks.update(lastAction.data.id, lastAction.data.oldData);
                        break;
                    case 'deleteSubtask':
                        const task = await db.tasks.get(lastAction.data.taskId);
                        if (task) {
                            task.subtasks = task.subtasks || [];
                            task.subtasks.push(lastAction.data.subtask);
                            await db.tasks.update(lastAction.data.taskId, { subtasks: task.subtasks });
                        }
                        break;
                    case 'clearCompleted':
                        for (const task of lastAction.data.tasks) {
                            await db.tasks.add(task);
                        }
                        break;
                }
                
                displayTasks();
                updateUndoButton();
            } catch (error) {
                console.error('Chyba p≈ôi undo:', error);
                alert('‚ùå Nepoda≈ôilo se vr√°tit zmƒõnu');
            }
        }

        // === MOD√ÅLN√ç OKNA ===
        function openAddTaskModal() {
            document.getElementById('modalTaskName').value = '';
            document.getElementById('modalTaskDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalTaskDueDate').value = '';
            document.getElementById('modalTaskPriority').value = 'medium';
            document.getElementById('modalTaskNotes').value = '';
            document.getElementById('addTaskModal').classList.add('show');
            document.getElementById('modalTaskName').focus();
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('show');
        }

        async function addTaskFromModal() {
            const name = document.getElementById('modalTaskName').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è Vypl≈à n√°zev √∫kolu');
                return;
            }

            const taskData = {
                name: name,
                date: document.getElementById('modalTaskDate').value || new Date().toISOString().split('T')[0],
                dueDate: document.getElementById('modalTaskDueDate').value || null,
                priority: document.getElementById('modalTaskPriority').value,
                notes: document.getElementById('modalTaskNotes').value.trim() || null,
                isCompleted: false,
                subtasks: []
            };

            try {
                const id = await db.tasks.add(taskData);
                saveToHistory('add', { id });
                displayTasks();
                closeAddTaskModal();
            } catch (error) {
                alert(`‚ùå Chyba: ${error.message}`);
            }
        }

        function openConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }

        // === EXPORT/IMPORT MOD√ÅLY ===
        function openExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function confirmExport() {
            closeExportModal();
            exportData();
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        function openClearCompletedModal() {
            db.tasks.where('isCompleted').equals(true).count().then(count => {
                if (count === 0) {
                    alert('‚ÑπÔ∏è ≈Ω√°dn√© dokonƒçen√© √∫koly ke smaz√°n√≠');
                    return;
                }
                openConfirmModal(
                    'üóëÔ∏è Smazat dokonƒçen√©',
                    `Opravdu chce≈° smazat ${count} dokonƒçen√Ωch √∫kol≈Ø? Tato akce nejde vr√°tit zpƒõt.`,
                    clearAllCompleted
                );
            });
        }

        // === FILTRY ===
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            displayTasks();
        }

        // === OPERACE S √öKOLY ===
        async function deleteTask(id) {
            const task = await db.tasks.get(id);
            openConfirmModal(
                'üóëÔ∏è Smazat √∫kol',
                `Opravdu chce≈° smazat √∫kol "${task.name}"?`,
                async () => {
                    saveToHistory('delete', task);
                    await db.tasks.delete(id);
                    displayTasks();
                }
            );
        }

        async function quickToggleCompletion(id) {
            const task = await db.tasks.get(id);
            const oldData = { ...task };
            task.isCompleted = !task.isCompleted;
            saveToHistory('update', { id, oldData });
            await db.tasks.update(id, { isCompleted: task.isCompleted });
            displayTasks();
        }

        // === DETAIL √öKOLU ===
        async function openTaskModal(id) {
            currentTaskId = id;
            const task = await db.tasks.get(id);
            
            if (!task) return;

            document.getElementById('editTaskName').value = task.name;
            document.getElementById('editTaskDate').value = task.date || '';
            document.getElementById('editTaskDueDate').value = task.dueDate || '';
            document.getElementById('editTaskPriority').value = task.priority || 'medium';
            document.getElementById('editTaskNotes').value = task.notes || '';
            document.getElementById('editTaskCompleted').checked = task.isCompleted;
            
            document.getElementById('taskModal').classList.add('show');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            currentTaskId = null;
        }

        async function saveTaskChanges() {
            if (!currentTaskId) return;

            const task = await db.tasks.get(currentTaskId);
            const oldData = { ...task };

            const updates = {
                name: document.getElementById('editTaskName').value.trim(),
                date: document.getElementById('editTaskDate').value,
                dueDate: document.getElementById('editTaskDueDate').value || null,
                priority: document.getElementById('editTaskPriority').value,
                notes: document.getElementById('editTaskNotes').value.trim() || null,
                isCompleted: document.getElementById('editTaskCompleted').checked
            };

            if (!updates.name) {
                alert('‚ö†Ô∏è N√°zev √∫kolu nem≈Ø≈æe b√Ωt pr√°zdn√Ω');
                return;
            }

            saveToHistory('update', { id: currentTaskId, oldData });
            await db.tasks.update(currentTaskId, updates);
            displayTasks();
            closeTaskModal();
        }

        // === POD√öKOLY ===
        async function addSubtask(taskId) {
            const task = await db.tasks.get(taskId);
            if (!task) return;

            const input = document.querySelector(`.task-item[data-task-id="${taskId}"] .subtask-input`);
            const subtaskName = input.value.trim();
            
            if (!subtaskName) return;

            const subtask = {
                id: Date.now(),
                name: subtaskName,
                isCompleted: false
            };

            task.subtasks = task.subtasks || [];
            task.subtasks.push(subtask);
            
            await db.tasks.update(taskId, { subtasks: task.subtasks });
            input.value = '';
            displayTasks();
        }

        async function toggleSubtaskCompletion(taskId, subtaskId) {
            const task = await db.tasks.get(taskId);
            if (!task || !task.subtasks) return;

            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (subtask) {
                subtask.isCompleted = !subtask.isCompleted;
                await db.tasks.update(taskId, { subtasks: task.subtasks });
                displayTasks();
            }
        }

        async function deleteSubtask(taskId, subtaskId) {
            const task = await db.tasks.get(taskId);
            if (!task || !task.subtasks) return;

            const subtask = task.subtasks.find(st => st.id === subtaskId);
            
            openConfirmModal(
                'üóëÔ∏è Smazat pod√∫kol',
                `Opravdu chce≈° smazat pod√∫kol "${subtask.name}"?`,
                async () => {
                    saveToHistory('deleteSubtask', { taskId, subtask });
                    task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
                    await db.tasks.update(taskId, { subtasks: task.subtasks });
                    displayTasks();
                }
            );
        }

        // === ZOBRAZEN√ç √öKOL≈Æ ===
        async function displayTasks() {
            const outputList = document.getElementById('output');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            try {
                let tasks = await db.tasks.toArray();

                // Vyhled√°v√°n√≠
                if (searchTerm) {
                    tasks = tasks.filter(task => 
                        task.name.toLowerCase().includes(searchTerm) ||
                        (task.notes && task.notes.toLowerCase().includes(searchTerm))
                    );
                }

                // Filtry
                if (currentFilter === 'active') {
                    tasks = tasks.filter(task => !task.isCompleted);
                } else if (currentFilter === 'completed') {
                    tasks = tasks.filter(task => task.isCompleted);
                } else if (currentFilter === 'high') {
                    tasks = tasks.filter(task => task.priority === 'high');
                } else if (currentFilter === 'expiring') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    tasks = tasks.filter(task => {
                        if (!task.dueDate || task.isCompleted) return false;
                        const daysUntil = getDaysUntilDue(task.dueDate);
                        return daysUntil <= 3;
                    });
                }

                // Aktualizace statistik
                updateStats(await db.tasks.toArray());

                // ≈òazen√≠
                tasks.sort((a, b) => {
                    const priorityOrder = { high: 0, medium: 1, low: 2 };
                    if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
                    if (a.dueDate && b.dueDate) {
                        const diff = new Date(a.dueDate) - new Date(b.dueDate);
                        if (diff !== 0) return diff;
                    }
                    if (a.dueDate && !b.dueDate) return -1;
                    if (!a.dueDate && b.dueDate) return 1;
                    return priorityOrder[a.priority || 'medium'] - priorityOrder[b.priority || 'medium'];
                });

                if (tasks.length === 0) {
                    outputList.innerHTML = `
                        <li style="grid-column: 1 / -1;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <div>≈Ω√°dn√© √∫koly</div>
                            </div>
                        </li>
                    `;
                    return;
                }

                let html = '';
                tasks.forEach(task => {
                    const completedClass = task.isCompleted ? 'completed' : '';
                    const priorityClass = `priority-${task.priority || 'medium'}`;
                    const date = task.date ? new Date(task.date).toLocaleDateString('cs-CZ') : null;
                    
                    const progress = calculateSubtaskProgress(task.subtasks || []);
                    
                    let expiringClass = '';
                    let dueStatus = '';
                    
                    if (task.dueDate && !task.isCompleted) {
                        const daysUntil = getDaysUntilDue(task.dueDate);
                        if (daysUntil < 0) {
                            dueStatus = 'overdue';
                            expiringClass = 'overdue';
                        } else if (daysUntil <= 3) {
                            dueStatus = 'expiring-soon';
                            expiringClass = 'expiring';
                        }
                    }
                    
                    html += `
                        <li class="task-item ${completedClass} ${priorityClass} ${expiringClass}" data-task-id="${task.id}">
                            <div class="task-header">
                                <div class="task-content" onclick="openTaskModal(${task.id})">
                                    <span class="task-text">${escapeHtml(task.name)}</span>
                                    <div class="task-meta">
                                        ${date ? `<span class="task-date">üìÖ ${date}</span>` : ''}
                                        ${task.dueDate ? `<span class="task-due ${dueStatus}">‚è∞ ${formatDueDate(task.dueDate)}</span>` : ''}
                                        <span class="task-priority-badge ${task.priority || 'medium'}">${getPriorityIcon(task.priority)} ${getPriorityLabel(task.priority)}</span>
                                    </div>
                                </div>
                                <div class="task-actions">
                                    <button class="${task.isCompleted ? 'btn-secondary' : 'btn-success'}" onclick="event.stopPropagation(); quickToggleCompletion(${task.id})" title="${task.isCompleted ? 'Zru≈°it dokonƒçen√≠' : 'Rychle dokonƒçit'}">
                                        ${task.isCompleted ? '‚Ü©Ô∏è' : '‚úÖ'}
                                    </button>
                                    <button class="btn-danger" onclick="event.stopPropagation(); deleteTask(${task.id})" title="Smazat">üóëÔ∏è</button>
                                </div>
                            </div>
                    `;
                    
                    if (task.notes) {
                        html += `
                            <div class="task-notes">
                                ${escapeHtml(task.notes)}
                            </div>
                        `;
                    }
                    
                    if (task.subtasks && task.subtasks.length > 0) {
                        html += `
                            <div class="subtask-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                                </div>
                                <div class="progress-text">${progress.completed}/${progress.total} pod√∫kol≈Ø (${progress.percentage}%)</div>
                            </div>
                        `;
                    }
                    
                    if (task.subtasks && task.subtasks.length > 0) {
                        html += '<div class="subtasks-section">';
                        task.subtasks.forEach(subtask => {
                            const subtaskCompletedClass = subtask.isCompleted ? 'completed' : '';
                            html += `
                                <div class="subtask-item ${subtaskCompletedClass}">
                                    <span class="subtask-text" onclick="toggleSubtaskCompletion(${task.id}, ${subtask.id})">
                                        ${subtask.isCompleted ? '‚úì' : '‚óã'} ${escapeHtml(subtask.name)}
                                    </span>
                                    <div class="subtask-actions">
                                        <button class="${subtask.isCompleted ? 'btn-secondary' : 'btn-success'}" onclick="toggleSubtaskCompletion(${task.id}, ${subtask.id})" title="${subtask.isCompleted ? 'Zru≈°it' : 'Hotovo'}">
                                            ${subtask.isCompleted ? '‚Ü©Ô∏è' : '‚úÖ'}
                                        </button>
                                        <button class="btn-danger" onclick="deleteSubtask(${task.id}, ${subtask.id})" title="Smazat">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    html += `
                        <div class="add-subtask-section">
                            <input type="text" class="subtask-input" placeholder="‚ûï P≈ôidat pod√∫kol..." onkeypress="if(event.key==='Enter') addSubtask(${task.id})">
                            <button class="btn-primary" onclick="addSubtask(${task.id})">‚ûï</button>
                        </div>
                    `;
                    
                    html += '</li>';
                });
                
                outputList.innerHTML = html;

            } catch (error) {
                outputList.innerHTML = `<li style="grid-column: 1 / -1;"><div class="empty-state">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠</div></li>`;
                console.error("Display error:", error);
            }
        }

        // === STATISTIKY ===
        async function updateStats(tasks) {
            const total = tasks.length;
            const active = tasks.filter(t => !t.isCompleted).length;
            const completed = tasks.filter(t => t.isCompleted).length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiring = tasks.filter(t => {
                if (!t.dueDate || t.isCompleted) return false;
                const daysUntil = getDaysUntilDue(t.dueDate);
                return daysUntil <= 3;
            }).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statExpiring').textContent = expiring;
        }

        function calculateSubtaskProgress(subtasks) {
            if (!subtasks || subtasks.length === 0) {
                return { total: 0, completed: 0, percentage: 0 };
            }
            
            const total = subtasks.length;
            const completed = subtasks.filter(st => st.isCompleted).length;
            const percentage = Math.round((completed / total) * 100);
            
            return { total, completed, percentage };
        }

        // === POMOCN√â FUNKCE ===
        function getPriorityIcon(priority) {
            const icons = { high: '‚¨ÜÔ∏è', medium: '‚û°Ô∏è', low: '‚¨áÔ∏è' };
            return icons[priority] || '‚û°Ô∏è';
        }

        function getPriorityLabel(priority) {
            const labels = { high: 'Vysok√°', medium: 'St≈ôedn√≠', low: 'N√≠zk√°' };
            return labels[priority] || 'St≈ôedn√≠';
        }

        function getDaysUntilDue(dueDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        function formatDueDate(dueDate) {
            const daysUntil = getDaysUntilDue(dueDate);
            
            if (daysUntil < 0) {
                return `Po term√≠nu (${Math.abs(daysUntil)}d)`;
            } else if (daysUntil === 0) {
                return 'Dnes!';
            } else if (daysUntil === 1) {
                return 'Z√≠tra';
            } else if (daysUntil <= 3) {
                return `Za ${daysUntil} dny`;
            } else {
                return new Date(dueDate).toLocaleDateString('cs-CZ');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === EXPORT/IMPORT ===
        async function exportData() {
            try {
                const tasks = await db.tasks.toArray();
                const dataToExport = { 
                    version: 2,
                    exportDate: new Date().toISOString(),
                    tasks: tasks 
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const fileName = `todo_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Alert odstranƒõn - u≈æivatel vid√≠ dialog pro ulo≈æen√≠
            } catch (error) {
                alert(`‚ùå Chyba p≈ôi exportu: ${error.message}`);
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.tasks || !Array.isArray(importedData.tasks)) {
                        throw new Error("Neplatn√Ω form√°t JSON");
                    }
                    
                    closeImportModal(); // Zav≈ô√≠t import mod√°ln√≠ okno
                    
                    const currentCount = await db.tasks.count();
                    if (currentCount > 0) {
                        openConfirmModal(
                            'üìÇ Import dat',
                            `Smazat ${currentCount} √∫kol≈Ø a importovat ${importedData.tasks.length} nov√Ωch?`,
                            async () => {
                                await db.tasks.clear();
                                
                                const cleanedTasks = importedData.tasks.map(task => {
                                    const cleanTask = { ...task };
                                    delete cleanTask.id;
                                    return cleanTask;
                                });

                                await db.tasks.bulkAdd(cleanedTasks);
                                alert(`‚úÖ Import dokonƒçen! ${cleanedTasks.length} √∫kol≈Ø`);
                                displayTasks();
                            }
                        );
                    } else {
                        await db.tasks.clear();
                        const cleanedTasks = importedData.tasks.map(task => {
                            const cleanTask = { ...task };
                            delete cleanTask.id;
                            return cleanTask;
                        });
                        await db.tasks.bulkAdd(cleanedTasks);
                        alert(`‚úÖ Import dokonƒçen! ${cleanedTasks.length} √∫kol≈Ø`);
                        displayTasks();
                    }

                } catch (error) {
                    closeImportModal(); // Zav≈ô√≠t i p≈ôi chybƒõ
                    alert(`‚ùå Chyba p≈ôi importu: ${error.message}`);
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // === SMAZ√ÅN√ç DOKONƒåEN√ùCH ===
        async function clearAllCompleted() {
            try {
                const completed = await db.tasks.where('isCompleted').equals(true).toArray();
                
                if (completed.length === 0) {
                    alert('‚ÑπÔ∏è ≈Ω√°dn√© dokonƒçen√© √∫koly ke smaz√°n√≠');
                    return;
                }
                
                saveToHistory('clearCompleted', { tasks: completed });
                await db.tasks.where('isCompleted').equals(true).delete();
                displayTasks();
                alert(`‚úÖ Smaz√°no ${completed.length} √∫kol≈Ø`);
            } catch (error) {
                alert(`‚ùå Chyba: ${error.message}`);
            }
        }

        // Zav≈ôen√≠ mod√°l≈Ø kl√°vesou ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAddTaskModal();
                closeTaskModal();
                closeConfirmModal();
                closeExportModal();
                closeImportModal();
            }
        });

        // Potvrzen√≠ v mod√°lu kl√°vesou Enter
        document.getElementById('modalTaskName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTaskFromModal();
            }
        });

        // Spu≈°tƒõn√≠ p≈ôi naƒçten√≠
        window.onload = () => {
            displayTasks();
            updateUndoButton();
        };
    </script>
</body>
</html>
