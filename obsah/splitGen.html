<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gener√°tor kru≈ænice s paprsky</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #e0e0e0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #404040;
        }

        .tab {
            padding: 12px 24px;
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 5px;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        .tab.active {
            background-color: #404040;
            color: #6aa6fd;
            border-color: #6aa6fd;
        }

        .tab:hover:not(.active) {
            background-color: #353535;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Generator Layout */
        .generator-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .controls {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
        }

        .preview {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #e0e0e0;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            background-color: #404040;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #6aa6fd;
        }

        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
            background-color: transparent;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #555;
            border-radius: 4px;
        }

        .color-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-group input[type="text"] {
            flex: 1;
        }

        .transparent-icon {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background-image: 
                linear-gradient(45deg, #888 25%, transparent 25%),
                linear-gradient(-45deg, #888 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #888 75%),
                linear-gradient(-45deg, transparent 75%, #888 75%);
            background-size: 10px 10px;
            background-position: 0 0, 0 5px, 5px -5px, -5px 0px;
            transition: opacity 0.3s;
            flex-shrink: 0;
        }

        .transparent-icon:hover {
            opacity: 0.7;
        }

        .input-with-unit-and-info {
            display: flex;
            flex-direction: column;
        }

        .input-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-line .control-input {
            flex-grow: 1;
        }

        .unit-text {
            color: #888;
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 40px;
            flex-shrink: 0;
        }

        .mm-info-inline {
            color: #888;
            font-size: 0.8rem;
            flex-shrink: 0;
            line-height: 40px;
        }

        .pattern-info-line {
            margin-top: 5px;
        }

        .control-button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            background-color: #6aa6fd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        button:hover {
            background-color: #5694f0;
        }

        button.export {
            background-color: #4caf50;
        }

        button.export:hover {
            background-color: #45a049;
        }

        button.delete-btn {
            background-color: #f44336;
        }

        button.delete-btn:hover {
            background-color: #d32f2f;
        }

        canvas {
            border: 1px solid #404040;
            max-width: 100%;
            background-image: repeating-conic-gradient(#333 0% 25%, transparent 0% 50%);
            background-size: 20px 20px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            gap: 10px;
            width: 100%;
        }

        .info {
            margin-top: 15px;
            font-size: 0.85rem;
            color: #888;
            text-align: center;
            line-height: 1.5;
        }

        #saveMessage {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #saveMessage.success {
            background-color: #4caf50;
            color: white;
            opacity: 1;
        }

        #saveMessage.error {
            background-color: #f44336;
            color: white;
            opacity: 1;
        }

        /* Gallery */
        #gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            min-height: 300px;
        }

        .gallery-item {
            background-color: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .gallery-item-content {
            width: 100%;
            height: 220px;
            background-image: repeating-conic-gradient(#333 0% 25%, transparent 0% 50%);
            background-size: 20px 20px;
            border: 1px solid #404040;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .gallery-item-content img,
        .gallery-item-content svg {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .gallery-item p {
            font-size: 0.85rem;
            color: #bbb;
            margin-bottom: 10px;
        }

        .gallery-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
        }

        .gallery-actions button {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        #gallery-placeholder {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 1rem;
        }

        .gallery-controls {
            text-align: center;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .generator-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.2rem;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .control-button-group {
                grid-template-columns: 1fr;
            }

            #gallery-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Gener√°tor kru≈ænice s paprsky</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('generator')">‚öôÔ∏è Gener√°tor</div>
            <div class="tab" onclick="switchTab('gallery')">üñºÔ∏è Galerie</div>
        </div>

        <div id="generator" class="tab-content active">
            <div class="generator-container">
                <div class="controls">
                    <div class="form-group">
                        <label for="circleDiameters">Pr≈Ømƒõry kru≈ænic (oddƒõlen√© ƒç√°rkou):</label>
                        <div class="input-with-unit-and-info">
                            <div class="input-line">
                                <input type="text" id="circleDiameters" class="control-input" value="100,150,200">
                                <span class="unit-text">px</span>
                                <div class="mm-info-inline" id="maxDiameterMm">
                                    (‚âà 52.9 mm)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="numRays">Poƒçet paprsk≈Ø:</label>
                        <input type="number" id="numRays" min="1" max="100" value="12">
                    </div>
                    
                    <div class="form-group">
                        <label for="circleColor">Barva kru≈ænice:</label>
                        <div class="color-group">
                            <input type="color" id="circleColor" value="#000000">
                            <input type="text" id="circleColorHex" value="#000000">
                            <div class="transparent-icon" title="Nastavit pr≈Øhlednou kru≈ænici" onclick="setTransparentCircle()"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rayColor">Barva paprsk≈Ø:</label>
                        <div class="color-group">
                            <input type="color" id="rayColor" value="#000000">
                            <input type="text" id="rayColorHex" value="#000000">
                            <div class="transparent-icon" title="Nastavit pr≈Øhledn√© paprsky" onclick="setTransparentRays()"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="backgroundColor">Barva pozad√≠:</label>
                        <div class="color-group">
                            <input type="color" id="backgroundColor" value="#ffffff">
                            <input type="text" id="backgroundColorHex" value="#ffffff">
                            <div class="transparent-icon" title="Nastavit pr≈Øhledn√© pozad√≠" onclick="setTransparentBackground()"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="circleThickness">Tlou≈°≈•ka kru≈ænice:</label>
                        <div class="input-with-unit-and-info">
                            <div class="input-line">
                                <input type="number" id="circleThickness" class="control-input" min="1" max="50" value="3">
                                <span class="unit-text">px</span>
                                <div class="mm-info-inline" id="circleThicknessMm">
                                    (‚âà 0.8 mm)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rayThickness">Tlou≈°≈•ka paprsk≈Ø:</label>
                        <div class="input-with-unit-and-info">
                            <div class="input-line">
                                <input type="number" id="rayThickness" class="control-input" min="1" max="50" value="2">
                                <span class="unit-text">px</span>
                                <div class="mm-info-inline" id="rayThicknessMm">
                                    (‚âà 0.5 mm)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="canvasSize">Velikost pl√°tna:</label>
                        <div class="input-with-unit-and-info">
                            <div class="input-line">
                                <input type="number" id="canvasSize" class="control-input" min="100" max="2000" value="800">
                                <span class="unit-text">px</span>
                                <div class="mm-info-inline" id="canvasSizeMm">
                                    (‚âà 211.7 mm)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="paddingPx">Okrajov√© odsazen√≠:</label>
                        <div class="input-with-unit-and-info">
                            <div class="input-line">
                                <input type="number" id="paddingPx" class="control-input" min="0" max="100" value="20">
                                <span class="unit-text">px</span>
                                <div class="mm-info-inline" id="paddingPxMm">
                                    (‚âà 5.3 mm)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-button-group">
                        <button id="generateBtn">Generovat</button>
                        <button id="randomizeBtn">N√°hodn√© barvy</button>
                    </div>
                    
                    <div class="info">
                        Nastaven√≠ se automaticky ukl√°daj√≠. Prav√Ω klik na "Ulo≈æit do Galerie" ulo≈æ√≠ SVG.
                    </div>
                </div>
                
                <div class="preview">
                    <canvas id="canvas" width="800" height="800"></canvas>
                    
                    <div class="button-group">
                        <button id="saveGalleryBtn">üñºÔ∏è Ulo≈æit do Galerie (PNG)</button>
                    </div>
                    
                    <div id="saveMessage"></div>
                    
                    <div class="button-group">
                        <button id="downloadPngBtn" class="export">St√°hnout PNG</button>
                        <button id="downloadSvgBtn" class="export">St√°hnout SVG (mm)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="gallery" class="tab-content">
            <div id="gallery-container">
                <p id="gallery-placeholder">Zat√≠m nebyly ulo≈æeny ≈æ√°dn√© obr√°zky. Ulo≈æte si prvn√≠ obr√°zek pomoc√≠ tlaƒç√≠tka "Ulo≈æit do Galerie (PNG)".</p>
            </div>
            <div class="gallery-controls">
                <button class="delete-btn" onclick="clearGallery()">Vymazat celou galerii</button>
            </div>
        </div>
    </div>

    <script>
        // === KONSTANTY ===
        const PIXELS_PER_MM = 3.779527559;
        const STORAGE_KEY = 'circleRaysGeneratorSettings';
        const GALLERY_KEY = 'circleRaysGallery';
        const RAY_START_OFFSET = 20; // Paprsky zaƒç√≠naj√≠ 20px od st≈ôedu
        const CENTER_DOT_SIZE = 1; // Velikost st≈ôedov√©ho bodu v px

        // === ELEMENTY ===
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const generateBtn = document.getElementById('generateBtn');
        const randomizeBtn = document.getElementById('randomizeBtn');
        const saveGalleryBtn = document.getElementById('saveGalleryBtn');
        const downloadPngBtn = document.getElementById('downloadPngBtn');
        const downloadSvgBtn = document.getElementById('downloadSvgBtn');
        const galleryContainer = document.getElementById('gallery-container');
        const galleryPlaceholder = document.getElementById('gallery-placeholder');
        const saveMessage = document.getElementById('saveMessage');

        // Vstupn√≠ prvky
        const circleDiametersInput = document.getElementById('circleDiameters');
        const numRaysInput = document.getElementById('numRays');
        const circleColorInput = document.getElementById('circleColor');
        const circleColorHexInput = document.getElementById('circleColorHex');
        const rayColorInput = document.getElementById('rayColor');
        const rayColorHexInput = document.getElementById('rayColorHex');
        const backgroundColorInput = document.getElementById('backgroundColor');
        const backgroundColorHexInput = document.getElementById('backgroundColorHex');
        const circleThicknessInput = document.getElementById('circleThickness');
        const rayThicknessInput = document.getElementById('rayThickness');
        const canvasSizeInput = document.getElementById('canvasSize');
        const paddingPxInput = document.getElementById('paddingPx');

        // Elementy pro zobrazen√≠ p≈ôepoƒçtu na mm
        const maxDiameterMm = document.getElementById('maxDiameterMm');
        const circleThicknessMm = document.getElementById('circleThicknessMm');
        const rayThicknessMm = document.getElementById('rayThicknessMm');
        const canvasSizeMm = document.getElementById('canvasSizeMm');
        const paddingPxMm = document.getElementById('paddingPxMm');

        // Seznam v≈°ech input≈Ø
        const settingsInputs = [
            circleDiametersInput,
            numRaysInput,
            circleColorInput,
            rayColorInput,
            backgroundColorInput,
            circleThicknessInput,
            rayThicknessInput,
            canvasSizeInput,
            paddingPxInput
        ];

        // P≈ôevod mm na pixely (p≈ôi 72 DPI: 1mm = 2.8346456692913px)
        function mmToPx(mm) {
            return mm * 2.8346456692913;
        }

        // P≈ôevod pixel≈Ø na mm
        function pxToMm(px) {
            return px / 2.8346456692913;
        }

        // Funkce pro parsov√°n√≠ pr≈Ømƒõr≈Ø kru≈ænic
        function parseDiameters(input) {
            return input.split(',')
                .map(val => val.trim())
                .filter(val => val !== '')
                .map(val => parseInt(val))
                .filter(val => !isNaN(val) && val > 0);
        }

        // Funkce pro aktualizaci zobrazen√≠ p≈ôepoƒçtu na mm
        function updateMmConversions() {
            const diameters = parseDiameters(circleDiametersInput.value);
            const maxDiameter = diameters.length > 0 ? Math.max(...diameters) : 0;
            
            maxDiameterMm.textContent = `(‚âà ${pxToMm(maxDiameter).toFixed(1)} mm)`;
            circleThicknessMm.textContent = `(‚âà ${pxToMm(parseInt(circleThicknessInput.value) || 3).toFixed(1)} mm)`;
            rayThicknessMm.textContent = `(‚âà ${pxToMm(parseInt(rayThicknessInput.value) || 2).toFixed(1)} mm)`;
            canvasSizeMm.textContent = `(‚âà ${pxToMm(parseInt(canvasSizeInput.value) || 800).toFixed(1)} mm)`;
            paddingPxMm.textContent = `(‚âà ${pxToMm(parseInt(paddingPxInput.value) || 20).toFixed(1)} mm)`;
        }

        // Synchronizace color pickeru a textov√©ho inputu pro barvy
        function syncColorInputs(colorInput, hexInput) {
            colorInput.addEventListener('input', function() {
                hexInput.value = this.value.toUpperCase();
                drawPattern();
            });

            hexInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.toLowerCase() === 'transparent') {
                    drawPattern();
                } else if (/^#[0-9A-F]{6}$/i.test(value)) {
                    colorInput.value = value.toUpperCase();
                    drawPattern();
                }
            });
        }

        // Nastaven√≠ synchronizace pro v≈°echny barvy
        syncColorInputs(circleColorInput, circleColorHexInput);
        syncColorInputs(rayColorInput, rayColorHexInput);
        syncColorInputs(backgroundColorInput, backgroundColorHexInput);

        // Funkce pro nastaven√≠ pr≈Øhledn√Ωch barev
        function setTransparentCircle() {
            circleColorHexInput.value = 'transparent';
            drawPattern();
        }
        window.setTransparentCircle = setTransparentCircle;

        function setTransparentRays() {
            rayColorHexInput.value = 'transparent';
            drawPattern();
        }
        window.setTransparentRays = setTransparentRays;

        function setTransparentBackground() {
            backgroundColorHexInput.value = 'transparent';
            drawPattern();
        }
        window.setTransparentBackground = setTransparentBackground;

        // Zobrazen√≠ doƒçasn√© zpr√°vy
        let messageTimeout;
        function showTemporaryMessage(message, type) {
            clearTimeout(messageTimeout);
            saveMessage.textContent = message;
            saveMessage.className = '';
            saveMessage.classList.add(type);
            messageTimeout = setTimeout(() => {
                saveMessage.classList.remove('success', 'error');
            }, 3000);
        }

        // ≈ò√≠zen√≠ z√°lo≈æek
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick*="'${tabName}'"]`).classList.add('active');
            if (tabName === 'gallery') {
                renderGallery();
            }
        }

        window.clearGallery = function() {
            if (confirm("Opravdu chcete VYMAZAT CELOU GALERII? Tuto akci nelze vr√°tit.")) {
                localStorage.removeItem(GALLERY_KEY);
                renderGallery();
                showTemporaryMessage('üóëÔ∏è Galerie byla vymaz√°na.', 'success');
            }
        }

        // Z√≠sk√°n√≠ parametr≈Ø
        function getParams() {
            const diameters = parseDiameters(circleDiametersInput.value);
            
            return {
                circleDiameters: diameters,
                maxDiameter: diameters.length > 0 ? Math.max(...diameters) : 0,
                numRays: parseInt(numRaysInput.value),
                circleColor: circleColorHexInput.value.toLowerCase() === 'transparent' ? 'transparent' : circleColorInput.value.toUpperCase(),
                rayColor: rayColorHexInput.value.toLowerCase() === 'transparent' ? 'transparent' : rayColorInput.value.toUpperCase(),
                backgroundColor: backgroundColorHexInput.value.toLowerCase() === 'transparent' ? 'transparent' : backgroundColorInput.value.toUpperCase(),
                circleThickness: parseInt(circleThicknessInput.value),
                rayThickness: parseInt(rayThicknessInput.value),
                canvasSize: parseInt(canvasSizeInput.value),
                paddingPx: parseInt(paddingPxInput.value)
            };
        }

        // Ulo≈æen√≠ nastaven√≠
        function saveSettings() {
            const settings = {};
            settingsInputs.forEach(input => {
                settings[input.id] = input.value;
            });
            // Ulo≈æit tak√© hex hodnoty
            settings.circleColorHex = circleColorHexInput.value;
            settings.rayColorHex = rayColorHexInput.value;
            settings.backgroundColorHex = backgroundColorHexInput.value;
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn("Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠:", e);
            }
        }

        // Synchronizace barev po naƒçten√≠
        function syncColorsAfterLoad() {
            // Synchronizace kru≈ænice
            const circleColor = circleColorInput.value;
            circleColorHexInput.value = circleColor.toUpperCase();
            
            // Synchronizace paprsk≈Ø
            const rayColor = rayColorInput.value;
            rayColorHexInput.value = rayColor.toUpperCase();
            
            // Synchronizace pozad√≠
            const bgHex = backgroundColorHexInput.value;
            if (bgHex.toLowerCase() !== 'transparent') {
                backgroundColorInput.value = bgHex.toUpperCase();
            }
        }

        // Naƒçten√≠ nastaven√≠
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(STORAGE_KEY);
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    settingsInputs.forEach(input => {
                        if (settings[input.id] !== undefined) {
                            input.value = settings[input.id];
                        }
                    });
                    // Naƒç√≠st hex hodnoty
                    if (settings.circleColorHex) circleColorHexInput.value = settings.circleColorHex;
                    if (settings.rayColorHex) rayColorHexInput.value = settings.rayColorHex;
                    if (settings.backgroundColorHex) backgroundColorHexInput.value = settings.backgroundColorHex;
                    
                    syncColorsAfterLoad();
                    return;
                }
            } catch (e) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:", e);
            }
            syncColorsAfterLoad();
        }

        // Galerie
        function getGalleryItems() {
            try {
                const stored = localStorage.getItem(GALLERY_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ galerie:", e);
                return [];
            }
        }

        function saveImageToGallery(type, data, currentParams) {
            const items = getGalleryItems();
            const paramsToSave = { ...currentParams };
            const newItem = {
                id: Date.now(),
                type: type,
                data: data,
                timestamp: new Date().toLocaleString(),
                params: paramsToSave
            };
            try {
                const newItemSize = JSON.stringify(newItem).length;
                if (localStorage.length > 5 * 1024 * 1024 - newItemSize) {
                    showTemporaryMessage('üíæ Lok√°ln√≠ √∫lo≈æi≈°tƒõ je pln√©!', 'error');
                    return;
                }
                items.push(newItem);
                localStorage.setItem(GALLERY_KEY, JSON.stringify(items));
                showTemporaryMessage(`üñºÔ∏è Ulo≈æeno (${type.toUpperCase()})!`, 'success');
            } catch (e) {
                showTemporaryMessage('üíæ Chyba p≈ôi ukl√°d√°n√≠ do galerie!', 'error');
                console.error("Chyba p≈ôi ukl√°d√°n√≠ do galerie:", e);
            }
        }

        function deleteGalleryItem(id) {
            if (confirm("Opravdu chcete tento obr√°zek smazat z galerie?")) {
                const items = getGalleryItems().filter(item => item.id !== id);
                localStorage.setItem(GALLERY_KEY, JSON.stringify(items));
                renderGallery();
            }
        }

        function downloadSvgFromGallery(item) {
            const params = { ...item.params };
            if (!params) {
                alert("Chyb√≠ parametry pro regeneraci SVG.");
                return;
            }
            const svgContent = generateSvgContent(params);
            downloadFile(svgContent, `kruznice_s_paprsky_mm_${item.id}.svg`, 'image/svg+xml');
        }

        function renderGallery() {
            const items = getGalleryItems().reverse();
            galleryContainer.innerHTML = '';
            if (items.length === 0) {
                galleryContainer.appendChild(galleryPlaceholder);
                galleryPlaceholder.style.display = 'block';
                return;
            }
            galleryPlaceholder.style.display = 'none';
            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'gallery-item-content';
                if (item.params && item.params.backgroundColor && item.params.backgroundColor.toLowerCase() !== 'transparent') {
                    contentDiv.style.backgroundColor = item.params.backgroundColor;
                    contentDiv.style.backgroundImage = 'none';
                } else {
                    contentDiv.style.backgroundColor = 'transparent';
                }
                if (item.type === 'png') {
                    const img = document.createElement('img');
                    img.src = item.data;
                    img.alt = `PNG obrazec z ${item.timestamp}`;
                    contentDiv.appendChild(img);
                } else if (item.type === 'svg') {
                    contentDiv.innerHTML = item.data.replace(/<svg /, '<svg style="max-width: 100%; max-height: 100%; display: block;" ');
                }
                const info = document.createElement('p');
                const circleColor = (item.params && item.params.circleColor) ? item.params.circleColor : '#000000';
                const rayColor = (item.params && item.params.rayColor) ? item.params.rayColor : '#000000';
                const bgColor = (item.params && item.params.backgroundColor) ? item.params.backgroundColor : 'transparent';
                const diameters = (item.params && item.params.circleDiameters) ? item.params.circleDiameters.join(', ') : 'N/A';
                info.innerHTML = `<strong>Pr≈Ømƒõry:</strong> ${diameters} px<br>
                                  <strong>Paprsky:</strong> ${item.params.numRays || 'N/A'}<br>
                                  <strong>Barvy:</strong> <span style="color: ${circleColor};">kru≈ænice</span> / 
                                  <span style="color: ${rayColor};">paprsky</span> / 
                                  <span style="color: ${bgColor === 'transparent' ? '#ccc' : bgColor};">pozad√≠</span>`;
                itemDiv.appendChild(contentDiv);
                itemDiv.appendChild(info);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'gallery-actions';
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Smazat';
                deleteBtn.onclick = () => deleteGalleryItem(item.id);
                const downloadOriginalBtn = document.createElement('button');
                downloadOriginalBtn.className = 'export';
                downloadOriginalBtn.textContent = `St√°hnout (${item.type.toUpperCase()})`;
                downloadOriginalBtn.onclick = () => {
                    if (item.type === 'png') {
                        downloadFile(item.data, `kruznice_s_paprsky_${item.id}.png`, 'image/png');
                    } else if (item.type === 'svg') {
                        downloadFile(item.data, `kruznice_s_paprsky_mm_${item.id}.svg`, 'image/svg+xml');
                    }
                };
                const downloadSvgRegenBtn = document.createElement('button');
                downloadSvgRegenBtn.className = 'export svg-regen-btn';
                downloadSvgRegenBtn.textContent = `SVG (Regen)`;
                downloadSvgRegenBtn.onclick = () => downloadSvgFromGallery(item);
                actionsDiv.appendChild(deleteBtn);
                actionsDiv.appendChild(downloadOriginalBtn);
                if (item.params) {
                    actionsDiv.appendChild(downloadSvgRegenBtn);
                }
                itemDiv.appendChild(actionsDiv);
                galleryContainer.appendChild(itemDiv);
            });
        }

        // Kreslen√≠ vzoru
        function drawPattern() {
            const params = getParams();
            canvas.width = params.canvasSize;
            canvas.height = params.canvasSize;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Vykreslen√≠ pozad√≠
            if (params.backgroundColor.toLowerCase() !== 'transparent') {
                ctx.fillStyle = params.backgroundColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            const paddingPx = Math.max(0, params.paddingPx);
            const availableSize = Math.max(1, params.canvasSize - 2 * paddingPx);
            const centerX = params.canvasSize / 2;
            const centerY = params.canvasSize / 2;
            
            // Vykreslen√≠ v≈°ech kru≈ænic
            if (params.circleColor.toLowerCase() !== 'transparent' && params.circleDiameters.length > 0) {
                for (const diameterPx of params.circleDiameters) {
                    const scaleFactor = (diameterPx > 0) ? Math.min(1, availableSize / diameterPx) : 1;
                    const radiusPx = (diameterPx / 2) * scaleFactor;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radiusPx, 0, Math.PI * 2);
                    ctx.lineWidth = params.circleThickness;
                    ctx.strokeStyle = params.circleColor;
                    ctx.stroke();
                }
            }
            
            // Vykreslen√≠ paprsk≈Ø
            if (params.rayColor.toLowerCase() !== 'transparent' && params.numRays > 0) {
                const angleStep = (2 * Math.PI) / params.numRays;
                // Polomƒõr pro paprsky - od st≈ôedu a≈æ k okraji pl√°tna (s ohledem na odsazen√≠)
                const maxRayLength = Math.min(centerX - paddingPx, centerY - paddingPx);
                
                for (let i = 0; i < params.numRays; i++) {
                    const angle = i * angleStep;
                    const startX = centerX + RAY_START_OFFSET * Math.cos(angle);
                    const startY = centerY + RAY_START_OFFSET * Math.sin(angle);
                    const endX = centerX + maxRayLength * Math.cos(angle);
                    const endY = centerY + maxRayLength * Math.sin(angle);
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.lineWidth = params.rayThickness;
                    ctx.strokeStyle = params.rayColor;
                    ctx.stroke();
                }
            }
            
            // Vykreslen√≠ st≈ôedov√©ho bodu
            if (params.rayColor.toLowerCase() !== 'transparent') {
                ctx.beginPath();
                ctx.arc(centerX, centerY, CENTER_DOT_SIZE, 0, Math.PI * 2);
                ctx.fillStyle = params.rayColor;
                ctx.fill();
            }
            
            saveSettings();
            updateMmConversions();
        }

        function downloadFile(data, filename, mimeType) {
            const link = document.createElement('a');
            link.download = filename;
            if (mimeType === 'image/png') {
                link.href = data;
            } else {
                const blob = new Blob([data], { type: mimeType });
                link.href = URL.createObjectURL(blob);
            }
            link.click();
            if (mimeType !== 'image/png' && link.href) {
                URL.revokeObjectURL(link.href);
            }
        }

        function generateSvgContent(params) {
            const canvasSize_px = params.canvasSize;
            const paddingPx = Math.max(0, params.paddingPx);
            
            // P≈ôevod na mm
            const pxToMm = (px) => px / 2.8346456692913;
            const canvasSize_mm = pxToMm(canvasSize_px);
            const padding_mm = pxToMm(paddingPx);
            const centerX_mm = canvasSize_mm / 2;
            const centerY_mm = canvasSize_mm / 2;
            
            // Tlou≈°≈•ky ƒçar v mm
            const circleThickness_mm = pxToMm(params.circleThickness);
            const rayThickness_mm = pxToMm(params.rayThickness);
            
            // Maxim√°ln√≠ d√©lka paprsk≈Ø v mm (od st≈ôedu k okraji s ohledem na padding)
            const maxRayLength_mm = Math.min(centerX_mm - padding_mm, centerY_mm - padding_mm);
            
            // P≈ôevod RAY_START_OFFSET na mm
            const rayStartOffset_mm = pxToMm(RAY_START_OFFSET);
            
            // P≈ôevod st≈ôedov√©ho bodu na mm
            const centerDotSize_mm = pxToMm(CENTER_DOT_SIZE);
            
            let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${canvasSize_mm.toFixed(2)}mm" height="${canvasSize_mm.toFixed(2)}mm" viewBox="0 0 ${canvasSize_mm.toFixed(2)} ${canvasSize_mm.toFixed(2)}" xmlns="http://www.w3.org/2000/svg">`;
            
            // Pozad√≠
            if (params.backgroundColor.toLowerCase() !== 'transparent') {
                svgContent += `
  <rect width="100%" height="100%" fill="${params.backgroundColor}"/>`;
            }
            
            // V≈°echny kru≈ænice
            if (params.circleColor.toLowerCase() !== 'transparent' && params.circleDiameters.length > 0) {
                for (const diameterPx of params.circleDiameters) {
                    const availableSize_px = Math.max(1, canvasSize_px - 2 * paddingPx);
                    const scaleFactor = (diameterPx > 0) ? Math.min(1, availableSize_px / diameterPx) : 1;
                    const radiusPx = (diameterPx / 2) * scaleFactor;
                    const radius_mm = pxToMm(radiusPx);
                    
                    svgContent += `
  <circle cx="${centerX_mm.toFixed(2)}" cy="${centerY_mm.toFixed(2)}" r="${radius_mm.toFixed(2)}" 
          stroke="${params.circleColor}" stroke-width="${circleThickness_mm.toFixed(2)}" fill="none"/>`;
                }
            }
            
            // Paprsky
            if (params.rayColor.toLowerCase() !== 'transparent' && params.numRays > 0) {
                const angleStep = (2 * Math.PI) / params.numRays;
                
                for (let i = 0; i < params.numRays; i++) {
                    const angle = i * angleStep;
                    const startX_mm = centerX_mm + rayStartOffset_mm * Math.cos(angle);
                    const startY_mm = centerY_mm + rayStartOffset_mm * Math.sin(angle);
                    const endX_mm = centerX_mm + maxRayLength_mm * Math.cos(angle);
                    const endY_mm = centerY_mm + maxRayLength_mm * Math.sin(angle);
                    
                    svgContent += `
  <line x1="${startX_mm.toFixed(2)}" y1="${startY_mm.toFixed(2)}" x2="${endX_mm.toFixed(2)}" y2="${endY_mm.toFixed(2)}" 
        stroke="${params.rayColor}" stroke-width="${rayThickness_mm.toFixed(2)}"/>`;
                }
            }
            
            // St≈ôedov√Ω bod
            if (params.rayColor.toLowerCase() !== 'transparent') {
                svgContent += `
  <circle cx="${centerX_mm.toFixed(2)}" cy="${centerY_mm.toFixed(2)}" r="${centerDotSize_mm.toFixed(2)}" 
          fill="${params.rayColor}"/>`;
            }
            
            svgContent += '\n</svg>';
            return svgContent;
        }

        // N√°hodn√© barvy
        function randomizeColors() {
            const randomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            
            circleColorInput.value = randomColor();
            circleColorHexInput.value = circleColorInput.value.toUpperCase();
            
            rayColorInput.value = randomColor();
            rayColorHexInput.value = rayColorInput.value.toUpperCase();
            
            backgroundColorInput.value = randomColor();
            backgroundColorHexInput.value = backgroundColorInput.value.toUpperCase();
            
            drawPattern();
        }

        // Event listenery
        generateBtn.addEventListener('click', drawPattern);
        randomizeBtn.addEventListener('click', randomizeColors);
        downloadPngBtn.addEventListener('click', () => {
            const dataUrl = canvas.toDataURL('image/png');
            downloadFile(dataUrl, 'kruznice_s_paprsky.png', 'image/png');
        });
        downloadSvgBtn.addEventListener('click', () => {
            const svgContent = generateSvgContent(getParams());
            downloadFile(svgContent, 'kruznice_s_paprsky_mm.svg', 'image/svg+xml');
        });
        saveGalleryBtn.addEventListener('click', () => {
            const params = getParams();
            const dataUrl = canvas.toDataURL('image/png');
            saveImageToGallery('png', dataUrl, params);
        });
        saveGalleryBtn.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const params = getParams();
            const svgContent = generateSvgContent(params);
            saveImageToGallery('svg', svgContent, params);
        });

        // Automatick√© p≈ôekreslen√≠ p≈ôi zmƒõnƒõ vstup≈Ø
        settingsInputs.forEach(input => {
            input.addEventListener('input', () => {
                drawPattern();
                updateMmConversions();
            });
        });

        // Inicializace
        window.addEventListener('load', () => {
            loadSettings();
            updateMmConversions();
            drawPattern();
        });
    </script>
</body>
</html>