<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•æ Spr√°vce pƒõ≈°√≠ch tras v7.0</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3Byw6F2Y2UgdHJhcyIsInNob3J0X25hbWUiOiJUcmFzeSIsImRlc2NyaXB0aW9uIjoiU3Byw6F2Y2UgcMSbc8OtY2ggdHJhcyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwZjFhIiwidGhlbWVfY29sb3IiOiIjMTBiOTgxIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnPjx0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnPvCfpb48L3RleHQ+PC9zdmc+Iiwic2l6ZXMiOiI5Nng5NiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #34d399;
            --primary-glow: rgba(16, 185, 129, 0.3);
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --info: #3b82f6;
            --info-light: #60a5fa;
            --warning: #f97316;
            --bg-deep: #0a0f1a;
            --bg-dark: #111827;
            --bg-card: #1f2937;
            --bg-elevated: #374151;
            --bg-glass: rgba(31, 41, 55, 0.95);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: rgba(75, 85, 99, 0.5);
            --border-light: rgba(107, 114, 128, 0.3);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 20px var(--primary-glow);
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }

        .container { display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform var(--transition-slow);
            position: relative;
            z-index: 100;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), transparent, var(--primary));
            opacity: 0.3;
        }

        .sidebar-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-dark) 100%);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: var(--shadow-glow);
        }

        .logo h1 { font-size: 15px; font-weight: 600; }
        .logo span { display: block; font-size: 9px; font-weight: 400; color: var(--text-muted); }

        .offline-badge {
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 8px;
            margin-left: 8px;
            display: none;
        }

        .offline-badge.show { display: inline; }

        /* Edit Mode Banner */
        .edit-mode-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 8px 14px;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 500;
            animation: pulse 2s infinite;
        }

        .edit-mode-banner.active { display: flex; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .edit-mode-banner button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-family: inherit;
        }

        /* Search Box */
        .search-box { position: relative; margin-bottom: 12px; }

        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            transition: all var(--transition-normal);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 160px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .search-results.show { display: block; }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            font-size: 11px;
        }

        .search-result-item:hover { background: var(--bg-elevated); }
        .search-result-item strong { color: var(--primary-light); }

        /* Tabs */
        .tabs { display: flex; gap: 3px; margin-bottom: 12px; }

        .tab {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            font-family: inherit;
            border-radius: 6px;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .tab:hover { background: var(--bg-elevated); color: var(--text-primary); }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Color Controls */
        .color-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }

        .color-item {
            background: var(--bg-card);
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .color-item label { font-size: 9px; color: var(--text-muted); display: block; margin-bottom: 4px; }

        .color-item input[type="color"] {
            width: 100%;
            height: 22px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: none;
        }

        /* Checkboxes */
        .display-options {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .checkbox-label:last-child { margin-bottom: 0; }

        .checkbox-label input[type="checkbox"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 3px;
            margin-right: 8px;
            cursor: pointer;
            position: relative;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .checkbox-label input[type="checkbox"]:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox-label input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        /* Speed Profile Select */
        .speed-profile-group {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .speed-profile-group label {
            font-size: 10px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 6px;
        }

        .speed-profile-group select {
            width: 100%;
            padding: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }

        /* Buttons */
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 8px; }
        .btn-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid-4 { grid-template-columns: repeat(4, 1fr); }

        .btn {
            padding: 8px 10px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            font-family: inherit;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn:hover { background: var(--bg-card); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
        }

        .btn-primary:hover { box-shadow: var(--shadow-glow); }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            border-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #ea580c 100%);
            border-color: var(--warning);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
            border-color: var(--info);
            color: white;
        }

        .btn-small { padding: 5px 8px; font-size: 9px; }

        /* Routes List */
        .routes-list { flex: 1; overflow-y: auto; padding: 0 16px 16px; }

        .empty-state { text-align: center; padding: 30px 16px; color: var(--text-muted); }
        .empty-state i { font-size: 36px; margin-bottom: 12px; opacity: 0.3; }
        .empty-state p { font-size: 11px; line-height: 1.6; }

        .route-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .route-item:hover { border-color: var(--primary); transform: translateX(3px); }
        .route-item.selected { border-color: var(--primary); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%); }
        .route-item.editing { border-color: var(--accent); box-shadow: 0 0 12px rgba(245, 158, 11, 0.3); }

        .route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .route-name { font-weight: 600; color: var(--primary-light); font-size: 12px; }

        .route-badges { display: flex; gap: 4px; }
        .route-badge { background: var(--bg-elevated); padding: 2px 6px; border-radius: 3px; font-size: 8px; color: var(--text-muted); }
        .route-badge.editing { background: var(--accent); color: white; }

        .route-info { font-size: 10px; color: var(--text-secondary); display: flex; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
        .route-info span { display: flex; align-items: center; gap: 3px; }

        .route-actions { display: flex; gap: 4px; flex-wrap: wrap; }

        .point-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 8px;
            margin: 5px 0;
            font-size: 10px;
            transition: all var(--transition-fast);
        }

        .point-item:hover { border-color: var(--primary); }

        .point-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }

        .point-number {
            background: var(--primary);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            margin-right: 5px;
        }

        .point-name { font-weight: 500; color: var(--text-primary); }
        .point-coords { font-size: 9px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .point-meta { font-size: 9px; color: var(--accent); margin-top: 2px; }
        .point-actions { display: flex; gap: 3px; margin-top: 5px; flex-wrap: wrap; }

        /* Map Container */
        .map-container { flex: 1; position: relative; display: flex; flex-direction: column; }
        #map { width: 100%; flex: 1; z-index: 1; }

        /* Elevation Chart */
        .elevation-panel {
            height: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            overflow: hidden;
            transition: height var(--transition-slow);
        }

        .elevation-panel.show { height: 150px; }

        .elevation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        .elevation-header span { font-size: 11px; font-weight: 500; }

        .elevation-stats {
            display: flex;
            gap: 16px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .elevation-stats strong { color: var(--primary-light); }

        .elevation-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
        }

        #elevationChart {
            width: 100%;
            height: 100px;
        }

        /* Layer Switcher */
        .layer-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .layer-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all var(--transition-normal);
            color: var(--text-secondary);
        }

        .layer-btn:hover {
            background: var(--bg-card);
            border-color: var(--primary);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .layer-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .layer-btn i { font-size: 16px; }
        .layer-btn span { font-size: 7px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Floating Buttons */
        .floating-btns {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .float-btn {
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
        }

        .float-btn:hover { background: var(--bg-card); transform: scale(1.05); }
        .float-btn.hidden { display: none; }

        /* Info Panel */
        .info-panel {
            background: var(--bg-card);
            padding: 10px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }

        .info-panel span { display: flex; align-items: center; gap: 4px; }

        /* Notification */
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 5000;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transform: translateX(120%);
            transition: transform var(--transition-slow);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            max-width: 280px;
        }

        .notification.show { transform: translateX(0); }
        .notification.success { border-color: var(--primary); }
        .notification.warning { border-color: var(--warning); }
        .notification.error { border-color: var(--danger); }
        .notification.info { border-color: var(--info); }

        .notification-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon { background: var(--primary); }
        .notification.warning .notification-icon { background: var(--warning); }
        .notification.error .notification-icon { background: var(--danger); }
        .notification.info .notification-icon { background: var(--info); }

        /* Modal Dialogs */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .modal-overlay.show { display: flex; opacity: 1; }

        .modal {
            background: linear-gradient(145deg, var(--bg-card) 0%, var(--bg-dark) 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0;
            max-width: 480px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9) translateY(20px);
            transition: transform var(--transition-slow);
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.show .modal { transform: scale(1) translateY(0); }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }

        .modal-body { padding: 24px; }

        .modal-hint {
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent);
            padding: 12px 14px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .modal-hint strong { color: var(--accent); display: block; margin-bottom: 4px; }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all var(--transition-normal);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-textarea { min-height: 100px; resize: vertical; }

        .modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-btn-secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .modal-btn-secondary:hover { background: var(--bg-card); }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
        }

        .modal-btn-primary:hover { box-shadow: var(--shadow-glow); transform: translateY(-2px); }

        .modal-btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            border: none;
            color: white;
        }

        /* Confirm Modal */
        .confirm-modal .modal-body { text-align: center; padding: 30px 24px; }

        .confirm-modal .confirm-icon {
            width: 64px;
            height: 64px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
            color: var(--danger);
        }

        .confirm-modal .confirm-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .confirm-modal .confirm-message { font-size: 13px; color: var(--text-secondary); }
        .confirm-modal .modal-footer { justify-content: center; }

        /* Stats Grid */
        .stats-grid-modal {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card-modal {
            background: var(--bg-elevated);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value-modal {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-light);
        }

        .stat-label-modal {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Icon Picker */
        .icon-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-elevated);
            border-radius: 10px;
        }

        .icon-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition-fast);
        }

        .icon-option:hover { border-color: var(--primary); transform: scale(1.1); }
        .icon-option.selected { border-color: var(--primary); background: var(--primary); color: white; }

        /* Share URL Input */
        .share-url-container {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .share-url-container input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }

        .share-url-container button {
            padding: 10px 16px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
        }

        /* Mobile */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 2000;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            width: 42px;
            height: 42px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
        }

        .shortcut-hint {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 9px;
            color: var(--text-muted);
            z-index: 100;
        }

        .shortcut-hint kbd {
            background: var(--bg-elevated);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
        }

        @media (max-width: 768px) {
            .mobile-toggle { display: flex; align-items: center; justify-content: center; }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 1500;
                transform: translateX(-100%);
            }

            .sidebar.open { transform: translateX(0); }
            .sidebar-header { padding: 56px 14px 14px; }
            .shortcut-hint { display: none; }
            .layer-switcher { top: 60px; }
            .modal { width: 95%; max-height: 90vh; overflow-y: auto; }
            .icon-picker { grid-template-columns: repeat(6, 1fr); }
        }

        /* Leaflet Customization */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .leaflet-popup-tip { background: var(--bg-card); }
        .leaflet-popup-content { font-family: 'Poppins', sans-serif; font-size: 11px; margin: 10px 12px; }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            box-shadow: var(--shadow-lg);
        }

        .install-prompt.show { display: flex; }

        .install-prompt button {
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .install-prompt .install-btn {
            background: var(--primary);
            color: white;
        }

        .install-prompt .dismiss-btn {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars" id="menuIcon"></i>
    </button>

    <div class="notification" id="notification">
        <div class="notification-icon"><i class="fas fa-check"></i></div>
        <span></span>
    </div>

    <div class="install-prompt" id="installPrompt">
        <span>üì± Nainstalovat aplikaci?</span>
        <button class="install-btn" onclick="installApp()">Instalovat</button>
        <button class="dismiss-btn" onclick="dismissInstall()">Ne</button>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> <span id="editModalTitle">Upravit</span></h3>
                <button class="modal-close" onclick="routeManager.closeModal('editModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" id="editModalLabel">N√°zev</label>
                    <input type="text" class="form-input" id="editModalInput" placeholder="Zadejte hodnotu...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="routeManager.closeModal('editModal')">Zru≈°it</button>
                <button class="modal-btn modal-btn-primary" onclick="routeManager.confirmEdit()"><i class="fas fa-check"></i> Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal-overlay" id="notesModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-sticky-note"></i> Pozn√°mka k bodu</h3>
                <button class="modal-close" onclick="routeManager.closeModal('notesModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-hint">
                    <strong>üí° Tip</strong>
                    M≈Ø≈æete sem napsat zaj√≠mavosti, instrukce nebo cokoliv d≈Øle≈æit√©ho o tomto m√≠stƒõ.
                </div>
                <div class="form-group">
                    <label class="form-label">Pozn√°mka</label>
                    <textarea class="form-input form-textarea" id="notesModalInput" placeholder="Napi≈°te pozn√°mku..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="routeManager.closeModal('notesModal')">Zru≈°it</button>
                <button class="modal-btn modal-btn-primary" onclick="routeManager.confirmNotes()"><i class="fas fa-check"></i> Ulo≈æit</button>
            </div>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div class="modal-overlay" id="iconModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-icons"></i> Vybrat ikonu</h3>
                <button class="modal-close" onclick="routeManager.closeModal('iconModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="icon-picker" id="iconPicker"></div>
            </div>
        </div>
    </div>

    <!-- Coordinate Modal -->
    <div class="modal-overlay" id="coordModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> P≈ôidat ze sou≈ôadnic</h3>
                <button class="modal-close" onclick="routeManager.closeModal('coordModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-hint">
                    <strong>üìç Podporovan√© form√°ty</strong>
                    49.7437, 15.3386 &nbsp;nebo&nbsp; 49¬∞44'37"N 15¬∞20'19"E
                </div>
                <div class="form-group">
                    <label class="form-label">Zemƒõpisn√° ≈°√≠≈ôka (Latitude)</label>
                    <input type="text" class="form-input" id="coordLatInput" placeholder="49.7437">
                </div>
                <div class="form-group">
                    <label class="form-label">Zemƒõpisn√° d√©lka (Longitude)</label>
                    <input type="text" class="form-input" id="coordLngInput" placeholder="15.3386">
                </div>
                <div class="form-group">
                    <label class="form-label">N√°zev bodu (voliteln√©)</label>
                    <input type="text" class="form-input" id="coordNameInput" placeholder="Automaticky z mapy">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="routeManager.closeModal('coordModal')">Zru≈°it</button>
                <button class="modal-btn modal-btn-primary" onclick="routeManager.addPointFromCoordinates()"><i class="fas fa-plus"></i> P≈ôidat bod</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-modal">
            <div class="modal-body">
                <div class="confirm-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="confirm-title" id="confirmTitle">Smazat?</div>
                <div class="confirm-message" id="confirmMessage">Tato akce je nevratn√°.</div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="routeManager.closeModal('confirmModal')">Zru≈°it</button>
                <button class="modal-btn modal-btn-danger" id="confirmBtn" onclick="routeManager.confirmAction()"><i class="fas fa-trash"></i> Smazat</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Statistiky</h3>
                <button class="modal-close" onclick="routeManager.closeModal('statsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="stats-grid-modal">
                    <div class="stat-card-modal">
                        <div class="stat-value-modal" id="statRoutes">0</div>
                        <div class="stat-label-modal">Tras celkem</div>
                    </div>
                    <div class="stat-card-modal">
                        <div class="stat-value-modal" id="statPoints">0</div>
                        <div class="stat-label-modal">Bod≈Ø celkem</div>
                    </div>
                    <div class="stat-card-modal">
                        <div class="stat-value-modal" id="statDistance">0</div>
                        <div class="stat-label-modal">Km celkem</div>
                    </div>
                    <div class="stat-card-modal">
                        <div class="stat-value-modal" id="statTime">0</div>
                        <div class="stat-label-modal">ƒåas (dle profilu)</div>
                    </div>
                </div>
                <div class="btn-grid btn-grid-2">
                    <button class="btn btn-primary" onclick="routeManager.exportGPX(); routeManager.closeModal('statsModal');"><i class="fas fa-download"></i> Export GPX</button>
                    <button class="btn btn-info" onclick="routeManager.exportKML(); routeManager.closeModal('statsModal');"><i class="fas fa-globe"></i> Export KML</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-share-alt"></i> Sd√≠let trasu</h3>
                <button class="modal-close" onclick="routeManager.closeModal('shareModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-hint">
                    <strong>üîó Sd√≠len√≠ p≈ôes URL</strong>
                    Zkop√≠rujte odkaz a po≈°lete ho kamar√°d≈Øm. Trasa se naƒçte automaticky.
                </div>
                <div class="share-url-container">
                    <input type="text" id="shareUrlInput" readonly>
                    <button onclick="routeManager.copyShareUrl()"><i class="fas fa-copy"></i> Kop√≠rovat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Image Modal -->
    <div class="modal-overlay" id="exportImageModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-image"></i> Export obr√°zku</h3>
                <button class="modal-close" onclick="routeManager.closeModal('exportImageModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-hint">
                    <strong>üñºÔ∏è Form√°t exportu</strong>
                    Vyberte form√°t pro export aktu√°ln√≠ho zobrazen√≠ mapy.
                </div>
                <div class="btn-grid btn-grid-2" style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="routeManager.exportToPNG()"><i class="fas fa-file-image"></i> PNG obr√°zek</button>
                    <button class="btn btn-danger" onclick="routeManager.exportToPDF()"><i class="fas fa-file-pdf"></i> PDF dokument</button>
                </div>
                <p style="font-size: 10px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                    Export m≈Ø≈æe trvat nƒõkolik sekund...
                </p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="edit-mode-banner" id="editModeBanner">
                <span><i class="fas fa-edit"></i> √öpravy: <strong id="editingRouteName"></strong></span>
                <button onclick="routeManager.stopEditing()">Ukonƒçit</button>
            </div>

            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ü•æ</div>
                    <h1>Spr√°vce tras <span>v7.0</span></h1>
                    <span class="offline-badge" id="offlineBadge">OFFLINE</span>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="placeSearch" placeholder="Vyhledat m√≠sto...">
                    <div class="search-results" id="searchResults"></div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="routes"><i class="fas fa-route"></i> Trasy</button>
                    <button class="tab" data-tab="settings"><i class="fas fa-cog"></i> Nastaven√≠</button>
                </div>

                <div class="tab-content active" id="routes-tab">
                    <div class="btn-grid">
                        <button class="btn btn-primary" id="newRoute"><i class="fas fa-plus"></i> Nov√°</button>
                        <button class="btn btn-warning" id="optimizeRoute"><i class="fas fa-magic"></i> Optim.</button>
                        <button class="btn" id="addCurrentLocation"><i class="fas fa-crosshairs"></i> GPS</button>
                    </div>

                    <div class="btn-grid">
                        <button class="btn btn-info" id="addFromCoordinates"><i class="fas fa-map-marker-alt"></i> Sou≈ôadnice</button>
                        <button class="btn" id="exportData"><i class="fas fa-download"></i> JSON</button>
                        <button class="btn" id="importData"><i class="fas fa-upload"></i> Import</button>
                    </div>

                    <div class="btn-grid btn-grid-4">
                        <button class="btn btn-danger" id="clearAll"><i class="fas fa-trash"></i></button>
                        <button class="btn" id="showStats"><i class="fas fa-chart-bar"></i></button>
                        <button class="btn" id="showElevation"><i class="fas fa-mountain"></i></button>
                        <button class="btn" id="exportImage"><i class="fas fa-camera"></i></button>
                    </div>
                </div>

                <div class="tab-content" id="settings-tab">
                    <div class="color-group">
                        <div class="color-item">
                            <label><i class="fas fa-map-pin"></i> Body</label>
                            <input type="color" id="pointColor" value="#10b981">
                        </div>
                        <div class="color-item">
                            <label><i class="fas fa-route"></i> Trasa</label>
                            <input type="color" id="lineColor" value="#fbbf24">
                        </div>
                        <div class="color-item">
                            <label><i class="fas fa-font"></i> Text</label>
                            <input type="color" id="distanceColor" value="#ffffff">
                        </div>
                    </div>

                    <div class="speed-profile-group">
                        <label><i class="fas fa-tachometer-alt"></i> Profil rychlosti</label>
                        <select id="speedProfile">
                            <option value="3">üö∂ Pomal√° ch≈Øze (3 km/h)</option>
                            <option value="5" selected>üö∂‚Äç‚ôÇÔ∏è Bƒõ≈æn√° ch≈Øze (5 km/h)</option>
                            <option value="6">ü•æ Turistika (6 km/h)</option>
                            <option value="10">üèÉ Bƒõh (10 km/h)</option>
                            <option value="15">üö¥ Kolo (15 km/h)</option>
                            <option value="25">üö¥‚Äç‚ôÇÔ∏è Rychl√© kolo (25 km/h)</option>
                        </select>
                    </div>

                    <div class="display-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showDistances" checked>
                            Zobrazit vzd√°lenosti na mapƒõ
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="showNotes">
                            Zobrazit pozn√°mky na mapƒõ
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="draggableMarkers">
                            P≈ôetahovateln√© body (drag & drop)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="insertMode">
                            Re≈æim vkl√°d√°n√≠ (klik na linii)
                        </label>
                    </div>

                    <div class="btn-grid btn-grid-2">
                        <button class="btn" id="fitAllRoutes"><i class="fas fa-expand"></i> Zobrazit v≈°e</button>
                        <button class="btn btn-info" id="centerCzech"><i class="fas fa-flag"></i> ƒåR</button>
                    </div>
                </div>
            </div>

            <div class="routes-list" id="routesList">
                <div class="empty-state">
                    <i class="fas fa-hiking"></i>
                    <p>≈Ω√°dn√© trasy.<br>Kliknƒõte <strong>Nov√°</strong>.</p>
                </div>
            </div>

            <div class="info-panel">
                <span><i class="fas fa-route"></i> <span id="totalRoutes">0</span> tras</span>
                <span><i class="fas fa-map-pin"></i> <span id="totalPoints">0</span> bod≈Ø</span>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="elevation-panel" id="elevationPanel">
                <div class="elevation-header">
                    <span><i class="fas fa-mountain"></i> V√Ω≈°kov√Ω profil</span>
                    <div class="elevation-stats" id="elevationStats"></div>
                    <button class="elevation-close" onclick="routeManager.hideElevation()"><i class="fas fa-times"></i></button>
                </div>
                <canvas id="elevationChart"></canvas>
            </div>

            <div class="layer-switcher">
                <button class="layer-btn active" data-layer="osm" title="OpenStreetMap">
                    <i class="fas fa-map"></i>
                    <span>Mapa</span>
                </button>
                <button class="layer-btn" data-layer="terrain" title="Turistick√°">
                    <i class="fas fa-mountain"></i>
                    <span>Teren</span>
                </button>
                <button class="layer-btn" data-layer="satellite" title="Satelitn√≠">
                    <i class="fas fa-satellite"></i>
                    <span>Satelit</span>
                </button>
                <button class="layer-btn" data-layer="dark" title="Tmav√°">
                    <i class="fas fa-moon"></i>
                    <span>Dark</span>
                </button>
            </div>

            <div class="floating-btns">
                <button class="float-btn" id="undoBtn" onclick="routeManager.undo()">
                    <i class="fas fa-undo"></i> Zpƒõt
                </button>
                <button class="float-btn" onclick="routeManager.showShareModal()" title="Sd√≠let trasu">
                    <i class="fas fa-share-alt"></i> Sd√≠let
                </button>
            </div>

            <div class="shortcut-hint">
                <kbd>N</kbd> Nov√° | <kbd>Z</kbd> Undo | <kbd>E</kbd> Elevace | <kbd>Esc</kbd> Konec
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ========== PWA / SERVICE WORKER ==========
        let deferredPrompt = null;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register inline service worker via blob
                const swCode = `
                    const CACHE_NAME = 'tripplanner-v7';
                    const ASSETS = [
                        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css',
                        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                        'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap'
                    ];

                    self.addEventListener('install', e => {
                        e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
                        self.skipWaiting();
                    });

                    self.addEventListener('fetch', e => {
                        if (e.request.url.includes('tile.openstreetmap.org') || 
                            e.request.url.includes('arcgisonline.com') ||
                            e.request.url.includes('opentopomap.org') ||
                            e.request.url.includes('cartocdn.com')) {
                            e.respondWith(
                                caches.open('map-tiles-v1').then(cache => 
                                    cache.match(e.request).then(cached => {
                                        const fetched = fetch(e.request).then(response => {
                                            if (response.ok) cache.put(e.request, response.clone());
                                            return response;
                                        }).catch(() => cached);
                                        return cached || fetched;
                                    })
                                )
                            );
                            return;
                        }
                        e.respondWith(
                            caches.match(e.request).then(cached => cached || fetch(e.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installPrompt').classList.remove('show');
        }

        window.addEventListener('online', () => document.getElementById('offlineBadge').classList.remove('show'));
        window.addEventListener('offline', () => document.getElementById('offlineBadge').classList.add('show'));
        if (!navigator.onLine) document.getElementById('offlineBadge').classList.add('show');

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('menuIcon');
            sidebar.classList.toggle('open');
            icon.className = sidebar.classList.contains('open') ? 'fas fa-times' : 'fas fa-bars';
        }

        // ========== WAYPOINT ICONS ==========
        const WAYPOINT_ICONS = [
            'fa-map-marker-alt', 'fa-flag', 'fa-star', 'fa-heart', 'fa-home', 'fa-camera',
            'fa-coffee', 'fa-utensils', 'fa-bed', 'fa-campground', 'fa-tree', 'fa-mountain',
            'fa-water', 'fa-parking', 'fa-gas-pump', 'fa-store', 'fa-church', 'fa-landmark',
            'fa-monument', 'fa-archway', 'fa-binoculars', 'fa-hiking', 'fa-bicycle', 'fa-car',
            'fa-bus', 'fa-train', 'fa-plane', 'fa-ship', 'fa-anchor', 'fa-umbrella-beach',
            'fa-swimmer', 'fa-fish', 'fa-paw', 'fa-leaf', 'fa-seedling', 'fa-apple-alt',
            'fa-wine-glass', 'fa-beer', 'fa-ice-cream', 'fa-cookie', 'fa-first-aid', 'fa-restroom',
            'fa-info-circle', 'fa-exclamation-triangle', 'fa-question-circle', 'fa-phone', 'fa-wifi', 'fa-bolt'
        ];

        class WalkingRouteManager {
            constructor() {
                this.routes = [];
                this.editingRouteId = null;
                this.selectedRouteId = null;
                this.undoStack = [];
                this.maxUndoSteps = 20;
                
                this.currentPointColor = '#10b981';
                this.currentLineColor = '#fbbf24';
                this.currentDistanceColor = '#ffffff';
                this.showDistances = true;
                this.showNotes = false;
                this.draggableMarkers = false;
                this.insertMode = false;
                this.speedProfile = 5;
                
                this.pendingEditCallback = null;
                this.pendingConfirmCallback = null;
                this.pendingIconCallback = null;
                this.saveThrottleTimer = null;
                this.elevationCache = new Map();
                
                this.settings = {
                    pointColor: '#10b981',
                    lineColor: '#fbbf24',
                    distanceColor: '#ffffff',
                    showDistances: true,
                    showNotes: false,
                    draggableMarkers: false,
                    speedProfile: 5,
                    mapLayer: 'osm',
                    mapCenter: [49.8175, 15.4730],
                    mapZoom: 8
                };

                this.initMap();
                this.loadFromStorage();
                this.checkUrlParams();
                this.restoreRoutes();
                this.restoreUISettings();
                this.restoreMapView();
                this.setupEventListeners();
                this.initIconPicker();
                this.updateUI();
            }

            // ========== HELPER METHODS ==========
            renumberPoints(route) {
                route.points.forEach((p, idx) => {
                    const nameParts = p.name.split('. ');
                    p.name = nameParts.length > 1 ? `${idx + 1}. ${nameParts.slice(1).join('. ')}` : `Bod ${idx + 1}`;
                });
            }

            formatTime(distanceKm) {
                const hours = distanceKm / this.speedProfile;
                const totalMinutes = Math.round(hours * 60);
                if (totalMinutes < 60) return `${totalMinutes} min`;
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                return `${h}h ${m}m`;
            }

            // ========== ICON PICKER ==========
            initIconPicker() {
                const picker = document.getElementById('iconPicker');
                picker.innerHTML = WAYPOINT_ICONS.map(icon => 
                    `<div class="icon-option" data-icon="${icon}"><i class="fas ${icon}"></i></div>`
                ).join('');

                picker.addEventListener('click', (e) => {
                    const option = e.target.closest('.icon-option');
                    if (option && this.pendingIconCallback) {
                        picker.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.pendingIconCallback(option.dataset.icon);
                        this.closeModal('iconModal');
                    }
                });
            }

            showIconPicker(currentIcon, callback) {
                this.pendingIconCallback = callback;
                const picker = document.getElementById('iconPicker');
                picker.querySelectorAll('.icon-option').forEach(o => {
                    o.classList.toggle('selected', o.dataset.icon === currentIcon);
                });
                this.openModal('iconModal');
            }

            // ========== ELEVATION PROFILE ==========
            async fetchElevation(route) {
                if (route.points.length < 2) return null;
                
                const cacheKey = route.points.map(p => `${p.lat.toFixed(4)},${p.lng.toFixed(4)}`).join('|');
                if (this.elevationCache.has(cacheKey)) {
                    return this.elevationCache.get(cacheKey);
                }

                try {
                    // Using Open-Meteo API (free, no key required)
                    const lats = route.points.map(p => p.lat.toFixed(4)).join(',');
                    const lngs = route.points.map(p => p.lng.toFixed(4)).join(',');
                    
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/elevation?latitude=${lats}&longitude=${lngs}`
                    );
                    
                    if (!response.ok) throw new Error('Elevation API error');
                    
                    const data = await response.json();
                    const elevations = data.elevation || [];
                    
                    this.elevationCache.set(cacheKey, elevations);
                    return elevations;
                } catch (error) {
                    console.warn('Elevation fetch failed:', error);
                    return null;
                }
            }

            async showElevation() {
                const route = this.routes.find(r => r.id === this.selectedRouteId);
                if (!route || route.points.length < 2) {
                    this.showNotification('Vyberte trasu s alespo≈à 2 body', 'warning');
                    return;
                }

                this.showNotification('Naƒç√≠t√°m v√Ω≈°kov√Ω profil...', 'info');
                
                const elevations = await this.fetchElevation(route);
                if (!elevations || elevations.length === 0) {
                    this.showNotification('Nepoda≈ôilo se naƒç√≠st v√Ω≈°kov√° data', 'error');
                    return;
                }

                // Calculate stats
                let totalAscent = 0, totalDescent = 0;
                const minElev = Math.min(...elevations);
                const maxElev = Math.max(...elevations);
                
                for (let i = 1; i < elevations.length; i++) {
                    const diff = elevations[i] - elevations[i-1];
                    if (diff > 0) totalAscent += diff;
                    else totalDescent += Math.abs(diff);
                }

                document.getElementById('elevationStats').innerHTML = `
                    <span>‚Üë <strong>${Math.round(totalAscent)} m</strong></span>
                    <span>‚Üì <strong>${Math.round(totalDescent)} m</strong></span>
                    <span>Min: <strong>${Math.round(minElev)} m</strong></span>
                    <span>Max: <strong>${Math.round(maxElev)} m</strong></span>
                `;

                this.drawElevationChart(route, elevations);
                document.getElementById('elevationPanel').classList.add('show');
            }

            drawElevationChart(route, elevations) {
                const canvas = document.getElementById('elevationChart');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = 100;
                
                const padding = { top: 10, right: 10, bottom: 20, left: 40 };
                const width = canvas.width - padding.left - padding.right;
                const height = canvas.height - padding.top - padding.bottom;
                
                // Calculate cumulative distances
                const distances = [0];
                for (let i = 1; i < route.points.length; i++) {
                    const d = this.calculateDistance(
                        route.points[i-1].lat, route.points[i-1].lng,
                        route.points[i].lat, route.points[i].lng
                    );
                    distances.push(distances[i-1] + d);
                }
                const totalDist = distances[distances.length - 1];
                
                const minElev = Math.min(...elevations) - 10;
                const maxElev = Math.max(...elevations) + 10;
                const elevRange = maxElev - minElev || 1;
                
                // Clear canvas
                ctx.fillStyle = '#1f2937';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw grid
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding.top + (height / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(canvas.width - padding.right, y);
                    ctx.stroke();
                }
                
                // Draw elevation profile (filled)
                ctx.beginPath();
                ctx.moveTo(padding.left, padding.top + height);
                
                elevations.forEach((elev, i) => {
                    const x = padding.left + (distances[i] / totalDist) * width;
                    const y = padding.top + height - ((elev - minElev) / elevRange) * height;
                    if (i === 0) ctx.lineTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                ctx.lineTo(padding.left + width, padding.top + height);
                ctx.closePath();
                
                const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + height);
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Draw line
                ctx.beginPath();
                elevations.forEach((elev, i) => {
                    const x = padding.left + (distances[i] / totalDist) * width;
                    const y = padding.top + height - ((elev - minElev) / elevRange) * height;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw labels
                ctx.fillStyle = '#9ca3af';
                ctx.font = '9px Poppins';
                ctx.textAlign = 'right';
                ctx.fillText(`${Math.round(maxElev)} m`, padding.left - 5, padding.top + 10);
                ctx.fillText(`${Math.round(minElev)} m`, padding.left - 5, padding.top + height);
                
                ctx.textAlign = 'center';
                ctx.fillText('0 km', padding.left, canvas.height - 5);
                ctx.fillText(`${totalDist.toFixed(1)} km`, canvas.width - padding.right, canvas.height - 5);
            }

            hideElevation() {
                document.getElementById('elevationPanel').classList.remove('show');
            }

            // ========== EXPORT TO PNG/PDF ==========
            async exportToPNG() {
                this.showNotification('Generuji PNG...', 'info');
                this.closeModal('exportImageModal');
                
                try {
                    const mapContainer = document.getElementById('map');
                    const canvas = await html2canvas(mapContainer, {
                        useCORS: true,
                        allowTaint: true,
                        scale: 2
                    });
                    
                    const link = document.createElement('a');
                    link.download = `mapa-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showNotification('PNG exportov√°n!', 'success');
                } catch (error) {
                    this.showNotification('Chyba p≈ôi exportu: ' + error.message, 'error');
                }
            }

            async exportToPDF() {
                this.showNotification('Generuji PDF...', 'info');
                this.closeModal('exportImageModal');
                
                try {
                    const mapContainer = document.getElementById('map');
                    const canvas = await html2canvas(mapContainer, {
                        useCORS: true,
                        allowTaint: true,
                        scale: 2
                    });
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height + 100]
                    });
                    
                    // Add title
                    pdf.setFontSize(20);
                    pdf.text('Mapa tras', 20, 40);
                    
                    // Add date
                    pdf.setFontSize(12);
                    pdf.text(`Vygenerov√°no: ${new Date().toLocaleDateString('cs-CZ')}`, 20, 60);
                    
                    // Add map image
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 80, canvas.width, canvas.height);
                    
                    // Add route info
                    const route = this.routes.find(r => r.id === this.selectedRouteId);
                    if (route) {
                        const distance = this.getRouteDistance(route);
                        pdf.setFontSize(10);
                        pdf.text(`Trasa: ${route.name} | ${route.points.length} bod≈Ø | ${distance.toFixed(2)} km`, 20, canvas.height + 95);
                    }
                    
                    pdf.save(`mapa-${new Date().toISOString().split('T')[0]}.pdf`);
                    this.showNotification('PDF exportov√°n!', 'success');
                } catch (error) {
                    this.showNotification('Chyba p≈ôi exportu: ' + error.message, 'error');
                }
            }

            // ========== MODAL SYSTEM ==========
            openModal(id) {
                document.getElementById(id).classList.add('show');
                setTimeout(() => {
                    const input = document.querySelector(`#${id} .form-input`);
                    if (input) input.focus();
                }, 100);
            }

            closeModal(id) {
                document.getElementById(id).classList.remove('show');
                this.pendingEditCallback = null;
                this.pendingConfirmCallback = null;
                this.pendingIconCallback = null;
            }

            closeAllModals() {
                ['editModal', 'notesModal', 'coordModal', 'confirmModal', 'statsModal', 'shareModal', 'iconModal', 'exportImageModal'].forEach(id => {
                    document.getElementById(id).classList.remove('show');
                });
            }

            showEditModal(title, label, currentValue, callback) {
                document.getElementById('editModalTitle').textContent = title;
                document.getElementById('editModalLabel').textContent = label;
                document.getElementById('editModalInput').value = currentValue || '';
                this.pendingEditCallback = callback;
                this.openModal('editModal');
            }

            confirmEdit() {
                const value = document.getElementById('editModalInput').value.trim();
                if (this.pendingEditCallback && value) {
                    this.pendingEditCallback(value);
                }
                this.closeModal('editModal');
            }

            showNotesModal(currentNotes, callback) {
                document.getElementById('notesModalInput').value = currentNotes || '';
                this.pendingEditCallback = callback;
                this.openModal('notesModal');
            }

            confirmNotes() {
                const value = document.getElementById('notesModalInput').value;
                if (this.pendingEditCallback) {
                    this.pendingEditCallback(value);
                }
                this.closeModal('notesModal');
            }

            showConfirmModal(title, message, callback) {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                this.pendingConfirmCallback = callback;
                this.openModal('confirmModal');
            }

            confirmAction() {
                if (this.pendingConfirmCallback) {
                    this.pendingConfirmCallback();
                }
                this.closeModal('confirmModal');
            }

            showStatsModal() {
                const totalRoutes = this.routes.length;
                const totalPoints = this.routes.reduce((sum, r) => sum + r.points.length, 0);
                const totalDistance = this.routes.reduce((sum, r) => sum + this.getRouteDistance(r), 0);

                document.getElementById('statRoutes').textContent = totalRoutes;
                document.getElementById('statPoints').textContent = totalPoints;
                document.getElementById('statDistance').textContent = totalDistance.toFixed(1);
                document.getElementById('statTime').textContent = this.formatTime(totalDistance);

                this.openModal('statsModal');
            }

            showCoordinateDialog() {
                if (!this.editingRouteId) {
                    this.showNotification('Nejprve aktivujte re≈æim √∫prav trasy', 'warning');
                    return;
                }
                document.getElementById('coordLatInput').value = '';
                document.getElementById('coordLngInput').value = '';
                document.getElementById('coordNameInput').value = '';
                this.openModal('coordModal');
            }

            // ========== SHARE SYSTEM ==========
            showShareModal() {
                const route = this.routes.find(r => r.id === this.selectedRouteId);
                if (!route || route.points.length === 0) {
                    this.showNotification('Vyberte trasu s body pro sd√≠len√≠', 'warning');
                    return;
                }

                const shareData = this.encodeRouteForUrl(route);
                const url = `${window.location.origin}${window.location.pathname}?route=${shareData}`;
                document.getElementById('shareUrlInput').value = url;
                this.openModal('shareModal');
            }

            encodeRouteForUrl(route) {
                const data = {
                    n: route.name,
                    c: [route.pointColor, route.lineColor],
                    p: route.points.map(pt => [
                        Math.round(pt.lat * 1e6) / 1e6,
                        Math.round(pt.lng * 1e6) / 1e6,
                        pt.name.split('. ').slice(1).join('. ') || '',
                        pt.icon || ''
                    ])
                };
                return btoa(encodeURIComponent(JSON.stringify(data)));
            }

            decodeRouteFromUrl(encoded) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(encoded)));
                    return {
                        id: Date.now(),
                        name: data.n || 'Sd√≠len√° trasa',
                        points: data.p.map((pt, idx) => ({
                            id: Date.now() + Math.random(),
                            name: pt[2] ? `${idx + 1}. ${pt[2]}` : `Bod ${idx + 1}`,
                            lat: pt[0],
                            lng: pt[1],
                            created: new Date().toISOString(),
                            notes: '',
                            icon: pt[3] || 'fa-map-marker-alt',
                            distanceFromPrev: 0
                        })),
                        markers: [],
                        polylines: [],
                        pointColor: data.c?.[0] || this.currentPointColor,
                        lineColor: data.c?.[1] || this.currentLineColor,
                        distanceColor: this.currentDistanceColor,
                        visible: true,
                        created: new Date().toISOString()
                    };
                } catch (e) {
                    return null;
                }
            }

            checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const routeData = params.get('route');
                if (routeData) {
                    const route = this.decodeRouteFromUrl(routeData);
                    if (route) {
                        this.routes.push(route);
                        this.recalculateDistances(route);
                        this.selectedRouteId = route.id;
                        this.showNotification('Sd√≠len√° trasa naƒçtena!', 'success');
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                }
            }

            copyShareUrl() {
                const input = document.getElementById('shareUrlInput');
                input.select();
                navigator.clipboard.writeText(input.value).then(() => {
                    this.showNotification('URL zkop√≠rov√°na!', 'success');
                }).catch(() => {
                    document.execCommand('copy');
                    this.showNotification('URL zkop√≠rov√°na!', 'success');
                });
            }

            // ========== UNDO SYSTEM ==========
            saveState(action) {
                const state = {
                    action,
                    timestamp: Date.now(),
                    routes: this.routes.map(r => ({
                        id: r.id,
                        name: r.name,
                        points: r.points.map(p => ({ ...p })),
                        pointColor: r.pointColor,
                        lineColor: r.lineColor,
                        distanceColor: r.distanceColor,
                        visible: r.visible,
                        created: r.created
                    })),
                    editingRouteId: this.editingRouteId,
                    selectedRouteId: this.selectedRouteId
                };
                
                this.undoStack.push(state);
                if (this.undoStack.length > this.maxUndoSteps) this.undoStack.shift();
                this.updateUndoButton();
            }

            undo() {
                if (this.undoStack.length === 0) {
                    this.showNotification('Nic k vr√°cen√≠', 'info');
                    return;
                }

                const state = this.undoStack.pop();
                
                this.routes.forEach(route => {
                    route.markers.forEach(m => this.map.removeLayer(m));
                    route.polylines.forEach(p => this.map.removeLayer(p));
                });

                this.routes = state.routes.map(r => ({ ...r, markers: [], polylines: [] }));
                this.editingRouteId = state.editingRouteId;
                this.selectedRouteId = state.selectedRouteId;

                this.restoreRoutes();
                this.updateUI();
                this.saveToStorage();
                this.updateUndoButton();
                this.showNotification(`Vr√°ceno: ${state.action}`, 'info');
            }

            updateUndoButton() {
                document.getElementById('undoBtn').classList.toggle('hidden', this.undoStack.length === 0);
            }

            // ========== MAP ==========
            initMap() {
                this.map = L.map('map', { zoomControl: true }).setView(this.settings.mapCenter, this.settings.mapZoom);

                this.layers = {
                    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' }),
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '¬© Esri' }),
                    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, attribution: '¬© OpenTopoMap' }),
                    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© CartoDB' })
                };

                this.currentLayer = this.layers[this.settings.mapLayer];
                this.currentLayer.addTo(this.map);
                this.updateLayerButtons();

                this.map.on('click', (e) => this.handleMapClick(e));
            }

            switchLayer(layerType) {
                this.map.removeLayer(this.currentLayer);
                this.currentLayer = this.layers[layerType];
                this.currentLayer.addTo(this.map);
                this.settings.mapLayer = layerType;
                this.updateLayerButtons();
                this.saveSettings();
            }

            updateLayerButtons() {
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.layer === this.settings.mapLayer);
                });
            }

            setupEventListeners() {
                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    });
                });

                // Layer buttons
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchLayer(btn.dataset.layer));
                });

                // Buttons
                document.getElementById('newRoute').addEventListener('click', () => this.createNewRoute());
                document.getElementById('clearAll').addEventListener('click', () => {
                    this.showConfirmModal('Vymazat v≈°echny trasy?', 'Tato akce sma≈æe v≈°echny ulo≈æen√© trasy.', () => this.clearAll());
                });
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('importData').addEventListener('click', () => this.importData());
                document.getElementById('optimizeRoute').addEventListener('click', () => this.optimizeCurrentRoute());
                document.getElementById('addCurrentLocation').addEventListener('click', () => this.addCurrentLocation());
                document.getElementById('addFromCoordinates').addEventListener('click', () => this.showCoordinateDialog());
                document.getElementById('fitAllRoutes').addEventListener('click', () => this.fitMapToAllRoutes());
                document.getElementById('showStats').addEventListener('click', () => this.showStatsModal());
                document.getElementById('showElevation').addEventListener('click', () => this.showElevation());
                document.getElementById('exportImage').addEventListener('click', () => this.openModal('exportImageModal'));
                document.getElementById('centerCzech').addEventListener('click', () => this.map.setView([49.8, 15.5], 7));

                // Colors
                ['pointColor', 'lineColor', 'distanceColor'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        this[`current${id.charAt(0).toUpperCase() + id.slice(1)}`] = e.target.value;
                        this.saveSettings();
                    });
                });

                // Speed Profile
                document.getElementById('speedProfile').addEventListener('change', (e) => {
                    this.speedProfile = parseFloat(e.target.value);
                    this.settings.speedProfile = this.speedProfile;
                    this.updateUI();
                    this.saveSettings();
                });

                // Checkboxes
                document.getElementById('showDistances').addEventListener('change', (e) => {
                    this.showDistances = e.target.checked;
                    this.saveSettings();
                    this.redrawAllRoutes();
                });
                document.getElementById('showNotes').addEventListener('change', (e) => {
                    this.showNotes = e.target.checked;
                    this.saveSettings();
                    this.redrawAllRoutes();
                });
                document.getElementById('draggableMarkers').addEventListener('change', (e) => {
                    this.draggableMarkers = e.target.checked;
                    this.saveSettings();
                    this.redrawAllRoutes();
                });
                document.getElementById('insertMode').addEventListener('change', (e) => {
                    this.insertMode = e.target.checked;
                    if (this.insertMode) this.showNotification('Kliknƒõte na linii pro vlo≈æen√≠ bodu', 'info');
                    this.redrawAllRoutes();
                });

                // Search
                let searchTimeout;
                document.getElementById('placeSearch').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    if (query.length >= 3) {
                        searchTimeout = setTimeout(() => this.searchPlaces(query), 300);
                    } else {
                        document.getElementById('searchResults').classList.remove('show');
                    }
                });

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.target.matches('input, textarea')) return;
                    
                    if (e.key.toLowerCase() === 'n') { e.preventDefault(); this.createNewRoute(); }
                    if (e.key.toLowerCase() === 'z' || (e.ctrlKey && e.key === 'z')) { e.preventDefault(); this.undo(); }
                    if (e.key.toLowerCase() === 'e') { e.preventDefault(); this.showElevation(); }
                    if (e.key === 'Escape') { this.stopEditing(); this.closeAllModals(); this.hideElevation(); }
                });

                // Enter key in modals
                document.getElementById('editModalInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.confirmEdit();
                });
                document.getElementById('coordLatInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') document.getElementById('coordLngInput').focus();
                });
                document.getElementById('coordLngInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.addPointFromCoordinates();
                });

                // Throttled map move save
                this.map.on('moveend', () => this.throttledSaveSettings());

                // Resize elevation chart
                window.addEventListener('resize', () => {
                    if (document.getElementById('elevationPanel').classList.contains('show')) {
                        const route = this.routes.find(r => r.id === this.selectedRouteId);
                        if (route && this.elevationCache.has(route.points.map(p => `${p.lat.toFixed(4)},${p.lng.toFixed(4)}`).join('|'))) {
                            const elevations = this.elevationCache.get(route.points.map(p => `${p.lat.toFixed(4)},${p.lng.toFixed(4)}`).join('|'));
                            this.drawElevationChart(route, elevations);
                        }
                    }
                });
            }

            throttledSaveSettings() {
                if (this.saveThrottleTimer) clearTimeout(this.saveThrottleTimer);
                this.saveThrottleTimer = setTimeout(() => this.saveSettings(), 500);
            }

            // ========== SEARCH ==========
            async searchPlaces(query) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=cz,sk`);
                    const results = await response.json();
                    
                    const container = document.getElementById('searchResults');
                    container.innerHTML = '';
                    
                    if (results.length > 0) {
                        results.forEach(result => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `<strong>${result.display_name.split(',')[0]}</strong><br><small>${result.display_name}</small>`;
                            item.addEventListener('click', () => {
                                this.map.setView([parseFloat(result.lat), parseFloat(result.lon)], 14);
                                container.classList.remove('show');
                                document.getElementById('placeSearch').value = '';
                                if (window.innerWidth <= 768) toggleMenu();
                            });
                            container.appendChild(item);
                        });
                        container.classList.add('show');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            // ========== ROUTE MANAGEMENT ==========
            handleMapClick(e) {
                if (!this.editingRouteId) {
                    this.showNotification('Vyberte trasu k √∫pravƒõ nebo vytvo≈ôte novou', 'warning');
                    return;
                }

                const route = this.routes.find(r => r.id === this.editingRouteId);
                if (!route) return;

                this.saveState('P≈ôid√°n√≠ bodu');
                this.addPointToRoute(route, e.latlng.lat, e.latlng.lng);
            }

            addPointToRoute(route, lat, lng, insertIndex = null) {
                const point = {
                    id: Date.now() + Math.random(),
                    name: `Bod ${route.points.length + 1}`,
                    lat,
                    lng,
                    created: new Date().toISOString(),
                    notes: '',
                    icon: 'fa-map-marker-alt',
                    distanceFromPrev: 0
                };

                if (insertIndex !== null && insertIndex >= 0 && insertIndex < route.points.length) {
                    route.points.splice(insertIndex, 0, point);
                    this.renumberPoints(route);
                } else {
                    route.points.push(point);
                }

                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
                this.reverseGeocode(lat, lng, point, route);
            }

            async reverseGeocode(lat, lng, point, route) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`);
                    const data = await response.json();
                    if (data.display_name) {
                        const name = data.display_name.split(',')[0].trim();
                        if (name) {
                            const idx = route.points.findIndex(p => p.id === point.id);
                            if (idx !== -1) {
                                point.name = `${idx + 1}. ${name}`;
                                this.updateUI();
                                this.saveToStorage();
                            }
                        }
                    }
                } catch (error) {}
            }

            recalculateDistances(route) {
                for (let i = 0; i < route.points.length; i++) {
                    if (i === 0) {
                        route.points[i].distanceFromPrev = 0;
                    } else {
                        const p1 = route.points[i - 1];
                        const p2 = route.points[i];
                        route.points[i].distanceFromPrev = this.calculateDistance(p1.lat, p1.lng, p2.lat, p2.lng);
                    }
                }
            }

            createNewRoute() {
                this.saveState('Vytvo≈ôen√≠ trasy');

                const route = {
                    id: Date.now(),
                    name: `Trasa ${this.routes.length + 1}`,
                    points: [],
                    markers: [],
                    polylines: [],
                    pointColor: this.currentPointColor,
                    lineColor: this.currentLineColor,
                    distanceColor: this.currentDistanceColor,
                    visible: true,
                    created: new Date().toISOString()
                };

                this.routes.push(route);
                this.editingRouteId = route.id;
                this.selectedRouteId = route.id;
                
                this.updateUI();
                this.updateEditModeBanner();
                this.saveToStorage();
                this.showNotification('Klikejte na mapu pro p≈ôid√°n√≠ bod≈Ø', 'success');
                
                if (window.innerWidth <= 768) toggleMenu();
            }

            startEditing(id) {
                this.editingRouteId = id;
                this.selectedRouteId = id;
                this.redrawAllRoutes();
                this.updateUI();
                this.updateEditModeBanner();
                this.showNotification('Re≈æim √∫prav aktivn√≠', 'info');
            }

            stopEditing() {
                this.editingRouteId = null;
                this.redrawAllRoutes();
                this.updateUI();
                this.updateEditModeBanner();
            }

            updateEditModeBanner() {
                const banner = document.getElementById('editModeBanner');
                const nameSpan = document.getElementById('editingRouteName');
                
                if (this.editingRouteId) {
                    const route = this.routes.find(r => r.id === this.editingRouteId);
                    if (route) {
                        nameSpan.textContent = route.name;
                        banner.classList.add('active');
                    }
                } else {
                    banner.classList.remove('active');
                }
            }

            selectRoute(id) {
                this.selectedRouteId = id;
                this.updateUI();
                
                const route = this.routes.find(r => r.id === id);
                if (route && route.points.length > 0) {
                    const bounds = L.latLngBounds(route.points.map(p => [p.lat, p.lng]));
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

            // ========== MARKERS ==========
            createMarkerForRoute(route, point) {
                const idx = route.points.findIndex(p => p.id === point.id);
                const isEditing = this.editingRouteId === route.id;
                const icon = point.icon || 'fa-map-marker-alt';
                
                const markerIcon = L.divIcon({
                    className: 'custom-div-marker',
                    html: `<div style="
                        background: ${route.pointColor};
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        color: white;
                        font-family: 'Font Awesome 6 Free';
                    "><i class="fas ${icon}"></i></div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([point.lat, point.lng], { 
                    icon: markerIcon, 
                    draggable: this.draggableMarkers && isEditing 
                })
                .bindPopup(`
                    <strong>${point.name}</strong><br>
                    <small style="font-family: 'JetBrains Mono';">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</small>
                    ${point.notes ? `<br><em style="color: #60a5fa;">${point.notes}</em>` : ''}
                    ${point.distanceFromPrev > 0 ? `<br><span style="color: #fbbf24;">üìè ${point.distanceFromPrev.toFixed(2)} km</span>` : ''}
                `)
                .addTo(this.map);

                if (this.draggableMarkers && isEditing) {
                    marker.on('dragstart', () => this.saveState('P≈ôesun bodu'));
                    marker.on('dragend', (e) => {
                        const newLatLng = e.target.getLatLng();
                        point.lat = newLatLng.lat;
                        point.lng = newLatLng.lng;
                        this.recalculateDistances(route);
                        this.redrawRoute(route);
                        this.updateUI();
                        this.saveToStorage();
                    });
                }

                route.markers.push(marker);
            }

            calculateRouteGeometry(route) {
                const coords = route.points.map(p => [p.lat, p.lng]);
                const isEditing = this.editingRouteId === route.id;
                
                const polyline = L.polyline(coords, {
                    color: route.lineColor,
                    weight: 4,
                    opacity: 0.9
                }).addTo(this.map);

                if (this.insertMode && isEditing) {
                    polyline.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        
                        let minDist = Infinity, insertIdx = 0;
                        for (let i = 0; i < route.points.length - 1; i++) {
                            const p1 = route.points[i], p2 = route.points[i + 1];
                            const dist = this.pointToSegmentDistance(e.latlng.lat, e.latlng.lng, p1.lat, p1.lng, p2.lat, p2.lng);
                            if (dist < minDist) { minDist = dist; insertIdx = i + 1; }
                        }

                        this.saveState('Vlo≈æen√≠ bodu');
                        this.addPointToRoute(route, e.latlng.lat, e.latlng.lng, insertIdx);
                        this.showNotification(`Bod vlo≈æen na pozici ${insertIdx + 1}`, 'success');
                    });
                }

                route.polylines.push(polyline);

                if (this.showDistances) {
                    for (let i = 1; i < route.points.length; i++) {
                        const p1 = route.points[i - 1];
                        const p2 = route.points[i];
                        const midLat = (p1.lat + p2.lat) / 2;
                        const midLng = (p1.lng + p2.lng) / 2;
                        const distance = this.calculateDistance(p1.lat, p1.lng, p2.lat, p2.lng);

                        const label = L.divIcon({
                            className: 'distance-label',
                            html: `<div style="
                                background: none;
                                color: ${route.distanceColor};
                                font-size: 11px;
                                font-weight: 500;
                                font-family: 'Poppins', sans-serif;
                                text-shadow: 0 0 3px #000, 0 0 3px #000;
                                white-space: nowrap;
                            ">${distance.toFixed(2)} km</div>`,
                            iconAnchor: [25, 10]
                        });

                        const labelMarker = L.marker([midLat, midLng], { icon: label, interactive: false }).addTo(this.map);
                        route.polylines.push(labelMarker);
                    }
                }
            }

            pointToSegmentDistance(px, py, x1, y1, x2, y2) {
                const A = px - x1, B = py - y1, C = x2 - x1, D = y2 - y1;
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = lenSq !== 0 ? dot / lenSq : -1;

                let xx, yy;
                if (param < 0) { xx = x1; yy = y1; }
                else if (param > 1) { xx = x2; yy = y2; }
                else { xx = x1 + param * C; yy = y1 + param * D; }

                return Math.sqrt((px - xx) ** 2 + (py - yy) ** 2);
            }

            redrawRoute(route) {
                route.markers.forEach(m => this.map.removeLayer(m));
                route.polylines.forEach(p => this.map.removeLayer(p));
                route.markers = [];
                route.polylines = [];

                if (route.visible) {
                    route.points.forEach(p => this.createMarkerForRoute(route, p));
                    if (route.points.length >= 2) this.calculateRouteGeometry(route);
                }
            }

            redrawAllRoutes() {
                this.routes.forEach(route => this.redrawRoute(route));
            }

            // ========== CALCULATIONS ==========
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            getRouteDistance(route) {
                return route.points.reduce((sum, p) => sum + (p.distanceFromPrev || 0), 0);
            }

            // ========== OPTIMIZATION ==========
            optimizeCurrentRoute() {
                const route = this.routes.find(r => r.id === this.selectedRouteId);
                if (!route || route.points.length < 3) {
                    this.showNotification('Vyberte trasu s alespo≈à 3 body', 'warning');
                    return;
                }

                this.saveState('Optimalizace');

                let improved = true;
                let iterations = 0;

                while (improved && iterations < 100) {
                    improved = false;
                    iterations++;

                    for (let i = 1; i < route.points.length - 2; i++) {
                        for (let j = i + 1; j < route.points.length - 1; j++) {
                            const d1 = this.calculateDistance(route.points[i-1].lat, route.points[i-1].lng, route.points[i].lat, route.points[i].lng) +
                                       this.calculateDistance(route.points[j].lat, route.points[j].lng, route.points[j+1].lat, route.points[j+1].lng);
                            const d2 = this.calculateDistance(route.points[i-1].lat, route.points[i-1].lng, route.points[j].lat, route.points[j].lng) +
                                       this.calculateDistance(route.points[i].lat, route.points[i].lng, route.points[j+1].lat, route.points[j+1].lng);

                            if (d2 < d1 - 0.001) {
                                const segment = route.points.slice(i, j + 1).reverse();
                                route.points.splice(i, j - i + 1, ...segment);
                                improved = true;
                            }
                        }
                    }
                }

                this.renumberPoints(route);
                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
                this.showNotification(`Optimalizov√°no (${iterations} iterac√≠)`, 'success');
            }

            // ========== POINT MANAGEMENT ==========
            renameRoute(id) {
                const route = this.routes.find(r => r.id === id);
                if (!route) return;

                this.showEditModal('P≈ôejmenovat trasu', 'N√°zev trasy', route.name, (newName) => {
                    this.saveState('P≈ôejmenov√°n√≠ trasy');
                    route.name = newName;
                    this.updateUI();
                    this.saveToStorage();
                });
            }

            editPointName(routeId, pointId) {
                const route = this.routes.find(r => r.id === routeId);
                if (!route) return;
                const point = route.points.find(p => p.id === pointId);
                if (!point) return;

                this.showEditModal('Upravit n√°zev bodu', 'N√°zev', point.name, (newName) => {
                    this.saveState('P≈ôejmenov√°n√≠ bodu');
                    point.name = newName;
                    this.redrawRoute(route);
                    this.updateUI();
                    this.saveToStorage();
                });
            }

            changePointIcon(routeId, pointId) {
                const route = this.routes.find(r => r.id === routeId);
                if (!route) return;
                const point = route.points.find(p => p.id === pointId);
                if (!point) return;

                this.showIconPicker(point.icon || 'fa-map-marker-alt', (newIcon) => {
                    this.saveState('Zmƒõna ikony');
                    point.icon = newIcon;
                    this.redrawRoute(route);
                    this.updateUI();
                    this.saveToStorage();
                    this.showNotification('Ikona zmƒõnƒõna', 'success');
                });
            }

            addPointNotes(routeId, pointId) {
                const route = this.routes.find(r => r.id === routeId);
                if (!route) return;
                const point = route.points.find(p => p.id === pointId);
                if (!point) return;

                this.showNotesModal(point.notes, (notes) => {
                    this.saveState('√öprava pozn√°mky');
                    point.notes = notes;
                    this.redrawRoute(route);
                    this.updateUI();
                    this.saveToStorage();
                });
            }

            removePointFromRoute(routeId, pointId) {
                this.showConfirmModal('Smazat bod?', 'Bod bude odstranƒõn z trasy.', () => {
                    const route = this.routes.find(r => r.id === routeId);
                    if (!route) return;

                    this.saveState('Smaz√°n√≠ bodu');
                    route.points = route.points.filter(p => p.id !== pointId);
                    this.renumberPoints(route);
                    this.recalculateDistances(route);
                    this.redrawRoute(route);
                    this.updateUI();
                    this.saveToStorage();
                });
            }

            movePointUp(routeId, pointId) {
                const route = this.routes.find(r => r.id === routeId);
                if (!route) return;
                const idx = route.points.findIndex(p => p.id === pointId);
                if (idx <= 0) return;

                this.saveState('P≈ôesun bodu');
                [route.points[idx - 1], route.points[idx]] = [route.points[idx], route.points[idx - 1]];
                this.renumberPoints(route);
                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
            }

            movePointDown(routeId, pointId) {
                const route = this.routes.find(r => r.id === routeId);
                if (!route) return;
                const idx = route.points.findIndex(p => p.id === pointId);
                if (idx < 0 || idx >= route.points.length - 1) return;

                this.saveState('P≈ôesun bodu');
                [route.points[idx], route.points[idx + 1]] = [route.points[idx + 1], route.points[idx]];
                this.renumberPoints(route);
                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
            }

            duplicateRoute(id) {
                const original = this.routes.find(r => r.id === id);
                if (!original) return;

                this.saveState('Duplikace');

                const newRoute = {
                    id: Date.now(),
                    name: `${original.name} (kopie)`,
                    points: original.points.map(p => ({ ...p, id: Date.now() + Math.random() })),
                    markers: [],
                    polylines: [],
                    pointColor: original.pointColor,
                    lineColor: original.lineColor,
                    distanceColor: original.distanceColor,
                    visible: true,
                    created: new Date().toISOString()
                };

                this.routes.push(newRoute);
                newRoute.points.forEach(p => this.createMarkerForRoute(newRoute, p));
                if (newRoute.points.length >= 2) this.calculateRouteGeometry(newRoute);
                this.updateUI();
                this.saveToStorage();
                this.showNotification('Trasa zkop√≠rov√°na', 'success');
            }

            reverseRoute(id) {
                const route = this.routes.find(r => r.id === id);
                if (!route || route.points.length < 2) return;

                this.saveState('Obr√°cen√≠ trasy');
                route.points.reverse();
                this.renumberPoints(route);
                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
                this.showNotification('Smƒõr obr√°cen', 'success');
            }

            toggleRouteVisibility(id) {
                const route = this.routes.find(r => r.id === id);
                if (!route) return;
                this.saveState('Zmƒõna viditelnosti');
                route.visible = !route.visible;
                this.redrawRoute(route);
                this.updateUI();
                this.saveToStorage();
            }

            deleteRoute(id) {
                this.showConfirmModal('Smazat trasu?', 'Cel√° trasa bude nen√°vratnƒõ smaz√°na.', () => {
                    this.saveState('Smaz√°n√≠ trasy');
                    const route = this.routes.find(r => r.id === id);
                    if (route) {
                        route.markers.forEach(m => this.map.removeLayer(m));
                        route.polylines.forEach(p => this.map.removeLayer(p));
                    }
                    this.routes = this.routes.filter(r => r.id !== id);
                    if (this.editingRouteId === id) this.editingRouteId = null;
                    if (this.selectedRouteId === id) this.selectedRouteId = null;
                    this.updateUI();
                    this.saveToStorage();
                    this.showNotification('Trasa smaz√°na', 'success');
                });
            }

            // ========== UI ==========
            updateUI() {
                const listContainer = document.getElementById('routesList');
                
                if (this.routes.length === 0) {
                    listContainer.innerHTML = `<div class="empty-state"><i class="fas fa-hiking"></i><p>≈Ω√°dn√© trasy.<br>Kliknƒõte <strong>Nov√°</strong>.</p></div>`;
                } else {
                    listContainer.innerHTML = '';
                    
                    this.routes.forEach(route => {
                        const isEditing = route.id === this.editingRouteId;
                        const isSelected = route.id === this.selectedRouteId;
                        const distance = this.getRouteDistance(route);
                        
                        const routeEl = document.createElement('div');
                        routeEl.className = `route-item ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`;
                        
                        routeEl.innerHTML = `
                            <div class="route-header">
                                <span class="route-name">${route.name}</span>
                                <div class="route-badges">
                                    ${isEditing ? '<span class="route-badge editing">EDIT</span>' : ''}
                                    <span class="route-badge">${route.visible ? 'üëÅ' : 'üö´'}</span>
                                </div>
                            </div>
                            <div class="route-info">
                                <span><i class="fas fa-map-pin"></i> ${route.points.length}</span>
                                <span><i class="fas fa-ruler"></i> ${distance.toFixed(2)} km</span>
                                <span><i class="fas fa-clock"></i> ${this.formatTime(distance)}</span>
                            </div>
                            <div class="route-actions">
                                <button class="btn btn-small ${isEditing ? 'btn-warning' : 'btn-primary'}" onclick="event.stopPropagation(); ${isEditing ? 'routeManager.stopEditing()' : `routeManager.startEditing(${route.id})`}" title="${isEditing ? 'Ukonƒçit' : 'Upravit'}">
                                    <i class="fas fa-${isEditing ? 'stop' : 'edit'}"></i>
                                </button>
                                <button class="btn btn-small" onclick="event.stopPropagation(); routeManager.renameRoute(${route.id})" title="P≈ôejmenovat"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-small" onclick="event.stopPropagation(); routeManager.duplicateRoute(${route.id})" title="Kop√≠rovat"><i class="fas fa-copy"></i></button>
                                <button class="btn btn-small" onclick="event.stopPropagation(); routeManager.reverseRoute(${route.id})" title="Obr√°tit"><i class="fas fa-exchange-alt"></i></button>
                                <button class="btn btn-small" onclick="event.stopPropagation(); routeManager.toggleRouteVisibility(${route.id})" title="Viditelnost"><i class="fas fa-${route.visible ? 'eye' : 'eye-slash'}"></i></button>
                                <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); routeManager.deleteRoute(${route.id})" title="Smazat"><i class="fas fa-trash"></i></button>
                            </div>
                        `;

                        routeEl.addEventListener('click', () => this.selectRoute(route.id));
                        listContainer.appendChild(routeEl);

                        // Points
                        if (isSelected && route.points.length > 0) {
                            route.points.forEach((point, idx) => {
                                const pointEl = document.createElement('div');
                                pointEl.className = 'point-item';
                                pointEl.innerHTML = `
                                    <div class="point-header">
                                        <span><span class="point-number">${idx + 1}</span><span class="point-name">${point.name}</span></span>
                                        <i class="fas ${point.icon || 'fa-map-marker-alt'}" style="color: ${route.pointColor};"></i>
                                    </div>
                                    <div class="point-coords">${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</div>
                                    ${point.distanceFromPrev > 0 ? `<div class="point-meta">üìè ${point.distanceFromPrev.toFixed(2)} km od p≈ôedchoz√≠ho</div>` : ''}
                                    ${point.notes ? `<div class="point-meta">üìù ${point.notes}</div>` : ''}
                                    <div class="point-actions">
                                        <button class="btn btn-small" onclick="routeManager.editPointName(${route.id}, ${point.id})" title="P≈ôejmenovat"><i class="fas fa-pen"></i></button>
                                        <button class="btn btn-small" onclick="routeManager.changePointIcon(${route.id}, ${point.id})" title="Zmƒõnit ikonu"><i class="fas fa-icons"></i></button>
                                        <button class="btn btn-small" onclick="routeManager.addPointNotes(${route.id}, ${point.id})" title="Pozn√°mka"><i class="fas fa-sticky-note"></i></button>
                                        <button class="btn btn-small" onclick="routeManager.movePointUp(${route.id}, ${point.id})" title="Nahoru" ${idx === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i></button>
                                        <button class="btn btn-small" onclick="routeManager.movePointDown(${route.id}, ${point.id})" title="Dol≈Ø" ${idx === route.points.length - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i></button>
                                        <button class="btn btn-small btn-danger" onclick="routeManager.removePointFromRoute(${route.id}, ${point.id})" title="Smazat"><i class="fas fa-trash"></i></button>
                                    </div>
                                `;
                                listContainer.appendChild(pointEl);
                            });
                        }
                    });
                }

                document.getElementById('totalRoutes').textContent = this.routes.length;
                document.getElementById('totalPoints').textContent = this.routes.reduce((sum, r) => sum + r.points.length, 0);
                this.updateEditModeBanner();
            }

            addCurrentLocation() {
                if (!this.editingRouteId) {
                    this.showNotification('Nejprve aktivujte re≈æim √∫prav', 'warning');
                    return;
                }

                if (!navigator.geolocation) {
                    this.showNotification('Geolokace nen√≠ podporov√°na', 'error');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const route = this.routes.find(r => r.id === this.editingRouteId);
                        if (route) {
                            this.saveState('GPS pozice');
                            this.addPointToRoute(route, position.coords.latitude, position.coords.longitude);
                            this.map.setView([position.coords.latitude, position.coords.longitude], 15);
                            this.showNotification('GPS pozice p≈ôid√°na', 'success');
                        }
                    },
                    (error) => this.showNotification('Chyba GPS: ' + error.message, 'error'),
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }

            addPointFromCoordinates() {
                const latRaw = document.getElementById('coordLatInput').value.trim();
                const lngRaw = document.getElementById('coordLngInput').value.trim();
                const name = document.getElementById('coordNameInput').value.trim();

                const lat = this.parseCoordinate(latRaw);
                const lng = this.parseCoordinate(lngRaw);

                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    this.showNotification('Neplatn√© sou≈ôadnice', 'error');
                    return;
                }

                const route = this.routes.find(r => r.id === this.editingRouteId);
                if (!route) return;

                this.saveState('Bod ze sou≈ôadnic');
                
                const point = {
                    id: Date.now() + Math.random(),
                    name: name || `Bod ${route.points.length + 1}`,
                    lat, lng,
                    created: new Date().toISOString(),
                    notes: '',
                    icon: 'fa-map-marker-alt',
                    distanceFromPrev: 0
                };

                route.points.push(point);
                this.recalculateDistances(route);
                this.redrawRoute(route);
                this.map.setView([lat, lng], Math.max(this.map.getZoom(), 14));
                this.closeModal('coordModal');
                this.updateUI();
                this.saveToStorage();
                this.showNotification('Bod p≈ôid√°n', 'success');
            }

            parseCoordinate(str) {
                const decimal = parseFloat(str.replace(',', '.'));
                if (!isNaN(decimal)) return decimal;

                const dmsMatch = str.match(/(\d+)[¬∞]\s*(\d+)?[']?\s*(\d+(?:\.\d+)?)?[""]?\s*([NSEW])?/i);
                if (dmsMatch) {
                    let deg = parseFloat(dmsMatch[1]) || 0;
                    let min = parseFloat(dmsMatch[2]) || 0;
                    let sec = parseFloat(dmsMatch[3]) || 0;
                    let dir = (dmsMatch[4] || '').toUpperCase();
                    
                    let result = deg + min / 60 + sec / 3600;
                    if (dir === 'S' || dir === 'W') result = -result;
                    return result;
                }

                return NaN;
            }

            fitMapToAllRoutes() {
                const allCoords = this.routes.flatMap(r => r.points.map(p => [p.lat, p.lng]));
                if (allCoords.length > 0) {
                    this.map.fitBounds(L.latLngBounds(allCoords), { padding: [50, 50] });
                }
            }

            clearAll() {
                this.saveState('Vymaz√°n√≠');
                this.routes.forEach(route => {
                    route.markers.forEach(m => this.map.removeLayer(m));
                    route.polylines.forEach(p => this.map.removeLayer(p));
                });
                this.routes = [];
                this.editingRouteId = null;
                this.selectedRouteId = null;
                this.updateUI();
                this.saveToStorage();
                this.showNotification('V≈°e vymaz√°no', 'success');
            }

            // ========== EXPORT/IMPORT ==========
            exportData() {
                const data = {
                    routes: this.routes.map(r => ({
                        id: r.id, name: r.name,
                        points: r.points.map(p => ({ id: p.id, name: p.name, lat: p.lat, lng: p.lng, created: p.created, notes: p.notes, icon: p.icon, distanceFromPrev: p.distanceFromPrev })),
                        pointColor: r.pointColor, lineColor: r.lineColor, distanceColor: r.distanceColor, visible: r.visible, created: r.created
                    })),
                    settings: this.settings,
                    exported: new Date().toISOString(),
                    version: "9.0"
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `trasy-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                this.showNotification('JSON exportov√°n', 'success');
            }

            exportGPX() {
                if (this.routes.length === 0) { this.showNotification('≈Ω√°dn√© trasy', 'warning'); return; }

                let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="TripPlanner v7.0">\n`;
                this.routes.forEach(route => {
                    gpx += `<trk><name>${this.escapeXml(route.name)}</name><trkseg>\n`;
                    route.points.forEach(p => {
                        gpx += `<trkpt lat="${p.lat}" lon="${p.lng}"><name>${this.escapeXml(p.name)}</name>${p.notes ? `<desc>${this.escapeXml(p.notes)}</desc>` : ''}</trkpt>\n`;
                    });
                    gpx += `</trkseg></trk>\n`;
                });
                gpx += `</gpx>`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([gpx], { type: 'application/gpx+xml' }));
                a.download = `trasy-${new Date().toISOString().split('T')[0]}.gpx`;
                a.click();
                this.showNotification('GPX exportov√°n', 'success');
            }

            exportKML() {
                if (this.routes.length === 0) { this.showNotification('≈Ω√°dn√© trasy', 'warning'); return; }

                let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document><name>Trasy</name>\n`;
                this.routes.forEach(route => {
                    kml += `<Placemark><name>${this.escapeXml(route.name)}</name><LineString><coordinates>`;
                    route.points.forEach(p => { kml += `${p.lng},${p.lat},0 `; });
                    kml += `</coordinates></LineString></Placemark>\n`;
                });
                kml += `</Document></kml>`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' }));
                a.download = `trasy-${new Date().toISOString().split('T')[0]}.kml`;
                a.click();
                this.showNotification('KML exportov√°n', 'success');
            }

            escapeXml(str) {
                return String(str || '').replace(/[<>&'"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&apos;', '"': '&quot;' }[c]));
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.gpx,.kml';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.saveState('Import');
                            const ext = file.name.split('.').pop().toLowerCase();
                            if (ext === 'gpx') this.importGPX(e.target.result);
                            else if (ext === 'kml') this.importKML(e.target.result);
                            else this.importJSON(JSON.parse(e.target.result));
                        } catch (error) {
                            this.showNotification('Chyba importu: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            importJSON(data) {
                if (!data.routes || !Array.isArray(data.routes)) { 
                    this.showNotification('Neplatn√Ω form√°t JSON', 'error'); 
                    return; 
                }
                data.routes.forEach(rd => {
                    const route = {
                        id: Date.now() + Math.random(),
                        name: rd.name || 'Import',
                        points: (rd.points || []).map(p => ({ ...p, id: Date.now() + Math.random(), notes: p.notes || '', icon: p.icon || 'fa-map-marker-alt' })),
                        markers: [], polylines: [],
                        pointColor: rd.pointColor || this.currentPointColor,
                        lineColor: rd.lineColor || this.currentLineColor,
                        distanceColor: rd.distanceColor || this.currentDistanceColor,
                        visible: true,
                        created: new Date().toISOString()
                    };
                    this.routes.push(route);
                    this.recalculateDistances(route);
                    route.points.forEach(p => this.createMarkerForRoute(route, p));
                    if (route.points.length >= 2) this.calculateRouteGeometry(route);
                });
                this.fitMapToAllRoutes();
                this.updateUI();
                this.saveToStorage();
                this.showNotification('Importov√°no', 'success');
            }

            importGPX(content) {
                const doc = new DOMParser().parseFromString(content, 'application/xml');
                const parseError = doc.querySelector('parsererror');
                if (parseError) {
                    this.showNotification('Neplatn√Ω GPX soubor', 'error');
                    return;
                }

                const tracks = doc.querySelectorAll('trk');
                if (tracks.length === 0) {
                    this.showNotification('GPX neobsahuje ≈æ√°dn√© trasy', 'warning');
                    return;
                }

                tracks.forEach(track => {
                    const route = {
                        id: Date.now() + Math.random(),
                        name: track.querySelector('name')?.textContent || 'GPX',
                        points: [],
                        markers: [], polylines: [],
                        pointColor: this.currentPointColor,
                        lineColor: this.currentLineColor,
                        distanceColor: this.currentDistanceColor,
                        visible: true,
                        created: new Date().toISOString()
                    };
                    track.querySelectorAll('trkpt').forEach((pt, idx) => {
                        const lat = parseFloat(pt.getAttribute('lat'));
                        const lng = parseFloat(pt.getAttribute('lon'));
                        if (!isNaN(lat) && !isNaN(lng)) {
                            route.points.push({
                                id: Date.now() + Math.random(),
                                name: pt.querySelector('name')?.textContent || `Bod ${idx + 1}`,
                                lat, lng,
                                created: new Date().toISOString(),
                                notes: pt.querySelector('desc')?.textContent || '',
                                icon: 'fa-map-marker-alt',
                                distanceFromPrev: 0
                            });
                        }
                    });
                    if (route.points.length > 0) {
                        this.routes.push(route);
                        this.recalculateDistances(route);
                        route.points.forEach(p => this.createMarkerForRoute(route, p));
                        if (route.points.length >= 2) this.calculateRouteGeometry(route);
                    }
                });
                this.fitMapToAllRoutes();
                this.updateUI();
                this.saveToStorage();
                this.showNotification('GPX importov√°n', 'success');
            }

            importKML(content) {
                const doc = new DOMParser().parseFromString(content, 'application/xml');
                const parseError = doc.querySelector('parsererror');
                if (parseError) {
                    this.showNotification('Neplatn√Ω KML soubor', 'error');
                    return;
                }

                doc.querySelectorAll('Placemark').forEach(pm => {
                    const ls = pm.querySelector('LineString coordinates');
                    if (!ls) return;
                    const route = {
                        id: Date.now() + Math.random(),
                        name: pm.querySelector('name')?.textContent || 'KML',
                        points: [],
                        markers: [], polylines: [],
                        pointColor: this.currentPointColor,
                        lineColor: this.currentLineColor,
                        distanceColor: this.currentDistanceColor,
                        visible: true,
                        created: new Date().toISOString()
                    };
                    ls.textContent.trim().split(/\s+/).forEach((pair, idx) => {
                        const [lng, lat] = pair.split(',').map(parseFloat);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            route.points.push({ 
                                id: Date.now() + Math.random(), 
                                name: `Bod ${idx + 1}`, 
                                lat, lng, 
                                created: new Date().toISOString(), 
                                notes: '', 
                                icon: 'fa-map-marker-alt',
                                distanceFromPrev: 0 
                            });
                        }
                    });
                    if (route.points.length > 0) {
                        this.routes.push(route);
                        this.recalculateDistances(route);
                        route.points.forEach(p => this.createMarkerForRoute(route, p));
                        if (route.points.length >= 2) this.calculateRouteGeometry(route);
                    }
                });
                this.fitMapToAllRoutes();
                this.updateUI();
                this.saveToStorage();
                this.showNotification('KML importov√°n', 'success');
            }

            // ========== STORAGE ==========
            saveToStorage() {
                try {
                    localStorage.setItem('walkingRoutesData_v9', JSON.stringify({
                        routes: this.routes.map(r => ({
                            id: r.id, name: r.name,
                            points: r.points.map(p => ({ id: p.id, name: p.name, lat: p.lat, lng: p.lng, created: p.created, notes: p.notes, icon: p.icon, distanceFromPrev: p.distanceFromPrev })),
                            pointColor: r.pointColor, lineColor: r.lineColor, distanceColor: r.distanceColor, visible: r.visible, created: r.created
                        })),
                        editingRouteId: this.editingRouteId,
                        selectedRouteId: this.selectedRouteId,
                        settings: { ...this.settings, mapCenter: this.map ? [this.map.getCenter().lat, this.map.getCenter().lng] : this.settings.mapCenter, mapZoom: this.map ? this.map.getZoom() : this.settings.mapZoom }
                    }));
                } catch (e) {
                    console.warn('Storage save failed:', e);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('walkingRoutesData_v9') || localStorage.getItem('walkingRoutesData_v8') || localStorage.getItem('walkingRoutesData_v7');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.settings) {
                            this.settings = { ...this.settings, ...data.settings };
                            this.currentPointColor = this.settings.pointColor;
                            this.currentLineColor = this.settings.lineColor;
                            this.currentDistanceColor = this.settings.distanceColor;
                            this.showDistances = this.settings.showDistances;
                            this.showNotes = this.settings.showNotes;
                            this.draggableMarkers = this.settings.draggableMarkers || false;
                            this.speedProfile = this.settings.speedProfile || 5;
                        }
                        if (data.routes) {
                            this.routes = data.routes.map(r => ({ 
                                ...r, 
                                markers: [], 
                                polylines: [], 
                                points: r.points.map(p => ({ ...p, icon: p.icon || 'fa-map-marker-alt' })) 
                            }));
                            this.editingRouteId = data.editingRouteId || null;
                            this.selectedRouteId = data.selectedRouteId || null;
                        }
                    }
                } catch (e) {
                    console.warn('Storage load failed:', e);
                }
            }

            restoreRoutes() {
                this.routes.forEach(route => {
                    if (route.visible) {
                        route.points.forEach(p => this.createMarkerForRoute(route, p));
                        if (route.points.length >= 2) this.calculateRouteGeometry(route);
                    }
                });
            }

            restoreMapView() {
                if (this.settings.mapCenter && this.settings.mapZoom) {
                    this.map.setView(this.settings.mapCenter, this.settings.mapZoom);
                }
            }

            saveSettings() {
                this.settings.pointColor = this.currentPointColor;
                this.settings.lineColor = this.currentLineColor;
                this.settings.distanceColor = this.currentDistanceColor;
                this.settings.showDistances = this.showDistances;
                this.settings.showNotes = this.showNotes;
                this.settings.draggableMarkers = this.draggableMarkers;
                this.settings.speedProfile = this.speedProfile;
                if (this.map) {
                    this.settings.mapCenter = [this.map.getCenter().lat, this.map.getCenter().lng];
                    this.settings.mapZoom = this.map.getZoom();
                }
                this.saveToStorage();
            }

            restoreUISettings() {
                document.getElementById('pointColor').value = this.settings.pointColor;
                document.getElementById('lineColor').value = this.settings.lineColor;
                document.getElementById('distanceColor').value = this.settings.distanceColor;
                document.getElementById('showDistances').checked = this.settings.showDistances;
                document.getElementById('showNotes').checked = this.settings.showNotes;
                document.getElementById('draggableMarkers').checked = this.settings.draggableMarkers || false;
                document.getElementById('speedProfile').value = this.settings.speedProfile || 5;
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.querySelector('span').textContent = message;
                notification.className = `notification ${type} show`;
                const icons = { success: 'fa-check', warning: 'fa-exclamation', error: 'fa-times', info: 'fa-info' };
                notification.querySelector('.notification-icon i').className = `fas ${icons[type] || 'fa-check'}`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => { window.routeManager = new WalkingRouteManager(); });
    </script>
</body>
</html>
