<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripPlanner - Spr√°vce pƒõ≈°√≠ch tras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Reset a z√°kladn√≠ styly */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Aplikujeme t√©ma z hlavn√≠ho okna */
        :root {
            --barva-pozadi: #121212;
            --barva-panelu: #1e1e1e;
            --barva-ramu: #2a2a2a;
            --text-svetly: #f0f0f0;
            --text-sedy: #aaaaaa;
            --hover: #333;
            --aktivni: #555;
            --accent-primary: #ff9900;
            --accent-secondary: #ffaa33;
            --accent-success: #00b894;
            --accent-warning: #fdcb6e;
            --accent-danger: #f44336;
            --border-color: #444444;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--barva-pozadi);
            color: var(--text-svetly);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 380px;
            background: var(--barva-panelu);
            border-right: 1px solid var(--barva-ramu);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--barva-ramu);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 8px 12px;
            background: var(--barva-ramu);
            border: 1px solid var(--border-color);
            color: var(--text-sedy);
            cursor: pointer;
            font-size: 11px;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: var(--hover);
            color: var(--text-svetly);
        }

        .tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .map-controls {
            margin-bottom: 15px;
        }

        .map-controls label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-sedy);
        }

        .map-controls select {
            width: 100%;
            padding: 8px;
            background: var(--barva-ramu);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-svetly);
            font-size: 12px;
            margin-bottom: 10px;
        }

        .color-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-item {
            flex: 1;
        }

        .color-item label {
            font-size: 11px;
            margin-bottom: 3px;
            display: block;
            color: var(--text-sedy);
        }

        .color-item input[type="color"] {
            width: 100%;
            height: 30px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background: var(--barva-ramu);
        }

        .display-options {
            margin-bottom: 15px;
            background: var(--barva-ramu);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-svetly);
        }

        .checkbox-label:last-child {
            margin-bottom: 0;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
            accent-color: var(--accent-primary);
        }

        .list-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn:disabled {
            background: var(--text-sedy);
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: var(--accent-danger);
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-secondary {
            background: var(--text-sedy);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-warning {
            background: var(--accent-warning);
        }

        .btn-warning:hover {
            background: #e68900;
        }

        .btn-info {
            background: #2196F3;
        }

        .btn-info:hover {
            background: #1976D2;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .routes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        /* Custom scrollbar */
        .routes-list::-webkit-scrollbar {
            width: 8px;
        }

        .routes-list::-webkit-scrollbar-track {
            background: var(--barva-panelu);
        }

        .routes-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        .routes-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        .route-item {
            background: var(--barva-ramu);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-item:hover {
            background: var(--hover);
            border-color: var(--accent-primary);
            transform: translateX(2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .route-item.selected {
            border-color: var(--accent-primary);
            background: var(--hover);
            box-shadow: 0 0 10px rgba(255, 153, 0, 0.3);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .route-name {
            font-weight: bold;
            color: var(--accent-primary);
            flex: 1;
        }

        .route-type {
            background: var(--barva-pozadi);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            color: var(--text-sedy);
            border: 1px solid var(--border-color);
        }

        .route-info {
            font-size: 12px;
            color: var(--text-sedy);
            margin-bottom: 4px;
        }

        .route-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .point-item {
            background: var(--barva-pozadi);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
            font-size: 11px;
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .point-name {
            font-weight: bold;
            color: var(--text-svetly);
        }

        .point-coords {
            font-size: 10px;
            color: var(--text-sedy);
        }

        .point-distance {
            font-size: 10px;
            color: var(--accent-warning);
        }

        .point-notes {
            font-size: 10px;
            color: var(--accent-warning);
            font-style: italic;
        }

        .point-actions {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        #map {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        .info-panel {
            background: var(--barva-ramu);
            padding: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-sedy);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: var(--barva-pozadi);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-sedy);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            background: var(--accent-primary);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            transform: translateX(100%);
            transition: transform 0.3s;
            font-size: 13px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.warning {
            background: var(--accent-warning);
        }

        .notification.error {
            background: var(--accent-danger);
        }

        .notification.info {
            background: #2196F3;
        }

        /* Coordinate input dialog */
        .coordinate-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .coordinate-dialog.show {
            display: flex;
        }

        .coordinate-dialog-content {
            background: var(--barva-panelu);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            color: var(--text-svetly);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .coordinate-dialog h3 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .coordinate-input-group {
            margin-bottom: 15px;
        }

        .coordinate-input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-sedy);
        }

        .coordinate-input-group input {
            width: 100%;
            padding: 8px;
            background: var(--barva-ramu);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-svetly);
            font-size: 12px;
        }

        .coordinate-input-group input:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.2);
        }

        .coordinate-dialog-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .coordinate-examples {
            background: var(--barva-ramu);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 11px;
            color: var(--text-sedy);
            border: 1px solid var(--border-color);
        }

        .coordinate-examples h4 {
            color: var(--accent-warning);
            margin-bottom: 5px;
            font-size: 11px;
        }

        /* Mobile Hamburger Menu */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 2000;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            touch-action: manipulation;
        }

        .mobile-menu-toggle:hover {
            background: var(--accent-secondary);
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 1500;
                transform: translateX(-100%);
                border-right: none;
                transition: transform 0.3s ease;
            }

            .sidebar.menu-open {
                transform: translateX(0);
            }

            .sidebar-header {
                padding: 70px 20px 20px 20px;
            }

            .sidebar-header h2 {
                font-size: 16px;
            }

            .tabs {
                flex-wrap: wrap;
                gap: 4px;
            }

            .tab {
                flex: 1;
                min-width: calc(33.333% - 3px);
                font-size: 10px;
                padding: 6px 8px;
            }

            .list-controls {
                gap: 4px;
            }

            .btn {
                font-size: 10px;
                padding: 6px 10px;
            }

            .btn-small {
                font-size: 9px;
                padding: 3px 6px;
            }

            .color-group {
                flex-direction: column;
                gap: 8px;
            }

            .color-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .color-item label {
                min-width: 60px;
                margin-bottom: 0;
            }

            .color-item input[type="color"] {
                width: 40px;
                height: 30px;
            }

            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 10px 6px;
            }

            .stat-value {
                font-size: 14px;
            }

            .stat-label {
                font-size: 10px;
            }

            .route-item {
                padding: 10px;
                margin-bottom: 6px;
            }

            .route-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .route-actions {
                justify-content: center;
                gap: 6px;
            }

            .point-item {
                padding: 6px;
            }

            .point-actions {
                justify-content: center;
                gap: 4px;
            }

            #map {
                height: 100vh;
                width: 100%;
            }

            .notification {
                top: 80px;
                right: 10px;
                left: 10px;
                font-size: 12px;
                text-align: center;
                transform: translateY(-100%);
            }

            .notification.show {
                transform: translateY(0);
            }

            .info-panel {
                padding: 10px;
                font-size: 10px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 6px;
                text-align: center;
            }

            .routes-list {
                padding: 0 15px 15px;
            }

            .coordinate-dialog-content {
                margin: 10px;
                width: calc(100% - 20px);
            }

            /* Touch-friendly improvements */
            .btn, .tab {
                min-height: 36px;
                touch-action: manipulation;
            }

            .route-item, .point-item {
                touch-action: manipulation;
            }

            /* Improve readability on small screens */
            .route-info {
                font-size: 11px;
                line-height: 1.4;
            }

            .point-coords {
                font-size: 9px;
                word-break: break-all;
            }
        }

        /* Very small mobile devices */
        @media (max-width: 480px) {
            .sidebar-header {
                padding: 65px 15px 15px 15px;
            }

            .sidebar-header h2 {
                font-size: 14px;
            }

            .tab {
                font-size: 9px;
                padding: 4px 6px;
            }

            .btn {
                font-size: 9px;
                padding: 5px 8px;
            }

            .statistics-grid {
                grid-template-columns: 1fr;
            }

            .route-actions {
                flex-direction: column;
                gap: 4px;
            }

            .point-actions {
                flex-direction: column;
                gap: 3px;
            }

            .list-controls {
                flex-direction: column;
                gap: 6px;
            }

            .routes-list {
                padding: 0 10px 10px;
            }
        }

        /* Landscape mobile orientation */
        @media (max-width: 768px) and (orientation: landscape) {
            .sidebar {
                width: 60%;
            }

            .sidebar-header {
                padding: 60px 15px 15px 15px;
            }

            .statistics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars" id="menuIcon"></i>
    </button>

    <!-- Coordinate Input Dialog -->
    <div class="coordinate-dialog" id="coordinateDialog">
        <div class="coordinate-dialog-content">
            <h3><i class="fas fa-map-marker-alt"></i> P≈ôidat bod ze sou≈ôadnic</h3>
            
            <div class="coordinate-examples">
                <h4>P≈ô√≠klady form√°t≈Ø:</h4>
                <div>‚Ä¢ 49.7437, 15.3386</div>
                <div>‚Ä¢ 49.7437 15.3386</div>
                <div>‚Ä¢ 49¬∞44'37"N 15¬∞20'19"E</div>
            </div>

            <div class="coordinate-input-group">
                <label><i class="fas fa-globe"></i> Zemƒõpisn√° ≈°√≠≈ôka (Latitude):</label>
                <input type="text" id="latitudeInput" placeholder="49.7437">
            </div>

            <div class="coordinate-input-group">
                <label><i class="fas fa-globe"></i> Zemƒõpisn√° d√©lka (Longitude):</label>
                <input type="text" id="longitudeInput" placeholder="15.3386">
            </div>

            <div class="coordinate-input-group">
                <label><i class="fas fa-tag"></i> N√°zev bodu (voliteln√©):</label>
                <input type="text" id="pointNameInput" placeholder="N√°zev bodu">
            </div>

            <div class="coordinate-dialog-actions">
                <button class="btn btn-secondary" onclick="routeManager.closeCoordinateDialog()">
                    <i class="fas fa-times"></i> Zru≈°it
                </button>
                <button class="btn" onclick="routeManager.addPointFromCoordinates()">
                    <i class="fas fa-plus"></i> P≈ôidat bod
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-walking"></i> TripPlanner</h2>
                
                <div class="tabs">
                    <button class="tab active" data-tab="routes"><i class="fas fa-route"></i> Trasy</button>
                    <button class="tab" data-tab="map"><i class="fas fa-map"></i> Mapa</button>
                    <button class="tab" data-tab="analysis"><i class="fas fa-chart-line"></i> Anal√Ωza</button>
                </div>

                <!-- Trasy tab -->
                <div class="tab-content active" id="routes-tab">
                    <div class="color-group">
                        <div class="color-item">
                            <label><i class="fas fa-map-pin"></i> Body:</label>
                            <input type="color" id="pointColor" value="#ff9900">
                        </div>
                        <div class="color-item">
                            <label><i class="fas fa-route"></i> Trasa:</label>
                            <input type="color" id="lineColor" value="#fdcb6e">
                        </div>
                        <div class="color-item">
                            <label><i class="fas fa-ruler"></i> Vzd√°lenost:</label>
                            <input type="color" id="distanceColor" value="#ffffff">
                        </div>
                    </div>

                    <div class="display-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showDistances" checked>
                            Zobrazit vzd√°lenosti na mapƒõ
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="showNotes">
                            Zobrazit pozn√°mky na mapƒõ
                        </label>
                    </div>

                    <div class="list-controls">
                        <button class="btn btn-small" id="newRoute"><i class="fas fa-plus"></i> Nov√° trasa</button>
                        <button class="btn btn-small btn-warning" id="optimizeRoute"><i class="fas fa-magic"></i> Optimalizovat</button>
                        <button class="btn btn-small" id="addCurrentLocation"><i class="fas fa-crosshairs"></i> Pozice</button>
                    </div>

                    <div class="list-controls">
                        <button class="btn btn-small btn-info" id="addFromCoordinates"><i class="fas fa-map-marker-alt"></i> Ze sou≈ôadnic</button>
                        <button class="btn btn-small btn-secondary" id="exportData"><i class="fas fa-download"></i> Export</button>
                        <button class="btn btn-small btn-secondary" id="importData"><i class="fas fa-upload"></i> Import</button>
                    </div>

                    <div class="list-controls">
                        <button class="btn btn-small btn-danger" id="clearAll"><i class="fas fa-trash"></i> Vymazat v≈°e</button>
                        <button class="btn btn-small btn-info" id="fitAllRoutes"><i class="fas fa-expand-arrows-alt"></i> Zobrazit v≈°e</button>
                    </div>
                </div>

                <!-- Mapa tab -->
                <div class="tab-content" id="map-tab">
                    <div class="map-controls">
                        <label><i class="fas fa-layer-group"></i> Mapov√Ω podklad:</label>
                        <select id="mapLayer">
                            <option value="osm">OpenStreetMap</option>
                            <option value="satellite">Satelitn√≠</option>
                            <option value="terrain">Ter√©nn√≠</option>
                            <option value="dark">Tmav√°</option>
                        </select>
                    </div>
                </div>

                <!-- Anal√Ωza tab -->
                <div class="tab-content" id="analysis-tab">
                    <div class="statistics-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalRoutesStat">0</div>
                            <div class="stat-label">Celkem tras</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalPointsStat">0</div>
                            <div class="stat-label">Celkem bod≈Ø</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalDistanceStat">0 km</div>
                            <div class="stat-label">Celkov√° vzd√°lenost</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="estimatedTimeStat">0 min</div>
                            <div class="stat-label">Odhadovan√Ω ƒças</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="routes-list" id="routesList">
                <div style="text-align: center; color: var(--text-sedy); margin-top: 50px;">
                    <i class="fas fa-mouse-pointer"></i><br>
                    Kliknƒõte na "Nov√° trasa" a pot√© na mapu pro p≈ôid√°n√≠ bod≈Ø
                </div>
            </div>

            <div class="info-panel">
                <div class="info-grid">
                    <div>Celkem tras: <span id="totalRoutes">0</span></div>
                    <div>Celkem bod≈Ø: <span id="totalPoints">0</span></div>
                    <div>Poslednƒõ upraveno: <span id="lastModified">-</span></div>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
      // Glob√°ln√≠ promƒõnn√© pro menu
let isMenuOpen = false;

// Jednoduch√° funkce pro p≈ôep√≠n√°n√≠ menu
function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const icon = document.getElementById('menuIcon');
    
    isMenuOpen = !isMenuOpen;
    
    if (isMenuOpen) {
        sidebar.classList.add('menu-open');
        icon.className = 'fas fa-times';
    } else {
        sidebar.classList.remove('menu-open');
        icon.className = 'fas fa-bars';
        isMenuOpen = false;
    }
}

class WalkingRouteManager {
    constructor() {
        this.map = null;
        this.routes = [];
        this.currentRouteId = null;
        this.selectedRouteId = null;
        this.currentLayer = null;
        this.isDragging = false;
        this.currentPointColor = '#ff9900';
        this.currentLineColor = '#fdcb6e';
        this.currentDistanceColor = '#ffffff';
        this.isMobile = window.innerWidth <= 768;
        this.showDistances = true;
        this.showNotes = false;
        this.settings = {
            mapLayer: 'osm',
            pointColor: '#ff9900',
            lineColor: '#fdcb6e',
            distanceColor: '#ffffff',
            showDistances: true,
            showNotes: false,
            mapCenter: [49.7437, 15.3386],
            mapZoom: 8
        };
        
        this.init();
    }

    init() {
        this.loadFromStorage();
        this.initMap();
        this.initEventListeners();
        this.updateUI();
        this.restoreMapView();
        
        const mapElement = document.getElementById('map');
        if (mapElement) {
            mapElement.addEventListener('click', closeMenu);
        }
    }

    saveToStorage() {
        try {
            const dataToSave = {
                routes: this.routes.map(route => ({
                    id: route.id,
                    name: route.name,
                    points: route.points.map(point => ({
                        id: point.id,
                        name: point.name,
                        lat: point.lat,
                        lng: point.lng,
                        created: point.created,
                        notes: point.notes,
                        distanceFromPrev: point.distanceFromPrev
                    })),
                    realDistances: route.realDistances || [],
                    pointColor: route.pointColor,
                    lineColor: route.lineColor,
                    distanceColor: route.distanceColor,
                    visible: route.visible,
                    created: route.created
                })),
                currentRouteId: this.currentRouteId,
                selectedRouteId: this.selectedRouteId,
                settings: {
                    ...this.settings,
                    mapCenter: this.map ? [this.map.getCenter().lat, this.map.getCenter().lng] : this.settings.mapCenter,
                    mapZoom: this.map ? this.map.getZoom() : this.settings.mapZoom
                },
                lastSaved: new Date().toISOString()
            };
            
            // Nepou≈æ√≠v√°me localStorage ve Claude artifacts
            console.log('Data p≈ôipravena k ulo≈æen√≠:', dataToSave);
        } catch (error) {
            console.warn('Nepoda≈ôilo se p≈ôipravit data k ulo≈æen√≠:', error);
        }
    }

    loadFromStorage() {
        // Nastav√≠me v√Ωchoz√≠ hodnoty m√≠sto localStorage
        console.log('Naƒç√≠t√°n√≠ v√Ωchoz√≠ch nastaven√≠...');
    }

    restoreMapView() {
        if (this.map && this.settings.mapCenter && this.settings.mapZoom) {
            this.map.setView(this.settings.mapCenter, this.settings.mapZoom);
        }
    }

    saveSettings() {
        this.settings.pointColor = this.currentPointColor;
        this.settings.lineColor = this.currentLineColor;
        this.settings.distanceColor = this.currentDistanceColor;
        this.settings.showDistances = this.showDistances;
        this.settings.showNotes = this.showNotes;
        this.settings.mapLayer = document.getElementById('mapLayer').value;
        
        if (this.map) {
            this.settings.mapCenter = [this.map.getCenter().lat, this.map.getCenter().lng];
            this.settings.mapZoom = this.map.getZoom();
        }
        
        this.saveToStorage();
    }

    restoreUISettings() {
        document.getElementById('pointColor').value = this.settings.pointColor;
        document.getElementById('lineColor').value = this.settings.lineColor;
        document.getElementById('distanceColor').value = this.settings.distanceColor;
        document.getElementById('showDistances').checked = this.settings.showDistances;
        document.getElementById('showNotes').checked = this.settings.showNotes;
        document.getElementById('mapLayer').value = this.settings.mapLayer;
    }

    // Nov√© metody pro pr√°ci se sou≈ôadnicemi
    showCoordinateDialog() {
        if (!this.currentRouteId) {
            this.showNotification("Nejd≈ô√≠ve vytvo≈ôte nebo vyberte trasu", "warning");
            return;
        }
        
        const dialog = document.getElementById('coordinateDialog');
        dialog.classList.add('show');
        
        document.getElementById('latitudeInput').value = '';
        document.getElementById('longitudeInput').value = '';
        document.getElementById('pointNameInput').value = '';
        
        document.getElementById('latitudeInput').focus();
    }

    closeCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');
        dialog.classList.remove('show');
    }

    parseCoordinates(latInput, lngInput) {
        let lat, lng;
        
        // Pokus√≠ se p≈ôev√©st na ƒç√≠slo
        lat = parseFloat(latInput.replace(',', '.'));
        lng = parseFloat(lngInput.replace(',', '.'));
        
        // Pokud se nepoda≈ôilo parsovat, zkus√≠ jin√© form√°ty
        if (isNaN(lat) || isNaN(lng)) {
            const combined = `${latInput} ${lngInput}`.replace(/[,;]/g, ' ');
            const coords = combined.match(/[-+]?\d*\.?\d+/g);
            
            if (coords && coords.length >= 2) {
                lat = parseFloat(coords[0]);
                lng = parseFloat(coords[1]);
            }
        }
        
        // Pokus√≠ se parsovat DMS form√°t (stupnƒõ, minuty, sekundy)
        if (isNaN(lat) || isNaN(lng)) {
            const dmsPattern = /(\d+)¬∞(\d+)'(\d+(?:\.\d+)?)"([NSEW])/g;
            
            let latMatch = dmsPattern.exec(latInput);
            dmsPattern.lastIndex = 0;
            let lngMatch = dmsPattern.exec(lngInput);
            
            if (latMatch) {
                lat = parseInt(latMatch[1]) + parseInt(latMatch[2])/60 + parseFloat(latMatch[3])/3600;
                if (latMatch[4] === 'S') lat = -lat;
            }
            
            if (lngMatch) {
                lng = parseInt(lngMatch[1]) + parseInt(lngMatch[2])/60 + parseFloat(lngMatch[3])/3600;
                if (lngMatch[4] === 'W') lng = -lng;
            }
        }
        
        return { lat, lng };
    }

    validateCoordinates(lat, lng) {
        if (isNaN(lat) || isNaN(lng)) {
            return { valid: false, message: "Neplatn√© sou≈ôadnice. Zadejte ƒç√≠seln√© hodnoty." };
        }
        
        if (lat < -90 || lat > 90) {
            return { valid: false, message: "Zemƒõpisn√° ≈°√≠≈ôka mus√≠ b√Ωt mezi -90 a 90 stupni." };
        }
        
        if (lng < -180 || lng > 180) {
            return { valid: false, message: "Zemƒõpisn√° d√©lka mus√≠ b√Ωt mezi -180 a 180 stupni." };
        }
        
        return { valid: true };
    }

    addPointFromCoordinates() {
        const latInput = document.getElementById('latitudeInput').value.trim();
        const lngInput = document.getElementById('longitudeInput').value.trim();
        const nameInput = document.getElementById('pointNameInput').value.trim();
        
        if (!latInput || !lngInput) {
            this.showNotification("Zadejte sou≈ôadnice", "warning");
            return;
        }
        
        const { lat, lng } = this.parseCoordinates(latInput, lngInput);
        const validation = this.validateCoordinates(lat, lng);
        
        if (!validation.valid) {
            this.showNotification(validation.message, "error");
            return;
        }
        
        const route = this.routes.find(r => r.id === this.currentRouteId);
        const pointName = nameInput || `Bod ${route.points.length + 1}`;
        
        this.addPointToRoute(this.currentRouteId, lat, lng, pointName);
        this.map.setView([lat, lng], Math.max(this.map.getZoom(), 15));
        this.closeCoordinateDialog();
        this.showNotification(`Bod "${pointName}" byl p≈ôid√°n ze sou≈ôadnic!`);
        
        if (this.isMobile) {
            setTimeout(closeMenu, 500);
        }
    }

    initMap() {
        this.map = L.map('map').setView(this.settings.mapCenter, this.settings.mapZoom);
        
        this.layers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap contributors'
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB'
            })
        };

        this.currentLayer = this.layers[this.settings.mapLayer] || this.layers.osm;
        this.currentLayer.addTo(this.map);

        L.control.scale({
            metric: true,
            imperial: false,
            position: 'bottomleft',
            maxWidth: 200
        }).addTo(this.map);

        this.map.on('click', (e) => {
            if (!this.isDragging && this.currentRouteId) {
                this.addPointToRoute(this.currentRouteId, e.latlng.lat, e.latlng.lng);
            }
            if (this.isMobile) {
                closeMenu();
            }
        });

        this.map.on('moveend', () => {
            this.saveSettings();
        });

        this.map.on('zoomend', () => {
            this.saveSettings();
        });

        if (this.isMobile) {
            this.map.doubleClickZoom.disable();
            this.map.touchZoom.enable();
            this.map.tap.enable();
        }

        this.routes.forEach(route => {
            route.points.forEach(point => {
                this.createMarkerForRoute(route, point);
            });
            
            if (route.points.length >= 2) {
                this.calculateRouteGeometry(route);
            }
        });
    }

    initEventListeners() {
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                this.switchTab(e.target.dataset.tab);
            });
        });

        document.getElementById('mapLayer').addEventListener('change', (e) => {
            this.switchLayer(e.target.value);
            this.saveSettings();
        });

        document.getElementById('pointColor').addEventListener('change', (e) => {
            this.currentPointColor = e.target.value;
            this.updateCurrentRouteStyle();
            this.saveSettings();
        });

        document.getElementById('lineColor').addEventListener('change', (e) => {
            this.currentLineColor = e.target.value;
            this.updateCurrentRouteStyle();
            this.saveSettings();
        });

        document.getElementById('distanceColor').addEventListener('change', (e) => {
            this.currentDistanceColor = e.target.value;
            this.updateCurrentRouteStyle();
            this.saveSettings();
        });

        document.getElementById('showDistances').addEventListener('change', (e) => {
            this.showDistances = e.target.checked;
            this.updateAllRoutesDisplay();
            this.saveSettings();
        });

        document.getElementById('showNotes').addEventListener('change', (e) => {
            this.showNotes = e.target.checked;
            this.updateAllRoutesDisplay();
            this.saveSettings();
        });

        document.getElementById('newRoute').addEventListener('click', () => {
            this.createNewRoute();
            if (this.isMobile) setTimeout(closeMenu, 500);
        });

        document.getElementById('clearAll').addEventListener('click', () => {
            if (confirm('Opravdu chcete vymazat v≈°echny trasy?')) {
                this.clearAll();
            }
        });

        document.getElementById('exportData').addEventListener('click', () => {
            this.exportData();
        });

        document.getElementById('importData').addEventListener('click', () => {
            this.importData();
        });

        document.getElementById('addCurrentLocation').addEventListener('click', () => {
            this.addCurrentLocation();
            if (this.isMobile) setTimeout(closeMenu, 500);
        });

        document.getElementById('addFromCoordinates').addEventListener('click', () => {
            this.showCoordinateDialog();
        });

        document.getElementById('optimizeRoute').addEventListener('click', () => {
            this.optimizeCurrentRoute();
        });

        document.getElementById('fitAllRoutes').addEventListener('click', () => {
            this.fitMapToAllRoutes();
            if (this.isMobile) setTimeout(closeMenu, 500);
        });

        // Event listenery pro coordinate dialog
        document.getElementById('coordinateDialog').addEventListener('click', (e) => {
            if (e.target === document.getElementById('coordinateDialog')) {
                this.closeCoordinateDialog();
            }
        });

        document.getElementById('latitudeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('longitudeInput').focus();
            }
        });

        document.getElementById('longitudeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('pointNameInput').focus();
            }
        });

        document.getElementById('pointNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.addPointFromCoordinates();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeCoordinateDialog();
            }
        });

        setTimeout(() => {
            this.restoreUISettings();
        }, 100);
    }

    switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    createNewRoute() {
        const routeId = Date.now();
        const route = {
            id: routeId,
            name: `Trasa ${this.routes.length + 1}`,
            points: [],
            markers: [],
            polylines: [],
            realDistances: [],
            pointColor: this.currentPointColor,
            lineColor: this.currentLineColor,
            distanceColor: this.currentDistanceColor,
            visible: true,
            created: new Date().toISOString()
        };

        this.routes.push(route);
        this.currentRouteId = routeId;
        this.selectedRouteId = routeId;
        this.updateUI();
        this.saveToStorage();
        this.showNotification(`Nov√° trasa "${route.name}" byla vytvo≈ôena!`);
    }

    addPointToRoute(routeId, lat, lng, name = null) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const pointName = name || `Bod ${route.points.length + 1}`;
        
        const point = {
            id: Date.now(),
            name: pointName,
            lat: lat,
            lng: lng,
            created: new Date().toISOString(),
            notes: '',
            noteMarker: null
        };

        route.points.push(point);
        this.createMarkerForRoute(route, point);
        
        if (route.points.length >= 2) {
            this.calculateRouteGeometry(route);
        }
        
        this.updateUI();
        this.saveToStorage();
        document.getElementById('lastModified').textContent = new Date().toLocaleTimeString();
    }

    createMarkerForRoute(route, point) {
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `<i class="fas fa-map-pin" style="color: ${route.pointColor}; font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></i>`,
            iconSize: [24, 24],
            iconAnchor: [12, 24]
        });

        const marker = L.marker([point.lat, point.lng], {
            draggable: true,
            icon: icon
        }).addTo(this.map);

        marker.routeId = route.id;
        marker.pointId = point.id;
        
        marker.bindPopup(`
            <div style="background: var(--barva-panelu); color: var(--text-svetly); padding: 10px; border-radius: 4px; border: 1px solid var(--border-color);">
                <h4 style="color: var(--accent-primary); margin-bottom: 8px;">${point.name}</h4>
                <p style="margin: 4px 0; font-size: 12px;">üìç ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                <p style="margin: 4px 0; font-size: 12px;">üïí ${new Date(point.created).toLocaleString()}</p>
                <p style="margin: 4px 0; font-size: 12px;">üéØ Trasa: ${route.name}</p>
                ${point.notes ? `<p style="margin: 4px 0; font-size: 11px; font-style: italic; color: var(--accent-warning);">üìù ${point.notes}</p>` : ''}
            </div>
        `);
        
        marker.on('dragstart', () => {
            this.isDragging = true;
        });

        marker.on('dragend', (e) => {
            setTimeout(() => {
                this.isDragging = false;
            }, 100);
            
            const newPos = e.target.getLatLng();
            this.updatePointPosition(route.id, point.id, newPos.lat, newPos.lng);
        });

        marker.on('click', () => {
            this.selectRoute(route.id);
        });

        route.markers.push(marker);
        this.updatePointNoteDisplay(route, point);
    }

    updatePointPosition(routeId, pointId, lat, lng) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const point = route.points.find(p => p.id === pointId);
        if (point) {
            point.lat = lat;
            point.lng = lng;
            
            if (route.points.length >= 2) {
                route.realDistances = [];
                this.calculateRouteGeometry(route);
            }
            
            this.updateUI();
            this.saveToStorage();
            this.updatePointNoteDisplay(route, point);
        }
    }

    calculateRouteGeometry(route) {
        if (route.points.length < 2) return;

        route.polylines.forEach(line => this.map.removeLayer(line));
        route.polylines = [];
        route.realDistances = [];

        let totalRealDistance = 0;
        
        for (let i = 0; i < route.points.length - 1; i++) {
            const start = route.points[i];
            const end = route.points[i + 1];
            
            const distance = this.calculateDistance(start, end);
            route.realDistances.push(distance);
            totalRealDistance += distance;
            
            const polyline = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: route.lineColor,
                weight: 4,
                opacity: 0.8
            }).addTo(this.map);
            
            route.polylines.push(polyline);
            
            if (this.showDistances) {
                const midLat = (start.lat + end.lat) / 2;
                const midLng = (start.lng + end.lng) / 2;
                
                const distanceMarker = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'distance-line',
                        html: `<span style="color: ${route.distanceColor}; background: rgba(0,0,0,0.7); padding: 2px 4px; border-radius: 3px; font-size: 11px;">${distance.toFixed(1)} km</span>`,
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                    })
                }).addTo(this.map);
                
                route.polylines.push(distanceMarker);
            }
        }

        route.points.forEach((point, index) => {
            if (index > 0) {
                point.distanceFromPrev = route.realDistances[index - 1];
            } else {
                point.distanceFromPrev = null;
            }
        });

        this.showNotification(`Trasa "${route.name}" vypoƒç√≠t√°na! Celkem: ${totalRealDistance.toFixed(1)} km`);
        this.updateStatistics();
        this.updateUI();
        this.saveToStorage();
        
        route.points.forEach(point => {
            this.updatePointNoteDisplay(route, point);
        });
    }

    calculateDistance(point1, point2) {
        const R = 6371;
        const dLat = (point2.lat - point1.lat) * Math.PI / 180;
        const dLng = (point2.lng - point1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    fitMapToAllRoutes() {
        if (this.routes.length === 0) {
            this.showNotification("Nejd≈ô√≠ve vytvo≈ôte trasy", "warning");
            return;
        }

        const bounds = L.latLngBounds();
        let hasPoints = false;

        this.routes.forEach(route => {
            if (route.visible && route.points.length > 0) {
                route.points.forEach(point => {
                    bounds.extend([point.lat, point.lng]);
                    hasPoints = true;
                });
            }
        });

        if (hasPoints && bounds.isValid()) {
            this.map.fitBounds(bounds, {
                padding: [30, 30],
                maxZoom: 14
            });
            this.showNotification("Mapa byla p≈ôizp≈Øsobena v≈°em tras√°m!");
        } else {
            this.showNotification("≈Ω√°dn√© viditeln√© trasy k zobrazen√≠", "warning");
        }
    }

    selectRoute(routeId) {
        this.selectedRouteId = routeId;
        this.currentRouteId = routeId;
        this.updateUI();
        this.saveToStorage();
    }

    removeRoute(routeId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        route.markers.forEach(marker => this.map.removeLayer(marker));
        route.polylines.forEach(line => this.map.removeLayer(line));
        route.points.forEach(point => {
            if (point.noteMarker) {
                this.map.removeLayer(point.noteMarker);
            }
        });

        this.routes = this.routes.filter(r => r.id !== routeId);

        if (this.currentRouteId === routeId) {
            this.currentRouteId = this.routes.length > 0 ? this.routes[0].id : null;
        }

        if (this.selectedRouteId === routeId) {
            this.selectedRouteId = this.routes.length > 0 ? this.routes[0].id : null;
        }

        this.updateUI();
        this.saveToStorage();
        this.showNotification(`Trasa "${route.name}" byla smaz√°na!`);
    }

    removePointFromRoute(routeId, pointId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const pointIndex = route.points.findIndex(p => p.id === pointId);
        if (pointIndex === -1) return;

        const point = route.points[pointIndex];
        
        if (point.noteMarker) {
            this.map.removeLayer(point.noteMarker);
        }

        route.points.splice(pointIndex, 1);

        const markerIndex = route.markers.findIndex(m => m.pointId === pointId);
        if (markerIndex !== -1) {
            this.map.removeLayer(route.markers[markerIndex]);
            route.markers.splice(markerIndex, 1);
        }

        route.realDistances = [];
        if (route.points.length >= 2) {
            this.calculateRouteGeometry(route);
        } else {
            route.polylines.forEach(line => this.map.removeLayer(line));
            route.polylines = [];
        }

        this.updateUI();
        this.saveToStorage();
    }

    editRouteName(routeId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const newName = prompt('Nov√Ω n√°zev trasy:', route.name);
        if (newName && newName.trim()) {
            route.name = newName.trim();
            this.updateUI();
            this.saveToStorage();
        }
    }

    editPointName(routeId, pointId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const point = route.points.find(p => p.id === pointId);
        if (!point) return;

        const newName = prompt('Nov√Ω n√°zev bodu:', point.name);
        if (newName && newName.trim()) {
            point.name = newName.trim();
            this.updateUI();
            this.saveToStorage();
        }
    }

    addPointNotes(routeId, pointId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        const point = route.points.find(p => p.id === pointId);
        if (!point) return;

        const notes = prompt('Pozn√°mka k bodu:', point.notes || '');
        if (notes !== null) {
            point.notes = notes.trim();
            this.updateUI();
            this.updatePointNoteDisplay(route, point);
            this.saveToStorage();
            this.showNotification("Pozn√°mka byla ulo≈æena!");
        }
    }

    updatePointNoteDisplay(route, point) {
        if (point.noteMarker) {
            this.map.removeLayer(point.noteMarker);
            point.noteMarker = null;
        }
        
        if (this.showNotes && point.notes && point.notes.trim()) {
            const noteMarker = L.marker([point.lat, point.lng], {
                icon: L.divIcon({
                    className: 'point-note',
                    html: `<div style="background: rgba(253,203,110,0.9); color: #333; padding: 4px 8px; border-radius: 8px; font-size: 12px; margin-left: 5px; margin-top: -15px; max-width: 150px; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.4); white-space: normal; overflow: visible; text-overflow: clip; height: auto;">${point.notes}</div>`,
                    iconSize: [150, 'auto'], 
                    iconAnchor: [0, 8]
                })
            }).addTo(this.map);
            
            point.noteMarker = noteMarker;
        }
    }

    updateAllRoutesDisplay() {
        this.routes.forEach(route => {
            if (route.visible) {
                if (route.points.length >= 2) {
                    this.calculateRouteGeometry(route);
                }
                
                route.points.forEach(point => {
                    this.updatePointNoteDisplay(route, point);
                });
            }
        });
    }

    toggleRouteVisibility(routeId) {
        const route = this.routes.find(r => r.id === routeId);
        if (!route) return;

        route.visible = !route.visible;

        if (route.visible) {
            route.markers.forEach(marker => marker.addTo(this.map));
            route.polylines.forEach(line => line.addTo(this.map));
        } else {
            route.markers.forEach(marker => this.map.removeLayer(marker));
            route.polylines.forEach(line => this.map.removeLayer(line));
            route.points.forEach(point => {
                if (point.noteMarker) {
                    this.map.removeLayer(point.noteMarker);
                }
            });
        }

        this.updateUI();
        this.saveToStorage();
    }

    optimizeCurrentRoute() {
        if (!this.currentRouteId) {
            this.showNotification("Nejd≈ô√≠ve vyberte trasu", "warning");
            return;
        }

        const route = this.routes.find(r => r.id === this.currentRouteId);
        if (!route || route.points.length < 3) {
            this.showNotification("Pro optimalizaci je pot≈ôeba alespo≈à 3 body", "warning");
            return;
        }

        const firstPoint = route.points[0];
        const lastPoint = route.points[route.points.length - 1];
        const middlePoints = route.points.slice(1, -1);
        
        const optimized = [firstPoint];
        let remaining = [...middlePoints];
        let current = firstPoint;

        while (remaining.length > 0) {
            let nearest = null;
            let minDistance = Infinity;
            
            remaining.forEach(point => {
                const distance = this.calculateDistance(current, point);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = point;
                }
            });
            
            optimized.push(nearest);
            remaining = remaining.filter(p => p !== nearest);
            current = nearest;
        }
        
        optimized.push(lastPoint);
        
        route.points = optimized;
        this.recreateMarkersForRoute(route);
        route.realDistances = [];
        this.calculateRouteGeometry(route);
        this.updateUI();
        this.saveToStorage();
        this.showNotification(`Trasa "${route.name}" byla optimalizov√°na!`);
    }

    recreateMarkersForRoute(route) {
        route.markers.forEach(marker => this.map.removeLayer(marker));
        route.markers = [];
        route.points.forEach(point => {
            this.createMarkerForRoute(route, point);
        });
    }

    updateCurrentRouteStyle() {
        if (!this.currentRouteId) return;

        const route = this.routes.find(r => r.id === this.currentRouteId);
        if (!route) return;

        route.pointColor = this.currentPointColor;
        route.lineColor = this.currentLineColor;
        route.distanceColor = this.currentDistanceColor;

        this.recreateMarkersForRoute(route);
        if (route.points.length >= 2) {
            this.calculateRouteGeometry(route);
        }
        this.saveToStorage();
    }

    addCurrentLocation() {
        if (!this.currentRouteId) {
            this.showNotification("Nejd≈ô√≠ve vytvo≈ôte trasu", "warning");
            return;
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    this.addPointToRoute(this.currentRouteId, lat, lng, "Moje poloha");
                    this.map.setView([lat, lng], 15);
                    this.showNotification("Aktu√°ln√≠ poloha byla p≈ôid√°na!");
                },
                (error) => {
                    this.showNotification("Nepoda≈ôilo se z√≠skat polohu", "error");
                }
            );
        } else {
            this.showNotification("Geolokace nen√≠ podporov√°na", "error");
        }
    }

    updateStatistics() {
        const totalRoutes = this.routes.length;
        const totalPoints = this.routes.reduce((sum, route) => sum + route.points.length, 0);
        const totalDistance = this.routes.reduce((sum, route) => sum + this.getRouteDistance(route), 0);
        
        const avgSpeed = 5;
        const estimatedTime = totalDistance / avgSpeed * 60;

        document.getElementById('totalRoutesStat').textContent = totalRoutes;
        document.getElementById('totalPointsStat').textContent = totalPoints;
        document.getElementById('totalDistanceStat').textContent = `${totalDistance.toFixed(1)} km`;
        document.getElementById('estimatedTimeStat').textContent = `${Math.round(estimatedTime)} min`;
    }

    getRouteDistance(route) {
        if (route.realDistances.length > 0) {
            return route.realDistances.reduce((sum, distance) => sum + distance, 0);
        }
        return route.points.reduce((sum, point) => sum + (point.distanceFromPrev || 0), 0);
    }

    showNotification(message, type = "success") {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    updateUI() {
        const listContainer = document.getElementById('routesList');
        listContainer.innerHTML = '';

        if (this.routes.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align: center; color: var(--text-sedy); margin-top: 50px;">
                    <i class="fas fa-route"></i><br>
                    Kliknƒõte na "Nov√° trasa" pro zaƒç√°tek
                </div>`;
        } else {
            this.routes.forEach((route) => {
                const routeElement = document.createElement('div');
                routeElement.className = `route-item ${this.selectedRouteId === route.id ? 'selected' : ''}`;
                
                const routeDistance = this.getRouteDistance(route);
                
                routeElement.innerHTML = `
                    <div class="route-header">
                        <div class="route-name">${route.name}</div>
                        <div class="route-type">Ch≈Øze</div>
                    </div>
                    <div class="route-info">
                        üìç ${route.points.length} bod≈Ø | üìè ${routeDistance.toFixed(1)} km
                    </div>
                    <div class="route-info">
                        üé® <span style="color: ${route.pointColor};">‚óè</span> 
                        <span style="color: ${route.lineColor};">‚ñ¨</span>
                        <span style="color: ${route.distanceColor};">‚ñ¨</span> | 
                        üëÅÔ∏è ${route.visible ? 'Viditeln√°' : 'Skryt√°'}
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-small" onclick="routeManager.selectRoute(${route.id})" title="Vybrat trasu">
                            <i class="fas fa-mouse-pointer"></i>
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="routeManager.editRouteName(${route.id})" title="Editovat n√°zev">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-info" onclick="routeManager.toggleRouteVisibility(${route.id})" title="Zobrazit/Skr√Ωt">
                            <i class="fas fa-eye${route.visible ? '' : '-slash'}"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="routeManager.removeRoute(${route.id})" title="Smazat trasu">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                if (route.points.length > 0) {
                    route.points.forEach((point, pointIndex) => {
                        const pointElement = document.createElement('div');
                        pointElement.className = 'point-item';
                        
                        pointElement.innerHTML = `
                            <div class="point-header">
                                <div class="point-name">${pointIndex + 1}. ${point.name}</div>
                            </div>
                            <div class="point-coords">
                                üìç ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}
                            </div>
                            ${point.distanceFromPrev ? `<div class="point-distance">üìè ${point.distanceFromPrev.toFixed(1)} km</div>` : ''}
                            ${point.notes ? `<div class="point-notes">üìù ${point.notes}</div>` : ''}
                            <div class="point-actions">
                                <button class="btn btn-small btn-secondary" onclick="routeManager.editPointName(${route.id}, ${point.id})" title="Editovat n√°zev">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-info" onclick="routeManager.addPointNotes(${route.id}, ${point.id})" title="Pozn√°mka">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="routeManager.removePointFromRoute(${route.id}, ${point.id})" title="Smazat">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;

                        pointElement.addEventListener('click', (e) => {
                            if (!e.target.closest('button')) {
                                this.selectRoute(route.id);
                                this.map.setView([point.lat, point.lng], Math.max(this.map.getZoom(), 15));
                            }
                        });

                        routeElement.appendChild(pointElement);
                    });
                }

                routeElement.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('.point-item')) {
                        this.selectRoute(route.id);
                    }
                });

                listContainer.appendChild(routeElement);
            });
        }

        document.getElementById('totalRoutes').textContent = this.routes.length;
        const totalPoints = this.routes.reduce((sum, route) => sum + route.points.length, 0);
        document.getElementById('totalPoints').textContent = totalPoints;
        
        this.updateStatistics();
    }

    switchLayer(layerType) {
        this.map.removeLayer(this.currentLayer);
        this.currentLayer = this.layers[layerType];
        this.currentLayer.addTo(this.map);
    }

    clearAll() {
        this.routes.forEach(route => {
            route.markers.forEach(marker => this.map.removeLayer(marker));
            route.polylines.forEach(line => this.map.removeLayer(line));
            route.points.forEach(point => {
                if (point.noteMarker) {
                    this.map.removeLayer(point.noteMarker);
                }
            });
        });
        
        this.routes = [];
        this.currentRouteId = null;
        this.selectedRouteId = null;
        
        this.updateUI();
        this.saveToStorage();
        this.showNotification("V≈°echny trasy byly vymaz√°ny!");
    }

    exportData() {
        try {
            const data = {
                routes: this.routes.map(route => ({
                    id: route.id,
                    name: route.name,
                    points: route.points.map(point => ({
                        id: point.id,
                        name: point.name,
                        lat: point.lat,
                        lng: point.lng,
                        created: point.created,
                        notes: point.notes,
                        distanceFromPrev: point.distanceFromPrev
                    })),
                    realDistances: route.realDistances || [],
                    pointColor: route.pointColor,
                    lineColor: route.lineColor,
                    distanceColor: route.distanceColor,
                    visible: route.visible,
                    created: route.created
                })),
                statistics: {
                    totalRoutes: this.routes.length,
                    totalPoints: this.routes.reduce((sum, route) => sum + route.points.length, 0),
                    totalDistance: this.routes.reduce((sum, route) => sum + this.getRouteDistance(route), 0)
                },
                settings: this.settings,
                exported: new Date().toISOString(),
                version: "4.1"
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tripplanner-trasy-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            this.showNotification("Data byla exportov√°na!");
        } catch (error) {
            console.error('Chyba p≈ôi exportu:', error);
            this.showNotification("Chyba p≈ôi exportu dat!", "error");
        }
    }

    importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.routes && Array.isArray(data.routes)) {
                            this.clearAll();
                            
                            if (data.settings) {
                                this.settings = { ...this.settings, ...data.settings };
                                this.currentPointColor = this.settings.pointColor;
                                this.currentLineColor = this.settings.lineColor;
                                this.currentDistanceColor = this.settings.distanceColor;
                                this.showDistances = this.settings.showDistances;
                                this.showNotes = this.settings.showNotes;
                                this.restoreUISettings();
                            }
                            
                            data.routes.forEach(routeData => {
                                const route = {
                                    id: routeData.id || Date.now() + Math.random(),
                                    name: routeData.name || `Importovan√° trasa ${this.routes.length + 1}`,
                                    points: (routeData.points || []).map(pointData => ({
                                        ...pointData,
                                        notes: pointData.notes || '',
                                        noteMarker: null
                                    })),
                                    markers: [],
                                    polylines: [],
                                    realDistances: routeData.realDistances || [],
                                    pointColor: routeData.pointColor || this.currentPointColor,
                                    lineColor: routeData.lineColor || this.currentLineColor,
                                    distanceColor: routeData.distanceColor || this.currentDistanceColor,
                                    visible: routeData.visible !== false,
                                    created: routeData.created || new Date().toISOString()
                                };

                                this.routes.push(route);

                                route.points.forEach(point => {
                                    this.createMarkerForRoute(route, point);
                                });

                                if (route.points.length >= 2) {
                                    this.calculateRouteGeometry(route);
                                }
                            });
                            
                            if (this.routes.length > 0) {
                                this.fitMapToAllRoutes();
                            }
                            
                            this.updateUI();
                            this.saveToStorage();
                            this.showNotification('Data byla √∫spƒõ≈°nƒõ importov√°na!');
                        } else {
                            this.showNotification('Neplatn√Ω form√°t souboru!', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Chyba p≈ôi ƒçten√≠ souboru!', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
}

// Inicializace aplikace po naƒçten√≠ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('TripPlanner inicializov√°n...');
    const routeManager = new WalkingRouteManager();
    
    // Glob√°ln√≠ p≈ô√≠stup pro funkce
    window.routeManager = routeManager;
});
    </script>
</body>
</html>');
        icon.className = 'fas fa-bars';
    }
}

// Zav≈ôen√≠ menu p≈ôi kliknut√≠ mimo
function closeMenu() {
    if (isMenuOpen) {
        const sidebar = document.getElementById('sidebar');
        const icon = document.getElementById('menuIcon');
        
        sidebar.classList.remove('menu-open
