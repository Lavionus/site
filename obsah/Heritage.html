<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≥ Heritage - Genealogick√° aplikace</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --male-color: #6aa6fd;
            --female-color: #e84393;
            --other-color: #888;
            --background-color: #1a1a1a;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #404040;
            --line-color: #555;
            --primary-color: #2a2a2a;
            --secondary-color: #6aa6fd;
            --accent-color: #e74c3c;
            --light-color: #e0e0e0;
            --dark-color: #1a1a1a;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --sidebar-width: 320px;
            --card-bg: #2a2a2a;
            --card-text: #e0e0e0;
            --modal-bg: #2a2a2a;
            --modal-text: #e0e0e0;
            --input-bg: #404040;
            --input-text: #e0e0e0;
            --input-border: #555;
            --bg-secondary: #2a2a2a;
        }

        [data-theme="dark"] {
            --male-color: #6aa6fd;
            --female-color: #f06292;
            --other-color: #888;
            --background-color: #0f0f0f;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --border-color: #2a2a2a;
            --line-color: #404040;
            --primary-color: #1a1a1a;
            --light-color: #e0e0e0;
            --dark-color: #0f0f0f;
            --card-bg: #1a1a1a;
            --card-text: #e0e0e0;
            --modal-bg: #1a1a1a;
            --modal-text: #e0e0e0;
            --input-bg: #2a2a2a;
            --input-text: #e0e0e0;
            --input-border: #404040;
            --bg-secondary: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--light-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 10;
            overflow: hidden;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--light-color);
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.1);
            border: none;
            color: var(--light-color);
            transition: background 0.2s;
        }

        .sidebar-tab.active {
            background: rgba(255,255,255,0.1);
            border-bottom: 2px solid var(--secondary-color);
        }

        .sidebar-tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* PERSON CARD */
        .person-card {
            background: var(--card-bg);
            color: var(--card-text);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .person-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            transition: width 0.3s;
        }
        
        .person-card.male::before {
            background: var(--male-color);
        }
        
        .person-card.female::before {
            background: var(--female-color);
        }
        
        .person-card.other::before {
            background: var(--other-color);
        }

        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .person-card:hover::before {
            width: 100%;
            opacity: 0.05;
        }

        .person-card.selected {
            background: linear-gradient(135deg, var(--secondary-color), rgba(106, 166, 253, 0.8));
            color: white;
            box-shadow: 0 4px 16px rgba(106, 166, 253, 0.4);
            border-color: var(--secondary-color);
        }
        
        .person-card.selected::before {
            width: 100%;
            opacity: 0.2;
        }

        .person-card-header {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .person-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .person-avatar.male {
            background: linear-gradient(135deg, var(--male-color), #5694f0);
        }
        
        .person-avatar.female {
            background: linear-gradient(135deg, var(--female-color), #d63384);
        }
        
        .person-avatar.other {
            background: linear-gradient(135deg, var(--other-color), #5a6c7d);
        }
        
        .person-avatar-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: var(--card-bg);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .person-card-main {
            flex: 1;
            min-width: 0;
        }

        .person-card-name {
            font-weight: 600;
            font-size: 13px;
            color: inherit;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .person-status-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .person-status-badge.alive {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .person-status-badge.deceased {
            background: rgba(149, 165, 166, 0.2);
            color: #7f8c8d;
        }

        .person-card-info {
            font-size: 11px;
            opacity: 0.85;
            color: inherit;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-card-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }
        
        .person-card.selected .person-card-actions {
            border-top-color: rgba(255, 255, 255, 0.2);
        }

        .person-card-actions button {
            padding: 4px 8px;
            font-size: 10px;
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
        }
        
        .person-card-actions button:hover {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .person-card.selected .person-card-actions button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .person-card.selected .person-card-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            padding: 10px;
            background-color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding: 0 10px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        /* CANVAS */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--background-color);
        }

        #familyTreeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
        }

        #familyTreeCanvas.dragging {
            cursor: grabbing;
        }

        /* BUTTONS */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            background-color: var(--secondary-color);
            color: white;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.success {
            background-color: var(--success-color);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* TOGGLE SWITCH */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        /* INPUTS */
        input, select, textarea {
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 13px;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-color);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--modal-text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background-color: var(--danger-color);
            color: white;
            border-radius: 4px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .photo-upload {
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            background-color: var(--input-bg);
            color: var(--input-text);
        }

        .photo-upload:hover {
            border-color: var(--secondary-color);
        }

        .photo-upload img {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
        }

        /* ENHANCED MODAL STYLES */
        .modal-content-enhanced {
            max-width: 650px;
            padding: 20px;
        }

        .form-section {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
        }

        .form-section-compact {
            padding: 10px;
            margin-bottom: 0;
        }

        .form-section legend {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-color);
            padding: 0 6px;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 12px;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .enhanced-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            font-size: 13px;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .enhanced-select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(106, 166, 253, 0.1);
        }

        .form-hint {
            display: block;
            margin-top: 3px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .gender-select-compact {
            display: flex;
            gap: 4px;
        }

        .radio-option-compact {
            width: 40px;
            height: 36px;
            padding: 0;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input-bg);
        }

        .radio-option-compact:hover {
            border-color: var(--secondary-color);
            background: var(--bg-secondary);
        }

        .radio-option-compact input[type="radio"] {
            display: none;
        }

        .radio-option-compact span {
            font-size: 18px;
        }

        .radio-option-compact:has(input:checked) {
            border-color: var(--secondary-color);
            background: var(--secondary-color);
        }

        .photo-upload-compact {
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            background-color: var(--input-bg);
            color: var(--input-text);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-upload-compact:hover {
            border-color: var(--secondary-color);
        }

        .photo-upload-compact img {
            max-width: 100%;
            max-height: 80px;
            border-radius: 4px;
        }

        .photo-upload-compact #photoText {
            font-size: 24px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-primary {
            flex: 1;
            padding: 10px 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            flex: 1;
            padding: 10px 20px;
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .enhanced-select {
            cursor: pointer;
        }

        .enhanced-select option {
            padding: 6px;
        }

        /* SEARCH & FILTER */
        .search-box {
            margin-bottom: 10px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(106, 166, 253, 0.1);
            outline: none;
        }

        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            pointer-events: none;
        }

        .filter-options {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 5px 10px;
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .filter-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }

        .filter-chip.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 2px 8px rgba(106, 166, 253, 0.3);
        }

        /* STATISTICS */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--card-bg);
            color: var(--card-text);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-color);
            transition: height 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        .stat-card:hover::before {
            height: 100%;
            opacity: 0.05;
        }

        .stat-card.male::before {
            background: linear-gradient(135deg, var(--male-color), #5694f0);
        }

        .stat-card.female::before {
            background: linear-gradient(135deg, var(--female-color), #d63384);
        }
        
        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(106, 166, 253, 0.1), rgba(155, 89, 182, 0.05));
            border-color: var(--secondary-color);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.75;
            margin-bottom: 8px;
            color: inherit;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-icon {
            font-size: 16px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: inherit;
            line-height: 1;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card.male .stat-value {
            background: linear-gradient(135deg, var(--male-color), #5694f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card.female .stat-value {
            background: linear-gradient(135deg, var(--female-color), #d63384);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-subvalue {
            font-size: 13px;
            opacity: 0.6;
            font-weight: 500;
        }

        .stat-detail {
            font-size: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            color: inherit;
        }

        .stat-detail-label {
            opacity: 0.75;
            color: inherit;
            margin-bottom: 6px;
            line-height: 1.5;
        }
        
        .stat-detail-label strong {
            opacity: 1;
            font-weight: 600;
        }
        
        .stat-progress {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .stat-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--male-color));
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        
        .stat-progress-bar.male {
            background: linear-gradient(90deg, var(--male-color), #5694f0);
        }
        
        .stat-progress-bar.female {
            background: linear-gradient(90deg, var(--female-color), #d63384);
        }
        
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        }

        /* SETTINGS */
        .settings-section {
            background: var(--card-bg);
            margin-bottom: 20px;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .settings-section:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .settings-section:last-child {
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section h3 {
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-section p.description {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .color-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .color-picker:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }
        
        .color-picker label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
        }

        .color-picker input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-picker input[type="color"]:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .setting-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-info .setting-title {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .setting-info .setting-desc {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .setting-control {
            min-width: 150px;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        
        .button-group.full {
            grid-template-columns: 1fr;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-color);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .empty-state p {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 20px;
        }

        /* MINI MAP */
        .mini-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* ZOOM CONTROLS */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 5;
        }

        .zoom-controls button {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 18px;
            background-color: var(--card-bg);
            color: var(--card-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* PROGRESS BAR */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--light-color);
            z-index: 9999;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
            width: 0;
        }

        /* TUTORIAL */
        .tutorial-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tutorial-content h2 {
            color: var(--modal-text);
            margin-bottom: 20px;
        }

        .tutorial-content h3 {
            color: var(--modal-text);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .tutorial-content p, .tutorial-content li {
            color: var(--modal-text);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .tutorial-content ul {
            margin-left: 20px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--line-color);
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar">
        <div class="progress-bar-fill" id="progressBarFill"></div>
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üå≥ Heritage</h1>
                <button onclick="toggleSidebar()">‚ò∞</button>
            </div>
            
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('people')">üë• Osoby</button>
                <button class="sidebar-tab" onclick="switchTab('stats')">üìä Statistiky</button>
                <button class="sidebar-tab" onclick="switchTab('settings')">‚öôÔ∏è Nastaven√≠</button>
            </div>
            
            <div class="sidebar-content">
                <!-- PEOPLE TAB -->
                <div id="peopleTab" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 13px; font-weight: 500; color: var(--text-color);">
                            <span style="font-size: 16px; margin-right: 4px;">üë•</span>
                            <span id="peopleCount">0 osob</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted);">
                            <span id="peopleFiltered"></span>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Hledat..." onkeyup="filterPeople()">
                    </div>
                    
                    <div class="filter-options">
                        <div class="filter-chip active" onclick="toggleFilter(this, 'all')">
                            <span>‚ú®</span> V≈°ichni
                        </div>
                        <div class="filter-chip" onclick="toggleFilter(this, 'male')">
                            <span>‚ôÇÔ∏è</span> Mu≈æi
                        </div>
                        <div class="filter-chip" onclick="toggleFilter(this, 'female')">
                            <span>‚ôÄÔ∏è</span> ≈Ωeny
                        </div>
                        <div class="filter-chip" onclick="toggleFilter(this, 'alive')">
                            <span>üíö</span> ≈Ωij√≠c√≠
                        </div>
                        <div class="filter-chip" onclick="toggleFilter(this, 'deceased')">
                            <span>üïäÔ∏è</span> Zem≈ôel√≠
                        </div>
                    </div>
                    
                    <div id="peopleList"></div>
                </div>
                
                <!-- STATISTICS TAB -->
                <div id="statsTab" class="tab-content">
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-color); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìä</span> P≈ôehled rodokmenu
                        </h3>
                        <p style="font-size: 13px; color: var(--text-muted); margin: 0;">
                            Statistick√© √∫daje o va≈°em rodokmenu
                        </p>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-card highlight">
                            <div class="stat-label">
                                <span class="stat-icon">üë•</span> Celkem osob
                            </div>
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-subvalue">v rodokmenu</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">
                                <span class="stat-icon">üå≥</span> Generac√≠
                            </div>
                            <div class="stat-value" id="statGenerations">0</div>
                            <div class="stat-subvalue">√∫rovn√≠</div>
                        </div>
                        <div class="stat-card male">
                            <div class="stat-label">
                                <span class="stat-icon">‚ôÇÔ∏è</span> Mu≈æi
                            </div>
                            <div class="stat-value" id="statMale">0</div>
                            <div class="stat-progress">
                                <div class="stat-progress-bar male" id="statMaleBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="stat-card female">
                            <div class="stat-label">
                                <span class="stat-icon">‚ôÄÔ∏è</span> ≈Ωeny
                            </div>
                            <div class="stat-value" id="statFemale">0</div>
                            <div class="stat-progress">
                                <div class="stat-progress-bar female" id="statFemaleBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="margin-bottom: 16px;">
                        <div class="stat-label">
                            <span class="stat-icon">üéÇ</span> Vƒõkov√° struktura
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 12px;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Pr≈Ømƒõr</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary-color);" id="statAvgAge">-</div>
                                <div style="font-size: 11px; opacity: 0.6;">let</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Nejstar≈°√≠</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning-color);" id="statOldest">-</div>
                                <div style="font-size: 11px; opacity: 0.6;">let</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Nejmlad≈°√≠</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--success-color);" id="statYoungest">-</div>
                                <div style="font-size: 11px; opacity: 0.6;">let</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="margin-bottom: 16px;">
                        <div class="stat-label">
                            <span class="stat-icon">üíö</span> Status
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">≈Ωij√≠c√≠ch</div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--success-color);" id="statAlive">-</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Zem≈ôel√Ωch</div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--text-muted);" id="statDeceased">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="margin-bottom: 16px;">
                        <div class="stat-label">
                            <span class="stat-icon">‚ú®</span> Nejƒçastƒõj≈°√≠ jm√©na
                        </div>
                        <div class="stat-detail">
                            <div id="statCommonNames" style="display: flex; flex-wrap: wrap; gap: 6px;">-</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">
                            <span class="stat-icon">üìç</span> Nejƒçastƒõj≈°√≠ m√≠sta narozen√≠
                        </div>
                        <div class="stat-detail">
                            <div id="statCommonPlaces" style="display: flex; flex-wrap: wrap; gap: 6px;">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- SETTINGS TAB -->
                <div id="settingsTab" class="tab-content">
                    <!-- Vzhled -->
                    <div class="settings-section">
                        <h3>üé® Vzhled & T√©ma</h3>
                        <p class="description">P≈ôizp≈Øsobte si vzhled aplikace podle sv√Ωch preferenc√≠</p>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-title">Barevn√© t√©ma</div>
                                <div class="setting-desc">Vyberte svƒõtl√Ω, tmav√Ω nebo automatick√Ω re≈æim</div>
                            </div>
                            <div class="setting-control">
                                <select id="themeMode" onchange="changeTheme()">
                                    <option value="light">‚òÄÔ∏è Svƒõtl√©</option>
                                    <option value="dark">üåô Tmav√©</option>
                                    <option value="auto">üîÑ Automatick√©</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="font-weight: 500; margin-bottom: 12px; display: block;">Barvy podle pohlav√≠</label>
                            <div class="color-picker-group">
                                <div class="color-picker">
                                    <label>‚ôÇ Mu≈æi</label>
                                    <input type="color" id="colorMale" value="#3498db" onchange="updateColors()">
                                    <span id="colorMaleValue" style="font-size: 11px; text-align: center; color: var(--text-muted);">#3498db</span>
                                </div>
                                <div class="color-picker">
                                    <label>‚ôÄ ≈Ωeny</label>
                                    <input type="color" id="colorFemale" value="#e84393" onchange="updateColors()">
                                    <span id="colorFemaleValue" style="font-size: 11px; text-align: center; color: var(--text-muted);">#e84393</span>
                                </div>
                                <div class="color-picker">
                                    <label>‚öß Ostatn√≠</label>
                                    <input type="color" id="colorOther" value="#7f8c8d" onchange="updateColors()">
                                    <span id="colorOtherValue" style="font-size: 11px; text-align: center; color: var(--text-muted);">#7f8c8d</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zobrazen√≠ stromu -->
                    <div class="settings-section">
                        <h3>üìê Zobrazen√≠ stromu</h3>
                        <p class="description">Nastavte si, jak se m√° rodokmen zobrazovat na canvasu</p>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-title">√örove≈à detail≈Ø</div>
                                <div class="setting-desc">Kolik informac√≠ zobrazit u ka≈æd√© osoby</div>
                            </div>
                            <div class="setting-control">
                                <select id="viewStyle" onchange="changeViewStyle()">
                                    <option value="detailed">üìã Detailn√≠</option>
                                    <option value="compact">üìÑ Kompaktn√≠</option>
                                    <option value="minimal">üìå Minim√°ln√≠</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-title">Orientace stromu</div>
                                <div class="setting-desc">Smƒõr r≈Østu rodokmenn√©ho stromu</div>
                            </div>
                            <div class="setting-control">
                                <select id="layoutStyle" onchange="changeLayout()">
                                    <option value="vertical">‚Üì Vertik√°ln√≠</option>
                                    <option value="horizontal">‚Üí Horizont√°ln√≠</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-title">Minimapa</div>
                                <div class="setting-desc">Zobrazit mal√Ω p≈ôehled stromu v rohu</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="showMiniMap" onchange="toggleMiniMap()" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Import & Export -->
                    <div class="settings-section">
                        <h3>üíæ Import & Export</h3>
                        <p class="description">Z√°lohujte sv√° data nebo je sd√≠lejte v r≈Øzn√Ωch form√°tech</p>
                        
                        <div class="button-group">
                            <button onclick="importData()" style="background: #27ae60;">
                                <span style="font-size: 16px;">üì•</span> Importovat
                            </button>
                            <button onclick="exportData()" style="background: #3498db;">
                                <span style="font-size: 16px;">üíæ</span> Exportovat JSON
                            </button>
                            <button onclick="exportPDF()" style="background: #e74c3c;">
                                <span style="font-size: 16px;">üìÑ</span> Export PDF
                            </button>
                            <button onclick="exportSVG()" style="background: #9b59b6;">
                                <span style="font-size: 16px;">üé®</span> Export SVG
                            </button>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 12px; color: var(--text-muted);">
                            üí° <strong>Tip:</strong> Aplikace automaticky ukl√°d√° v≈°echna data do prohl√≠≈æeƒçe. Export pou≈æijte pro z√°lohu nebo sd√≠len√≠.
                        </div>
                    </div>
                    
                    <!-- N√°stroje & Pomoc -->
                    <div class="settings-section">
                        <h3>üõ†Ô∏è N√°stroje & Pomoc</h3>
                        <p class="description">U≈æiteƒçn√© funkce pro pr√°ci s aplikac√≠</p>
                        
                        <div class="button-group">
                            <button onclick="showTutorial()" style="background: #16a085;">
                                <span style="font-size: 16px;">üìñ</span> Zobrazit tutorial
                            </button>
                            <button onclick="addSampleData()" style="background: #f39c12;">
                                <span style="font-size: 16px;">üé≤</span> Uk√°zkov√° data
                            </button>
                            <button onclick="autoLayout()" style="background: #8e44ad;">
                                <span style="font-size: 16px;">üîÑ</span> Auto layout
                            </button>
                            <button onclick="resetManualPositions()" style="background: #e67e22;">
                                <span style="font-size: 16px;">üîì</span> Reset ruƒçn√≠ch pozic
                            </button>
                            <button onclick="fitToScreen()" style="background: #5694f0;">
                                <span style="font-size: 16px;">üñºÔ∏è</span> P≈ôizp≈Øsobit
                            </button>
                        </div>
                    </div>
                    
                    <!-- Nebezpeƒçn√° z√≥na -->
                    <div class="settings-section" style="border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.05);">
                        <h3>‚ö†Ô∏è Nebezpeƒçn√° z√≥na</h3>
                        <p class="description">Akce, kter√© nelze vr√°tit zpƒõt - pou≈æ√≠vejte opatrnƒõ!</p>
                        
                        <div class="button-group full">
                            <button class="danger" onclick="clearAll()">
                                <span style="font-size: 16px;">üóëÔ∏è</span> Vymazat v≈°echna data
                            </button>
                            <button class="danger" onclick="clearAllSettings()">
                                <span style="font-size: 16px;">üí£</span> Vymazat v≈°e vƒçetnƒõ nastaven√≠
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button onclick="toggleSidebar()">‚ò∞</button>
                    <button onclick="openPersonModal()">‚ûï Nov√° osoba</button>
                </div>
                
                <div class="toolbar-group">
                    <button onclick="undo()" id="undoBtn" disabled>‚Ü∂ Zpƒõt</button>
                    <button onclick="redo()" id="redoBtn" disabled>‚Ü∑ Znovu</button>
                </div>
                
                <div class="toolbar-group">
                    <button onclick="zoomIn()">üîç+</button>
                    <button onclick="zoomOut()">üîç-</button>
                    <button onclick="resetZoom()">üéØ Reset</button>
                </div>
                
                <div class="toolbar-group">
                    <button onclick="autoLayout()">üîÑ Auto layout</button>
                    <button onclick="fitToScreen()">‚õ∂ P≈ôizp≈Øsobit</button>
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="familyTreeCanvas"></canvas>
                
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">üå≥</div>
                    <h3>Zaƒçnƒõte vytv√°≈ôet sv≈Øj rodokmen</h3>
                    <p>Kliknƒõte na "‚ûï Nov√° osoba" pro p≈ôid√°n√≠ prvn√≠ osoby</p>
                    <button onclick="addSampleData()">üé≤ Nebo p≈ôidejte uk√°zkov√° data</button>
                </div>
                
                <canvas id="miniMap" class="mini-map"></canvas>
                
                <div class="zoom-controls">
                    <button onclick="zoomIn()">+</button>
                    <button onclick="zoomOut()">‚àí</button>
                    <button onclick="resetZoom()">‚ü≤</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PERSON MODAL -->
    <div id="personModal" class="modal">
        <div class="modal-content modal-content-enhanced">
            <div class="modal-header">
                <h2 id="modalTitle">Nov√° osoba</h2>
                <button class="close-btn" onclick="closePersonModal()">√ó</button>
            </div>
            
            <form id="personForm" onsubmit="savePerson(event)">
                <!-- Z√°kladn√≠ informace + Pohlav√≠ -->
                <fieldset class="form-section">
                    <legend>üë§ Z√°kladn√≠ √∫daje</legend>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Jm√©no *</label>
                            <input type="text" id="firstName" required placeholder="Jan">
                        </div>
                        <div class="form-group">
                            <label>P≈ô√≠jmen√≠ *</label>
                            <input type="text" id="lastName" required placeholder="Nov√°k">
                        </div>
                        <div class="form-group">
                            <label>Pohlav√≠</label>
                            <div class="gender-select-compact">
                                <label class="radio-option-compact">
                                    <input type="radio" name="gender" id="genderMale" value="male" checked>
                                    <span>‚ôÇ</span>
                                </label>
                                <label class="radio-option-compact">
                                    <input type="radio" name="gender" id="genderFemale" value="female">
                                    <span>‚ôÄ</span>
                                </label>
                                <label class="radio-option-compact">
                                    <input type="radio" name="gender" id="genderOther" value="other">
                                    <span>‚öß</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </fieldset>
                
                <!-- Narozen√≠ a √ömrt√≠ - 2 sloupce -->
                <div class="form-row">
                    <fieldset class="form-section form-section-compact">
                        <legend>üìÖ Narozen√≠</legend>
                        <div class="form-group">
                            <label>Datum</label>
                            <input type="date" id="birthDate">
                        </div>
                        <div class="form-group">
                            <label>M√≠sto</label>
                            <input type="text" id="birthPlace" placeholder="Praha">
                        </div>
                    </fieldset>
                    
                    <fieldset class="form-section form-section-compact">
                        <legend>üïäÔ∏è √ömrt√≠</legend>
                        <div class="form-group">
                            <label>Datum</label>
                            <input type="date" id="deathDate">
                        </div>
                        <div class="form-group">
                            <label>M√≠sto</label>
                            <input type="text" id="deathPlace" placeholder="Praha">
                        </div>
                    </fieldset>
                </div>
                
                <!-- Rodinn√© vztahy - 2 sloupce -->
                <div class="form-row">
                    <fieldset class="form-section form-section-compact">
                        <legend>üë™ Rodiƒçe</legend>
                        <div class="form-group">
                            <select id="parent1" onchange="updateParent2Options()" class="enhanced-select">
                                <option value="">Rodiƒç 1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="parent2" class="enhanced-select">
                                <option value="">Rodiƒç 2</option>
                            </select>
                        </div>
                    </fieldset>
                    
                    <fieldset class="form-section form-section-compact">
                        <legend>üíë Partner/ka</legend>
                        <div class="form-group">
                            <select id="partner" multiple class="enhanced-select" style="height: 70px;">
                            </select>
                            <small class="form-hint">Ctrl/Cmd pro v√≠ce</small>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Fotografie a pozn√°mky - 2 sloupce -->
                <div class="form-row">
                    <fieldset class="form-section form-section-compact">
                        <legend>üì∑ Fotografie</legend>
                        <div class="photo-upload-compact" onclick="document.getElementById('photoInput').click()">
                            <div id="photoText">üì∑</div>
                            <img id="photoPreview" style="display: none;">
                        </div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                    </fieldset>
                    
                    <fieldset class="form-section form-section-compact">
                        <legend>üìù Pozn√°mky</legend>
                        <div class="form-group">
                            <textarea id="notes" rows="2" placeholder="Dodateƒçn√© info..."></textarea>
                        </div>
                    </fieldset>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">üíæ Ulo≈æit</button>
                    <button type="button" class="btn-secondary" onclick="closePersonModal()">‚ùå Zru≈°it</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- TUTORIAL OVERLAY -->
    <div id="tutorialOverlay" class="tutorial-overlay">
        <div class="tutorial-content">
            <div class="modal-header">
                <h2>üéì N√°vod k pou≈æit√≠ Heritage</h2>
                <button class="close-btn" onclick="closeTutorial()">√ó</button>
            </div>
            
            <h3>üåü Z√°kladn√≠ ovl√°d√°n√≠</h3>
            <ul>
                <li><strong>P≈ôid√°n√≠ osoby:</strong> Kliknƒõte na "‚ûï Nov√° osoba" v horn√≠ li≈°tƒõ</li>
                <li><strong>√öprava osoby:</strong> Dvojklik na osobu v canvasu NEBO kliknƒõte na osobu v seznamu a pak na tlaƒç√≠tko ‚úèÔ∏è</li>
                <li><strong>Maz√°n√≠:</strong> Tlaƒç√≠tko üóëÔ∏è u ka≈æd√© osoby</li>
                <li><strong>P≈ôesun osoby:</strong> Podr≈æte kl√°vesu CTRL a t√°hnƒõte osobu lev√Ωm tlaƒç√≠tkem my≈°i na novou pozici</li>
                <li><strong>Navigace:</strong> T√°hnƒõte plochou pro posun, koleƒçkem my≈°i pro zoom</li>
                <li><strong>Tip:</strong> P≈ôi najet√≠ my≈°√≠ na osobu se zmƒõn√≠ kurzor na üëÜ - dvojklik otev≈ôe detail</li>
            </ul>
            
            <h3>üîó Propojen√≠ osob</h3>
            <ul>
                <li>P≈ôi √∫pravƒõ osoby m≈Ø≈æete vybrat rodiƒçe a partnery z existuj√≠c√≠ch osob</li>
                <li>Vztahy se automaticky prom√≠tnou do stromu</li>
                <li>M≈Ø≈æete m√≠t v√≠ce partner≈Ø najednou</li>
            </ul>
            
            <h3>üé® P≈ôizp≈Øsoben√≠</h3>
            <ul>
                <li>V z√°lo≈æce Nastaven√≠ m≈Ø≈æete zmƒõnit t√©ma, barvy a rozlo≈æen√≠</li>
                <li>Podpora svƒõtl√©ho i tmav√©ho re≈æimu</li>
                <li>R≈Øzn√© styly zobrazen√≠: detailn√≠, kompaktn√≠, minim√°ln√≠</li>
                <li><strong>Auto layout:</strong> Automaticky uspo≈ô√°d√° strom, zachov√°v√° ruƒçnƒõ p≈ôesunut√© osoby</li>
                <li><strong>Reset ruƒçn√≠ch pozic:</strong> Odstran√≠ v≈°echny ruƒçn√≠ √∫pravy pozic, dal≈°√≠ Auto layout uspo≈ô√°d√° v≈°e znovu</li>
            </ul>
            
            <h3>üíæ Import & Export</h3>
            <ul>
                <li>Exportujte data do JSON pro z√°lohu</li>
                <li>Importujte data zpƒõt nebo sd√≠lejte s ostatn√≠mi</li>
                <li>Export do PDF pro tisk</li>
                <li>Export do SVG pro vektorovou grafiku (upraviteln√© v Adobe Illustrator, Inkscape)</li>
            </ul>
            
            <h3>üìä Statistiky</h3>
            <ul>
                <li>Sledujte poƒçet osob, generac√≠ a dal≈°√≠ √∫daje</li>
                <li>Nejƒçastƒõj≈°√≠ jm√©na a m√≠sta narozen√≠</li>
                <li>Filtrov√°n√≠ podle pohlav√≠ a dal≈°√≠ch krit√©ri√≠</li>
            </ul>
            
            <button onclick="closeTutorial()" style="margin-top: 20px; width: 100%;">‚úÖ Rozum√≠m</button>
        </div>
    </div>

    <script>
        // ==================== APPLICATION STATE ====================
        const app = {
            people: [],
            selectedPerson: null,
            editingPerson: null,
            zoom: 1,
            panX: 0,
            panY: 0,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            viewStyle: 'detailed',
            layoutStyle: 'vertical',
            history: [],
            historyIndex: -1,
            filterGender: 'all',
            filterStatus: 'all',
            // Drag person variables
            isDraggingPerson: false,
            draggedPerson: null,
            personDragOffsetX: 0,
            personDragOffsetY: 0
        };

        // ==================== SETTINGS PERSISTENCE ====================
        function loadSettings() {
            try {
                // Load theme
                const theme = localStorage.getItem('heritage_theme') || 'light';
                document.getElementById('themeMode').value = theme;
                changeTheme();
                
                // Load colors
                const colorMale = localStorage.getItem('heritage_color_male') || '#3498db';
                const colorFemale = localStorage.getItem('heritage_color_female') || '#e84393';
                const colorOther = localStorage.getItem('heritage_color_other') || '#7f8c8d';
                document.getElementById('colorMale').value = colorMale;
                document.getElementById('colorFemale').value = colorFemale;
                document.getElementById('colorOther').value = colorOther;
                updateColors();
                
                // Load view style
                const viewStyle = localStorage.getItem('heritage_view_style') || 'detailed';
                app.viewStyle = viewStyle;
                document.getElementById('viewStyle').value = viewStyle;
                
                // Load layout style
                const layoutStyle = localStorage.getItem('heritage_layout_style') || 'vertical';
                app.layoutStyle = layoutStyle;
                document.getElementById('layoutStyle').value = layoutStyle;
                
                // Load minimap setting
                const showMiniMap = localStorage.getItem('heritage_show_minimap') !== 'false';
                document.getElementById('showMiniMap').checked = showMiniMap;
                document.getElementById('miniMap').style.display = showMiniMap ? 'block' : 'none';
                
                // Load people data
                const peopleData = localStorage.getItem('heritage_people_data');
                if (peopleData) {
                    const parsed = JSON.parse(peopleData);
                    app.people = Array.isArray(parsed) ? parsed : [];
                    saveToHistory();
                    updateUI();
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠:', error);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('heritage_theme', document.getElementById('themeMode').value);
                localStorage.setItem('heritage_color_male', document.getElementById('colorMale').value);
                localStorage.setItem('heritage_color_female', document.getElementById('colorFemale').value);
                localStorage.setItem('heritage_color_other', document.getElementById('colorOther').value);
                localStorage.setItem('heritage_view_style', app.viewStyle);
                localStorage.setItem('heritage_layout_style', app.layoutStyle);
                localStorage.setItem('heritage_show_minimap', document.getElementById('showMiniMap').checked);
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠:', error);
            }
        }

        function savePeopleData() {
            try {
                localStorage.setItem('heritage_people_data', JSON.stringify(app.people));
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ dat:', error);
            }
        }

        // ==================== CANVAS SETUP ====================
        const canvas = document.getElementById('familyTreeCanvas');
        const ctx = canvas.getContext('2d');
        const miniMap = document.getElementById('miniMap');
        const miniCtx = miniMap.getContext('2d');

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            redrawTree();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Helper function to get person at canvas coordinates
        function getPersonAtPosition(canvasX, canvasY) {
            // Iterate through people in reverse order (top to bottom in rendering)
            for (let i = app.people.length - 1; i >= 0; i--) {
                const person = app.people[i];
                const width = 150;
                const height = app.viewStyle === 'minimal' ? 60 : 100;
                
                if (canvasX >= person.x && canvasX <= person.x + width &&
                    canvasY >= person.y && canvasY <= person.y + height) {
                    return person;
                }
            }
            return null;
        }

        // ==================== CANVAS INTERACTION ====================
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const canvasX = (mouseX - app.panX) / app.zoom;
            const canvasY = (mouseY - app.panY) / app.zoom;
            
            // Check if CTRL is pressed and left mouse button
            if (e.ctrlKey && e.button === 0) {
                // Check if clicking on a person
                const person = getPersonAtPosition(canvasX, canvasY);
                if (person) {
                    app.isDraggingPerson = true;
                    app.draggedPerson = person;
                    app.personDragOffsetX = canvasX - person.x;
                    app.personDragOffsetY = canvasY - person.y;
                    canvas.style.cursor = 'move';
                    e.preventDefault();
                    return;
                }
            }
            
            // Normal canvas panning
            app.isDragging = true;
            app.dragStartX = e.clientX - app.panX;
            app.dragStartY = e.clientY - app.panY;
            app.mouseDownX = e.clientX;
            app.mouseDownY = e.clientY;
            app.hasDragged = false;
            canvas.classList.add('dragging');
            canvas.style.cursor = 'grabbing';
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Dragging person with CTRL
            if (app.isDraggingPerson && app.draggedPerson) {
                const canvasX = (mouseX - app.panX) / app.zoom;
                const canvasY = (mouseY - app.panY) / app.zoom;
                
                app.draggedPerson.x = canvasX - app.personDragOffsetX;
                app.draggedPerson.y = canvasY - app.personDragOffsetY;
                
                redrawTree();
                return;
            }
            
            // Normal canvas panning
            if (app.isDragging) {
                const deltaX = Math.abs(e.clientX - app.mouseDownX);
                const deltaY = Math.abs(e.clientY - app.mouseDownY);
                if (deltaX > 3 || deltaY > 3) {
                    app.hasDragged = true;
                }
                app.panX = e.clientX - app.dragStartX;
                app.panY = e.clientY - app.dragStartY;
                redrawTree();
            } else {
                // Check if hovering over a person or button
                const canvasX = (mouseX - app.panX) / app.zoom;
                const canvasY = (mouseY - app.panY) / app.zoom;
                
                // Kontrola hover nad tlaƒç√≠tky
                let hoverButton = false;
                if (app.selectedPerson && app.actionButtons && app.actionButtons[app.selectedPerson]) {
                    for (const button of app.actionButtons[app.selectedPerson]) {
                        if (canvasX >= button.x && canvasX <= button.x + button.size &&
                            canvasY >= button.y && canvasY <= button.y + button.size) {
                            hoverButton = true;
                            break;
                        }
                    }
                }
                
                const hoveredPerson = app.people.find(person => {
                    const width = 150;
                    const height = app.viewStyle === 'minimal' ? 60 : 100;
                    return canvasX >= person.x && canvasX <= person.x + width &&
                           canvasY >= person.y && canvasY <= person.y + height;
                });
                
                canvas.style.cursor = hoverButton || hoveredPerson ? 'pointer' : 'grab';
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            // Handle person dragging end
            if (app.isDraggingPerson) {
                // Mark person as manually positioned
                if (app.draggedPerson) {
                    app.draggedPerson.manuallyPositioned = true;
                }
                
                app.isDraggingPerson = false;
                app.draggedPerson = null;
                canvas.style.cursor = 'grab';
                
                // Save changes
                saveToHistory();
                savePeopleData();
                redrawTree();
                return;
            }
            
            // Normal canvas panning end
            const wasDragging = app.hasDragged;
            app.isDragging = false;
            canvas.classList.remove('dragging');
            canvas.style.cursor = 'grab';
            
            // If didn't drag, treat as click to select person
            if (!wasDragging) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const canvasX = (mouseX - app.panX) / app.zoom;
                const canvasY = (mouseY - app.panY) / app.zoom;
                
                // Kontrola kliknut√≠ na action tlaƒç√≠tka
                let clickedButton = false;
                if (app.selectedPerson && app.actionButtons && app.actionButtons[app.selectedPerson]) {
                    for (const button of app.actionButtons[app.selectedPerson]) {
                        if (canvasX >= button.x && canvasX <= button.x + button.size &&
                            canvasY >= button.y && canvasY <= button.y + button.size) {
                            button.onClick();
                            clickedButton = true;
                            break;
                        }
                    }
                }
                
                if (!clickedButton) {
                    // Kontrola kliknut√≠ na osobu
                    const clickedPerson = app.people.find(person => {
                        const width = 150;
                        const height = app.viewStyle === 'minimal' ? 60 : 100;
                        return canvasX >= person.x && canvasX <= person.x + width &&
                               canvasY >= person.y && canvasY <= person.y + height;
                    });
                    
                    if (clickedPerson) {
                        selectPerson(clickedPerson.id);
                    } else {
                        // Kliknut√≠ mimo osobu - odznaƒçit v√Ωbƒõr
                        deselectPerson();
                    }
                }
            }
        });

        canvas.addEventListener('mouseleave', () => {
            app.isDragging = false;
            canvas.classList.remove('dragging');
            canvas.style.cursor = 'grab';
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            app.zoom = Math.max(0.1, Math.min(3, app.zoom * delta));
            redrawTree();
        });

        // Double-click to open person detail
        canvas.addEventListener('dblclick', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Convert screen coordinates to canvas coordinates
            const canvasX = (mouseX - app.panX) / app.zoom;
            const canvasY = (mouseY - app.panY) / app.zoom;
            
            // Find person at click position
            const clickedPerson = app.people.find(person => {
                const width = 150;
                const height = app.viewStyle === 'minimal' ? 60 : 100;
                return canvasX >= person.x && canvasX <= person.x + width &&
                       canvasY >= person.y && canvasY <= person.y + height;
            });
            
            if (clickedPerson) {
                openPersonModal(clickedPerson.id);
            }
        });

        // ==================== ZOOM CONTROLS ====================
        function zoomIn() {
            app.zoom = Math.min(3, app.zoom * 1.2);
            redrawTree();
        }

        function zoomOut() {
            app.zoom = Math.max(0.1, app.zoom / 1.2);
            redrawTree();
        }

        function resetZoom() {
            app.zoom = 1;
            app.panX = 0;
            app.panY = 0;
            redrawTree();
        }

        function fitToScreen() {
            if (app.people.length === 0) return;
            
            const padding = 50;
            const minX = Math.min(...app.people.map(p => p.x)) - padding;
            const maxX = Math.max(...app.people.map(p => p.x + 150)) + padding;
            const minY = Math.min(...app.people.map(p => p.y)) - padding;
            const maxY = Math.max(...app.people.map(p => p.y + 100)) + padding;
            
            const treeWidth = maxX - minX;
            const treeHeight = maxY - minY;
            
            const zoomX = canvas.width / treeWidth;
            const zoomY = canvas.height / treeHeight;
            app.zoom = Math.min(zoomX, zoomY, 1);
            
            app.panX = (canvas.width - treeWidth * app.zoom) / 2 - minX * app.zoom;
            app.panY = (canvas.height - treeHeight * app.zoom) / 2 - minY * app.zoom;
            
            redrawTree();
        }

        // ==================== DRAWING ====================
        function redrawTree() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw subtle background
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const bgGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            if (isDark) {
                bgGradient.addColorStop(0, '#1a1a2e');
                bgGradient.addColorStop(1, '#16213e');
            } else {
                bgGradient.addColorStop(0, '#f5f7fa');
                bgGradient.addColorStop(1, '#e8eef5');
            }
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw subtle grid pattern
            ctx.save();
            ctx.strokeStyle = isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            ctx.restore();
            
            ctx.save();
            ctx.translate(app.panX, app.panY);
            ctx.scale(app.zoom, app.zoom);
            
            // Draw connections first
            app.people.forEach(person => {
                drawConnections(person);
            });
            
            // Draw persons
            app.people.forEach(person => {
                drawPerson(person);
            });
            
            ctx.restore();
            
            drawMiniMap();
        }

        function drawPerson(person) {
            const x = person.x;
            const y = person.y;
            const width = 150;
            const height = app.viewStyle === 'minimal' ? 60 : 100;
            const radius = 10; // Rounded corners
            const isSelected = app.selectedPerson === person.id;
            
            // Get colors based on theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#ecf0f1' : '#2c3e50';
            const borderColor = person.gender === 'male' ? 
                getComputedStyle(document.documentElement).getPropertyValue('--male-color') :
                person.gender === 'female' ?
                getComputedStyle(document.documentElement).getPropertyValue('--female-color') :
                getComputedStyle(document.documentElement).getPropertyValue('--other-color');
            
            // Create gradient for background
            const gradient = ctx.createLinearGradient(x, y, x, y + height);
            if (isSelected) {
                gradient.addColorStop(0, isDark ? '#34495e' : '#f8f9fa');
                gradient.addColorStop(1, isDark ? '#2c3e50' : '#e9ecef');
            } else {
                gradient.addColorStop(0, isDark ? '#2c3e50' : '#ffffff');
                gradient.addColorStop(1, isDark ? '#1a252f' : '#f8f9fa');
            }
            
            // Highlight selected person with glow
            if (isSelected) {
                ctx.shadowColor = borderColor;
                ctx.shadowBlur = 25;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            } else {
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;
            }
            
            // Draw rounded rectangle background
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.arcTo(x + width, y, x + width, y + radius, radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
            ctx.lineTo(x + radius, y + height);
            ctx.arcTo(x, y + height, x, y + height - radius, radius);
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
            ctx.fill();
            
            // Border with accent color (thicker for selected)
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = isSelected ? 4 : 3;
            ctx.stroke();
            
            // Add subtle top accent bar
            ctx.fillStyle = borderColor;
            ctx.globalAlpha = 0.2;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.arcTo(x + width, y, x + width, y + radius, radius);
            ctx.lineTo(x + width, y + 20);
            ctx.lineTo(x, y + 20);
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1.0;
            
            ctx.shadowColor = 'transparent';
            
            // Gender icon
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'left';
            const genderIcon = person.gender === 'male' ? '‚ôÇ' : person.gender === 'female' ? '‚ôÄ' : '‚öß';
            ctx.fillStyle = borderColor;
            ctx.fillText(genderIcon, x + 8, y + 18);
            
            // Name
            ctx.fillStyle = textColor;
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${person.firstName} ${person.lastName}`, x + width/2, y + 30);
            
            if (app.viewStyle !== 'minimal') {
                // Years
                ctx.font = '11px sans-serif';
                ctx.fillStyle = isDark ? '#95a5a6' : '#7f8c8d';
                const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '';
                const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : '';
                const years = birthYear && deathYear ? `${birthYear} - ${deathYear}` :
                              birthYear ? `‚ú± ${birthYear}` : '';
                ctx.fillText(years, x + width/2, y + 50);
                
                if (person.birthPlace && app.viewStyle === 'detailed') {
                    ctx.fillText(`üìç ${person.birthPlace}`, x + width/2, y + 70);
                }
                
                const age = getPersonAge(person);
                if (age !== null && app.viewStyle === 'detailed') {
                    ctx.fillStyle = borderColor;
                    ctx.font = 'bold 11px sans-serif';
                    const ageText = person.deathDate ? `‚Ä† ${age} let` : `${age} let`;
                    ctx.fillText(ageText, x + width/2, y + 88);
                }
            }
            
            // Draw action buttons for selected person
            if (isSelected) {
                drawActionButtons(person, x, y, width, height);
            }
        }

        function drawActionButtons(person, x, y, width, height) {
            const buttonSize = 32;
            const buttonSpacing = 8;
            const buttonsY = y + height + 10;
            
            // Poƒçet rodiƒç≈Ø
            const parentsCount = person.parents ? person.parents.length : 0;
            const canAddParent = parentsCount < 2;
            
            // Urƒçen√≠ pohlav√≠ nov√©ho rodiƒçe
            let parentGender = 'male'; // Defaultnƒõ mu≈æ
            let parentIcon = 'üë®'; // Ikona mu≈æe
            
            if (parentsCount === 1) {
                // Pokud ji≈æ m√° jednoho rodiƒçe, zjist√≠me jeho pohlav√≠
                const existingParent = app.people.find(p => p.id === person.parents[0]);
                if (existingParent) {
                    if (existingParent.gender === 'male') {
                        parentGender = 'female';
                        parentIcon = 'üë©';
                    } else {
                        parentGender = 'male';
                        parentIcon = 'üë®';
                    }
                }
            }
            
            // Poƒçet tlaƒç√≠tek (2 z√°kladn√≠ + volitelnƒõ 1 pro rodiƒçe)
            const buttonCount = canAddParent ? 3 : 2;
            const totalWidth = (buttonCount * buttonSize) + ((buttonCount - 1) * buttonSpacing);
            const startX = x + (width - totalWidth) / 2;
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            // Ulo≈æen√≠ pozic tlaƒç√≠tek pro klik√°n√≠
            if (!app.actionButtons) app.actionButtons = {};
            app.actionButtons[person.id] = [];
            
            let btnX = startX;
            
            // Tlaƒç√≠tko Upravit
            drawButton(btnX, buttonsY, buttonSize, '‚úèÔ∏è', '#6aa6fd', isDark);
            app.actionButtons[person.id].push({
                x: btnX, y: buttonsY, size: buttonSize,
                action: 'edit',
                onClick: () => openPersonModal(person.id)
            });
            btnX += buttonSize + buttonSpacing;
            
            // Tlaƒç√≠tko Smazat
            drawButton(btnX, buttonsY, buttonSize, 'üóëÔ∏è', '#f44336', isDark);
            app.actionButtons[person.id].push({
                x: btnX, y: buttonsY, size: buttonSize,
                action: 'delete',
                onClick: () => deletePerson(person.id)
            });
            btnX += buttonSize + buttonSpacing;
            
            // Tlaƒç√≠tko P≈ôidat rodiƒçe (pouze pokud m√° m√©nƒõ ne≈æ 2)
            if (canAddParent) {
                drawButton(btnX, buttonsY, buttonSize, parentIcon, '#4caf50', isDark);
                app.actionButtons[person.id].push({
                    x: btnX, y: buttonsY, size: buttonSize,
                    action: 'addParent',
                    onClick: () => addParentToPerson(person.id, parentGender)
                });
            }
        }
        
        function drawButton(x, y, size, icon, color, isDark) {
            const radius = 6;
            
            // St√≠n
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            // Pozad√≠ tlaƒç√≠tka - zaoblen√Ω obd√©ln√≠k
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + size - radius, y);
            ctx.arcTo(x + size, y, x + size, y + radius, radius);
            ctx.lineTo(x + size, y + size - radius);
            ctx.arcTo(x + size, y + size, x + size - radius, y + size, radius);
            ctx.lineTo(x + radius, y + size);
            ctx.arcTo(x, y + size, x, y + size - radius, radius);
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
            ctx.fill();
            
            // R√°meƒçek
            ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            ctx.shadowColor = 'transparent';
            
            // Ikona
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(icon, x + size/2, y + size/2);
        }

        function drawConnections(person) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const lineColor = isDark ? '#607d8b' : '#95a5a6';
            
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Draw to parents with curved lines
            if (person.parents && person.parents.length > 0) {
                person.parents.forEach(parentId => {
                    const parent = app.people.find(p => p.id === parentId);
                    if (parent) {
                        const startX = person.x + 75;
                        const startY = person.y;
                        const endX = parent.x + 75;
                        const endY = parent.y + 100;
                        
                        // Calculate control points for smooth curve
                        const midY = (startY + endY) / 2;
                        
                        // Gradient for parent-child connection
                        const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
                        const borderColor = person.gender === 'male' ? 
                            getComputedStyle(document.documentElement).getPropertyValue('--male-color') :
                            person.gender === 'female' ?
                            getComputedStyle(document.documentElement).getPropertyValue('--female-color') :
                            getComputedStyle(document.documentElement).getPropertyValue('--other-color');
                        gradient.addColorStop(0, borderColor);
                        gradient.addColorStop(1, lineColor);
                        
                        ctx.strokeStyle = gradient;
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        // Smooth bezier curve
                        ctx.bezierCurveTo(
                            startX, midY,
                            endX, midY,
                            endX, endY
                        );
                        ctx.stroke();
                        
                        // Draw small circle at parent connection point
                        ctx.fillStyle = lineColor;
                        ctx.beginPath();
                        ctx.arc(endX, endY, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }
            
            // Draw to partners with dashed line
            if (person.partners && person.partners.length > 0) {
                ctx.strokeStyle = isDark ? '#e74c3c' : '#c0392b';
                ctx.setLineDash([8, 4]);
                ctx.lineWidth = 2;
                
                person.partners.forEach(partnerId => {
                    const partner = app.people.find(p => p.id === partnerId);
                    if (partner) {
                        const startX = person.x + 150;
                        const startY = person.y + 50;
                        const endX = partner.x;
                        const endY = partner.y + 50;
                        
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        
                        if (Math.abs(endX - startX) > 200) {
                            // Curved line for distant partners
                            const midX = (startX + endX) / 2;
                            const curveDepth = 20;
                            ctx.quadraticCurveTo(midX, startY - curveDepth, endX, endY);
                        } else {
                            // Straight line for close partners
                            ctx.lineTo(endX, endY);
                        }
                        ctx.stroke();
                        
                        // Heart symbol for partnership
                        ctx.setLineDash([]);
                        ctx.font = '12px sans-serif';
                        ctx.fillStyle = isDark ? '#e74c3c' : '#c0392b';
                        const midX = (startX + endX) / 2;
                        ctx.fillText('üíï', midX - 6, startY - 8);
                    }
                });
                ctx.setLineDash([]);
            }
        }

        function drawMiniMap() {
            if (app.people.length === 0) return;
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const bgColor = isDark ? '#2c3e50' : '#ffffff';
            
            miniCtx.clearRect(0, 0, miniMap.width, miniMap.height);
            miniCtx.fillStyle = bgColor;
            miniCtx.fillRect(0, 0, miniMap.width, miniMap.height);
            
            const padding = 10;
            const minX = Math.min(...app.people.map(p => p.x));
            const maxX = Math.max(...app.people.map(p => p.x + 150));
            const minY = Math.min(...app.people.map(p => p.y));
            const maxY = Math.max(...app.people.map(p => p.y + 100));
            
            const treeWidth = maxX - minX;
            const treeHeight = maxY - minY;
            
            const scaleX = (miniMap.width - padding * 2) / treeWidth;
            const scaleY = (miniMap.height - padding * 2) / treeHeight;
            const scale = Math.min(scaleX, scaleY);
            
            app.people.forEach(person => {
                const x = (person.x - minX) * scale + padding;
                const y = (person.y - minY) * scale + padding;
                const w = 150 * scale;
                const h = 100 * scale;
                
                const color = person.gender === 'male' ? 
                    getComputedStyle(document.documentElement).getPropertyValue('--male-color') :
                    person.gender === 'female' ?
                    getComputedStyle(document.documentElement).getPropertyValue('--female-color') :
                    getComputedStyle(document.documentElement).getPropertyValue('--other-color');
                
                miniCtx.fillStyle = color;
                miniCtx.fillRect(x, y, w, h);
            });
        }

        // ==================== SIDEBAR ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function switchTab(tabName) {
            // Deactivate all tabs
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ==================== PERSON MODAL ====================
        function openPersonModal(personId = null) {
            const modal = document.getElementById('personModal');
            const form = document.getElementById('personForm');
            form.reset();
            
            // Reset photo
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoText').style.display = 'block';
            
            if (personId) {
                const person = app.people.find(p => p.id === personId);
                app.editingPerson = person;
                document.getElementById('modalTitle').textContent = 'Upravit osobu';
                
                // Fill form
                document.getElementById('firstName').value = person.firstName;
                document.getElementById('lastName').value = person.lastName;
                
                // Set gender radio button
                if (person.gender === 'male') {
                    document.getElementById('genderMale').checked = true;
                } else if (person.gender === 'female') {
                    document.getElementById('genderFemale').checked = true;
                } else {
                    document.getElementById('genderOther').checked = true;
                }
                
                document.getElementById('birthDate').value = person.birthDate || '';
                document.getElementById('birthPlace').value = person.birthPlace || '';
                document.getElementById('deathDate').value = person.deathDate || '';
                document.getElementById('deathPlace').value = person.deathPlace || '';
                document.getElementById('notes').value = person.notes || '';
                
                if (person.photo) {
                    document.getElementById('photoPreview').src = person.photo;
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('photoText').style.display = 'none';
                }
            } else {
                app.editingPerson = null;
                document.getElementById('modalTitle').textContent = 'Nov√° osoba';
                // Default to male
                document.getElementById('genderMale').checked = true;
            }
            
            updateParentSelects();
            updatePartnerSelect();
            modal.classList.add('active');
        }

        function closePersonModal() {
            document.getElementById('personModal').classList.remove('active');
            app.editingPerson = null;
        }

        function updateParentSelects() {
            const parent1Select = document.getElementById('parent1');
            const parent2Select = document.getElementById('parent2');
            
            parent1Select.innerHTML = '<option value="">Rodiƒç 1</option>';
            parent2Select.innerHTML = '<option value="">Rodiƒç 2</option>';
            
            app.people.forEach(person => {
                if (!app.editingPerson || person.id !== app.editingPerson.id) {
                    const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '?';
                    const genderIcon = person.gender === 'male' ? '‚ôÇ' : person.gender === 'female' ? '‚ôÄ' : '‚öß';
                    const displayText = `${genderIcon} ${person.firstName} ${person.lastName} (‚ú± ${birthYear})`;
                    const option1 = new Option(displayText, person.id);
                    const option2 = new Option(displayText, person.id);
                    parent1Select.add(option1);
                    parent2Select.add(option2);
                }
            });
            
            if (app.editingPerson && app.editingPerson.parents) {
                if (app.editingPerson.parents[0]) parent1Select.value = app.editingPerson.parents[0];
                if (app.editingPerson.parents[1]) parent2Select.value = app.editingPerson.parents[1];
            }
        }

        function updateParent2Options() {
            const parent1 = document.getElementById('parent1').value;
            const parent2Select = document.getElementById('parent2');
            
            parent2Select.innerHTML = '<option value="">Rodiƒç 2</option>';
            
            app.people.forEach(person => {
                if (person.id !== parent1 && (!app.editingPerson || person.id !== app.editingPerson.id)) {
                    const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '?';
                    const genderIcon = person.gender === 'male' ? '‚ôÇ' : person.gender === 'female' ? '‚ôÄ' : '‚öß';
                    const displayText = `${genderIcon} ${person.firstName} ${person.lastName} (‚ú± ${birthYear})`;
                    const option = new Option(displayText, person.id);
                    parent2Select.add(option);
                }
            });
            
            if (app.editingPerson && app.editingPerson.parents && app.editingPerson.parents[1]) {
                parent2Select.value = app.editingPerson.parents[1];
            }
        }

        function updatePartnerSelect() {
            const partnerSelect = document.getElementById('partner');
            partnerSelect.innerHTML = '';
            
            app.people.forEach(person => {
                if (!app.editingPerson || person.id !== app.editingPerson.id) {
                    const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '?';
                    const genderIcon = person.gender === 'male' ? '‚ôÇ' : person.gender === 'female' ? '‚ôÄ' : '‚öß';
                    const displayText = `${genderIcon} ${person.firstName} ${person.lastName} (‚ú± ${birthYear})`;
                    const option = new Option(displayText, person.id);
                    partnerSelect.add(option);
                }
            });
            
            if (app.editingPerson && app.editingPerson.partners) {
                Array.from(partnerSelect.options).forEach(option => {
                    option.selected = app.editingPerson.partners.includes(option.value);
                });
            }
        }

        function savePerson(event) {
            event.preventDefault();
            
            // Get selected gender from radio buttons
            let selectedGender = 'male';
            if (document.getElementById('genderMale').checked) {
                selectedGender = 'male';
            } else if (document.getElementById('genderFemale').checked) {
                selectedGender = 'female';
            } else if (document.getElementById('genderOther').checked) {
                selectedGender = 'other';
            }
            
            const personData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                gender: selectedGender,
                birthDate: document.getElementById('birthDate').value,
                birthPlace: document.getElementById('birthPlace').value,
                deathDate: document.getElementById('deathDate').value,
                deathPlace: document.getElementById('deathPlace').value,
                notes: document.getElementById('notes').value,
                parents: [],
                partners: []
            };
            
            const parent1 = document.getElementById('parent1').value;
            const parent2 = document.getElementById('parent2').value;
            if (parent1) personData.parents.push(parent1);
            if (parent2) personData.parents.push(parent2);
            
            const partnerSelect = document.getElementById('partner');
            personData.partners = Array.from(partnerSelect.selectedOptions).map(opt => opt.value);
            
            const photoPreview = document.getElementById('photoPreview');
            if (photoPreview.style.display !== 'none') {
                personData.photo = photoPreview.src;
            }
            
            if (app.editingPerson) {
                // Update existing person
                Object.assign(app.editingPerson, personData);
            } else {
                // Add new person
                personData.id = generateId();
                personData.x = 100 + (app.people.length % 5) * 200;
                personData.y = 100 + Math.floor(app.people.length / 5) * 150;
                app.people.push(personData);
            }
            
            // Update partner relationships
            personData.partners.forEach(partnerId => {
                const partner = app.people.find(p => p.id === partnerId);
                if (partner) {
                    if (!partner.partners) partner.partners = [];
                    if (!partner.partners.includes(personData.id || app.editingPerson.id)) {
                        partner.partners.push(personData.id || app.editingPerson.id);
                    }
                }
            });
            
            saveToHistory();
            savePeopleData();
            updateUI();
            closePersonModal();
        }

        function deletePerson(personId) {
            if (!confirm('Opravdu chcete smazat tuto osobu?')) return;
            
            app.people = app.people.filter(p => p.id !== personId);
            
            // Remove references
            app.people.forEach(person => {
                if (person.parents) {
                    person.parents = person.parents.filter(id => id !== personId);
                }
                if (person.partners) {
                    person.partners = person.partners.filter(id => id !== personId);
                }
            });
            
            saveToHistory();
            savePeopleData();
            updateUI();
        }

        function duplicatePerson(personId) {
            const person = app.people.find(p => p.id === personId);
            const duplicate = { ...person };
            duplicate.id = generateId();
            duplicate.x = person.x + 50;
            duplicate.y = person.y + 50;
            duplicate.firstName = person.firstName + ' (kopie)';
            duplicate.parents = [];
            duplicate.partners = [];
            
            app.people.push(duplicate);
            saveToHistory();
            savePeopleData();
            updateUI();
        }

        // ==================== HISTORY ====================
        function saveToHistory() {
            app.history = app.history.slice(0, app.historyIndex + 1);
            app.history.push(JSON.stringify(app.people));
            app.historyIndex++;
            updateUndoRedoButtons();
        }

        function undo() {
            if (app.historyIndex > 0) {
                app.historyIndex--;
                app.people = JSON.parse(app.history[app.historyIndex]);
                savePeopleData();
                updateUI();
            }
        }

        function redo() {
            if (app.historyIndex < app.history.length - 1) {
                app.historyIndex++;
                app.people = JSON.parse(app.history[app.historyIndex]);
                savePeopleData();
                updateUI();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = app.historyIndex <= 0;
            document.getElementById('redoBtn').disabled = app.historyIndex >= app.history.length - 1;
        }

        // ==================== FILTER & SEARCH ====================
        function filterPeople() {
            updatePeopleList();
        }

        function toggleFilter(element, type) {
            if (type === 'all') {
                app.filterGender = 'all';
                app.filterStatus = 'all';
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                });
                element.classList.add('active');
            } else if (['male', 'female'].includes(type)) {
                app.filterGender = type;
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes('V≈°ichni') || chip.textContent.includes('‚ôÇÔ∏è') || chip.textContent.includes('‚ôÄÔ∏è')) {
                        chip.classList.remove('active');
                    }
                });
                element.classList.add('active');
            } else if (['alive', 'deceased'].includes(type)) {
                app.filterStatus = type;
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.textContent.includes('V≈°ichni') || chip.textContent.includes('üíö') || chip.textContent.includes('üïäÔ∏è')) {
                        chip.classList.remove('active');
                    }
                });
                element.classList.add('active');
            }
            
            updatePeopleList();
        }

        function getFilteredPeople() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            return app.people.filter(person => {
                const matchSearch = !search || 
                    person.firstName.toLowerCase().includes(search) ||
                    person.lastName.toLowerCase().includes(search);
                
                const matchGender = app.filterGender === 'all' || person.gender === app.filterGender;
                
                const matchStatus = app.filterStatus === 'all' ||
                    (app.filterStatus === 'alive' && !person.deathDate) ||
                    (app.filterStatus === 'deceased' && person.deathDate);
                
                return matchSearch && matchGender && matchStatus;
            });
        }

        // ==================== AUTO LAYOUT ====================
        function autoLayout() {
            if (app.people.length === 0) return;
            
            // KROK 1: Ulo≈æen√≠ aktu√°ln√≠ho po≈ôad√≠ osob v generac√≠ch (podle X pozice)
            // Nejd≈ô√≠ve urƒç√≠me generace pomoc√≠ existuj√≠c√≠ho algoritmu
            app.people.forEach(person => {
                person.generation = -1;
            });
            
            // Find leaf people (no children) and set them to generation 0 (youngest generation = root)
            const leaves = app.people.filter(person => {
                // Check if this person has any children
                const hasChildren = app.people.some(p => 
                    p.parents && p.parents.includes(person.id)
                );
                return !hasChildren;
            });
            
            // Set leaves as generation 0
            leaves.forEach(leaf => {
                leaf.generation = 0;
            });
            
            // Iteratively assign generations going upwards (to ancestors)
            let changed = true;
            let iterations = 0;
            const maxIterations = 100;
            
            while (changed && iterations < maxIterations) {
                changed = false;
                iterations++;
                
                app.people.forEach(person => {
                    // Find all children of this person
                    const children = app.people.filter(p => 
                        p.parents && p.parents.includes(person.id) && p.generation !== -1
                    );
                    
                    if (children.length === 0) return; // No known children yet
                    
                    // Parent generation should be max(child generations) + 1
                    const childGens = children.map(c => c.generation);
                    const maxChildGen = Math.max(...childGens);
                    const expectedParentGen = maxChildGen + 1;
                    
                    if (person.generation === -1 || person.generation < expectedParentGen) {
                        person.generation = expectedParentGen;
                        changed = true;
                    }
                    
                    // CONSTRAINT: Partners (people who share children) must be in same generation
                    children.forEach(child => {
                        if (child.parents && child.parents.length >= 2) {
                            child.parents.forEach(partnerId => {
                                if (partnerId !== person.id) {
                                    const partner = app.people.find(p => p.id === partnerId);
                                    if (partner && partner.generation !== -1) {
                                        if (partner.generation !== person.generation) {
                                            // Align both to higher generation
                                            const targetGen = Math.max(person.generation, partner.generation);
                                            if (person.generation < targetGen) {
                                                person.generation = targetGen;
                                                changed = true;
                                            }
                                            if (partner.generation < targetGen) {
                                                partner.generation = targetGen;
                                                changed = true;
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                });
            }
            
            // Handle any people still with unknown generation (isolated)
            app.people.forEach(person => {
                if (person.generation === -1) {
                    person.generation = 0;
                }
            });
            
            // Normalize generations to start from 0
            const minGen = Math.min(...app.people.map(p => p.generation));
            if (minGen < 0) {
                app.people.forEach(person => {
                    person.generation -= minGen;
                });
            }
            
            // Group people by generation
            const generations = {};
            app.people.forEach(person => {
                if (!generations[person.generation]) {
                    generations[person.generation] = [];
                }
                generations[person.generation].push(person);
            });
            
            // KROK 2: Zachov√°n√≠ aktu√°ln√≠ho po≈ôad√≠ osob v ka≈æd√© generaci (podle X)
            // Pro ka≈ædou generaci se≈ôad√≠me osoby podle jejich X pozice a p≈ôi≈ôad√≠me jim index
            Object.keys(generations).forEach(genKey => {
                const people = generations[genKey];
                // Se≈ôadit podle X pozice (zleva doprava)
                people.sort((a, b) => (a.x || 0) - (b.x || 0));
                // P≈ôi≈ôadit indexy pro zachov√°n√≠ po≈ôad√≠
                people.forEach((person, idx) => {
                    person.generationOrder = idx;
                });
            });
            
            // IMPROVED POSITIONING ALGORITHM
            // Position each generation from top (ancestors with highest gen number) to bottom (youngest with gen 0)
            const generationNumbers = Object.keys(generations).map(Number).sort((a, b) => b - a);
            const HORIZONTAL_SPACING = 180;
            const VERTICAL_SPACING = 180;
            
            generationNumbers.forEach((genNum, index) => {
                let people = generations[genNum];
                
                // Rozdƒõlen√≠ na manu√°lnƒõ um√≠stƒõn√© a automaticky rozm√≠stƒõn√©
                const manuallyPositioned = people.filter(p => p.manuallyPositioned);
                const autoPositioned = people.filter(p => !p.manuallyPositioned);
                
                // Zachovat po≈ôad√≠ podle generationOrder pro auto positioned
                autoPositioned.sort((a, b) => (a.generationOrder || 0) - (b.generationOrder || 0));
                
                // Use index to position (first in sorted array = highest gen = top)
                const yPosition = index * VERTICAL_SPACING + 50;
                
                // Aktualizovat Y pozici pro manu√°lnƒõ um√≠stƒõn√© osoby (aby byly ve spr√°vn√© generaci)
                manuallyPositioned.forEach(person => {
                    person.y = yPosition;
                });
                
                if (index === 0) {
                    // First generation in order (highest gen number = oldest ancestors): position from left to right
                    // RESPEKTUJEME PO≈òAD√ç podle generationOrder
                    const positioned = new Set();
                    
                    // P≈ôidat manu√°lnƒõ um√≠stƒõn√© osoby do positioned setu
                    manuallyPositioned.forEach(p => positioned.add(p.id));
                    
                    let currentX = 100;
                    
                    const couples = [];
                    const singles = [];
                    
                    // Proch√°z√≠me pouze AUTO positioned osoby
                    autoPositioned.forEach(person => {
                        if (positioned.has(person.id)) return;
                        
                        // Find partner in same generation who shares children
                        const sharedChildren = app.people.filter(p => 
                            p.parents && p.parents.includes(person.id)
                        );
                        
                        let partner = null;
                        sharedChildren.forEach(child => {
                            if (child.parents) {
                                child.parents.forEach(parentId => {
                                    if (parentId !== person.id) {
                                        const potentialPartner = autoPositioned.find(p => p.id === parentId);
                                        if (potentialPartner && !positioned.has(potentialPartner.id)) {
                                            partner = potentialPartner;
                                        }
                                    }
                                });
                            }
                        });
                        
                        if (partner) {
                            couples.push([person, partner]);
                            positioned.add(person.id);
                            positioned.add(partner.id);
                        } else {
                            singles.push(person);
                            positioned.add(person.id);
                        }
                    });
                    
                    // Position couples - zachovat po≈ôad√≠ z couples pole
                    couples.forEach(([person1, person2]) => {
                        person1.x = currentX;
                        person1.y = yPosition;
                        person2.x = currentX + HORIZONTAL_SPACING;
                        person2.y = yPosition;
                        currentX += HORIZONTAL_SPACING * 2 + 100;
                    });
                    
                    // Position singles
                    singles.forEach(person => {
                        person.x = currentX;
                        person.y = yPosition;
                        currentX += HORIZONTAL_SPACING;
                    });
                    
                } else {
                    // Subsequent generations: position children between/under their parents
                    const positioned = new Set();
                    
                    // P≈ôidat manu√°lnƒõ um√≠stƒõn√© osoby do positioned setu
                    manuallyPositioned.forEach(p => positioned.add(p.id));
                    
                    // First pass: position ONLY AUTO positioned children with parents
                    autoPositioned.forEach(person => {
                        if (positioned.has(person.id)) return;
                        if (!person.parents || person.parents.length === 0) return;
                        
                        const parents = person.parents
                            .map(pid => app.people.find(p => p.id === pid))
                            .filter(p => p && p.x !== undefined);
                        
                        if (parents.length > 0) {
                            // Position child at center of parents
                            const parentXs = parents.map(p => p.x);
                            const minX = Math.min(...parentXs);
                            const maxX = Math.max(...parentXs);
                            person.x = (minX + maxX) / 2 + 75; // Center (+75 for card width/2)
                            person.y = yPosition;
                            positioned.add(person.id);
                        }
                    });
                    
                    // Handle siblings - adjust spacing to avoid overlap
                    const siblingGroups = {};
                    autoPositioned.forEach(person => {
                        if (!person.parents || person.parents.length === 0) return;
                        const parentKey = person.parents.sort().join(',');
                        if (!siblingGroups[parentKey]) {
                            siblingGroups[parentKey] = [];
                        }
                        siblingGroups[parentKey].push(person);
                    });
                    
                    // Adjust sibling positions to prevent overlap
                    Object.values(siblingGroups).forEach(siblings => {
                        if (siblings.length <= 1) return;
                        
                        // ZACHOVAT PO≈òAD√ç podle generationOrder m√≠sto X pozice
                        siblings.sort((a, b) => (a.generationOrder || 0) - (b.generationOrder || 0));
                        
                        const parents = siblings[0].parents
                            .map(pid => app.people.find(p => p.id === pid))
                            .filter(p => p && p.x !== undefined);
                        
                        if (parents.length > 0) {
                            const parentXs = parents.map(p => p.x);
                            const centerX = (Math.min(...parentXs) + Math.max(...parentXs)) / 2 + 75;
                            
                            const totalWidth = (siblings.length - 1) * 200;
                            let startX = centerX - totalWidth / 2;
                            
                            siblings.forEach((sibling, index) => {
                                sibling.x = startX + index * 200;
                            });
                        }
                    });
                    
                    // Second pass: position ONLY AUTO positioned people without parents (orphans in this generation)
                    let orphanX = 50;
                    autoPositioned.forEach(person => {
                        if (!positioned.has(person.id)) {
                            // Find available X position
                            const occupiedXs = autoPositioned
                                .filter(p => positioned.has(p.id))
                                .map(p => p.x)
                                .sort((a, b) => a - b);
                            
                            if (occupiedXs.length > 0) {
                                orphanX = Math.max(...occupiedXs) + HORIZONTAL_SPACING;
                            }
                            
                            person.x = orphanX;
                            person.y = yPosition;
                            orphanX += HORIZONTAL_SPACING;
                            positioned.add(person.id);
                        }
                    });
                }
            });
            
            // Final adjustment: prevent any overlaps (pouze pro AUTO positioned)
            generationNumbers.forEach(genNum => {
                const people = generations[genNum]
                    .filter(p => !p.manuallyPositioned)  // Pouze auto positioned
                    .sort((a, b) => a.x - b.x);
                const MIN_SPACING = 180;
                
                for (let i = 1; i < people.length; i++) {
                    const prev = people[i - 1];
                    const curr = people[i];
                    
                    if (curr.x - prev.x < MIN_SPACING) {
                        curr.x = prev.x + MIN_SPACING;
                    }
                }
            });
            
            saveToHistory();
            savePeopleData();
            redrawTree();
            fitToScreen();
        }

        function resetManualPositions() {
            if (!confirm('Opravdu chcete resetovat v≈°echny ruƒçnƒõ nastaven√© pozice? Po dal≈°√≠m Auto layoutu budou v≈°echny osoby uspo≈ô√°d√°ny automaticky.')) {
                return;
            }
            
            // Odstranit p≈ô√≠znak manuallyPositioned ze v≈°ech osob
            app.people.forEach(person => {
                delete person.manuallyPositioned;
            });
            
            saveToHistory();
            savePeopleData();
            
            alert('‚úÖ Ruƒçn√≠ pozice byly resetov√°ny. Pou≈æijte Auto layout pro nov√© uspo≈ô√°d√°n√≠.');
        }

        function focusPerson(personId) {
            const person = app.people.find(p => p.id === personId);
            if (!person) return;
            
            app.panX = canvas.width / 2 - (person.x + 75) * app.zoom;
            app.panY = canvas.height / 2 - (person.y + 50) * app.zoom;
            redrawTree();
        }

        // ==================== IMPORT / EXPORT ====================
        function exportData() {
            const data = JSON.stringify(app.people, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rodokmen.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        app.people = data;
                        saveToHistory();
                        savePeopleData();
                        updateUI();
                        fitToScreen();
                    } catch (error) {
                        alert('Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportPDF() {
            showProgress('Generov√°n√≠ PDF...');
            
            html2canvas(canvas).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('rodokmen.pdf');
                hideProgress();
            });
        }

        function exportSVG() {
            showProgress('Generov√°n√≠ SVG...');
            
            if (app.people.length === 0) {
                alert('Nen√≠ co exportovat - p≈ôidejte nejprve nƒõjak√© osoby!');
                hideProgress();
                return;
            }
            
            // Calculate bounds
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            app.people.forEach(person => {
                minX = Math.min(minX, person.x);
                minY = Math.min(minY, person.y);
                maxX = Math.max(maxX, person.x + 150);
                maxY = Math.max(maxY, person.y + 100);
            });
            
            const padding = 50;
            const width = maxX - minX + padding * 2;
            const height = maxY - minY + padding * 2;
            const offsetX = -minX + padding;
            const offsetY = -minY + padding;
            
            // Get theme colors
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const bgColor = isDark ? '#1a1a2e' : '#f5f7fa';
            const textColor = isDark ? '#ecf0f1' : '#2c3e50';
            const lineColor = isDark ? '#607d8b' : '#95a5a6';
            
            // Start SVG
            let svg = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
        <style>
            .person-card { filter: drop-shadow(3px 3px 8px rgba(0,0,0,0.3)); }
            .person-card-selected { filter: drop-shadow(0 0 25px var(--accent-color)); }
            .person-text { font-family: sans-serif; text-anchor: middle; }
            .person-name { font-weight: bold; font-size: 14px; fill: ${textColor}; }
            .person-year { font-size: 11px; fill: ${isDark ? '#95a5a6' : '#7f8c8d'}; }
            .person-place { font-size: 11px; fill: ${isDark ? '#95a5a6' : '#7f8c8d'}; }
            .person-age { font-size: 11px; font-weight: bold; }
            .gender-icon { font-size: 16px; text-anchor: start; }
            .connection-line { stroke: ${lineColor}; stroke-width: 2.5; stroke-linecap: round; fill: none; }
            .partner-line { stroke: ${isDark ? '#e74c3c' : '#c0392b'}; stroke-width: 2; stroke-dasharray: 8,4; fill: none; }
        </style>
`;
            
            // Add gradients for each gender
            const maleColor = getComputedStyle(document.documentElement).getPropertyValue('--male-color').trim();
            const femaleColor = getComputedStyle(document.documentElement).getPropertyValue('--female-color').trim();
            const otherColor = getComputedStyle(document.documentElement).getPropertyValue('--other-color').trim();
            
            svg += `
        <linearGradient id="bg-male" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:${isDark ? '#2c3e50' : '#ffffff'};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${isDark ? '#1a252f' : '#f8f9fa'};stop-opacity:1" />
        </linearGradient>
        <linearGradient id="bg-female" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:${isDark ? '#2c3e50' : '#ffffff'};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${isDark ? '#1a252f' : '#f8f9fa'};stop-opacity:1" />
        </linearGradient>
        <linearGradient id="bg-other" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:${isDark ? '#2c3e50' : '#ffffff'};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${isDark ? '#1a252f' : '#f8f9fa'};stop-opacity:1" />
        </linearGradient>
    </defs>
    
    <!-- Background -->
    <rect width="${width}" height="${height}" fill="${bgColor}"/>
    
    <!-- Grid pattern -->
    <g opacity="0.03">
`;
            for (let x = 0; x < width; x += 50) {
                svg += `        <line x1="${x}" y1="0" x2="${x}" y2="${height}" stroke="${isDark ? 'white' : 'black'}" stroke-width="1"/>\n`;
            }
            for (let y = 0; y < height; y += 50) {
                svg += `        <line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="${isDark ? 'white' : 'black'}" stroke-width="1"/>\n`;
            }
            svg += `    </g>\n\n`;
            
            // Draw connections
            svg += `    <!-- Connections -->\n    <g id="connections">\n`;
            app.people.forEach(person => {
                // Parent connections
                if (person.parents && person.parents.length > 0) {
                    person.parents.forEach(parentId => {
                        const parent = app.people.find(p => p.id === parentId);
                        if (parent) {
                            const startX = person.x + 75 + offsetX;
                            const startY = person.y + offsetY;
                            const endX = parent.x + 75 + offsetX;
                            const endY = parent.y + 100 + offsetY;
                            const midY = (startY + endY) / 2;
                            
                            svg += `        <path d="M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}" class="connection-line"/>\n`;
                            svg += `        <circle cx="${endX}" cy="${endY}" r="4" fill="${lineColor}"/>\n`;
                        }
                    });
                }
                
                // Partner connections
                if (person.partners && person.partners.length > 0) {
                    person.partners.forEach(partnerId => {
                        const partner = app.people.find(p => p.id === partnerId);
                        if (partner && partner.id > person.id) { // Draw only once
                            const startX = person.x + 150 + offsetX;
                            const startY = person.y + 50 + offsetY;
                            const endX = partner.x + offsetX;
                            const endY = partner.y + 50 + offsetY;
                            
                            if (Math.abs(endX - startX) > 200) {
                                const midX = (startX + endX) / 2;
                                svg += `        <path d="M ${startX} ${startY} Q ${midX} ${startY - 20} ${endX} ${endY}" class="partner-line"/>\n`;
                            } else {
                                svg += `        <line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" class="partner-line"/>\n`;
                            }
                            svg += `        <text x="${(startX + endX) / 2}" y="${startY - 8}" font-size="12">üíï</text>\n`;
                        }
                    });
                }
            });
            svg += `    </g>\n\n`;
            
            // Draw people
            svg += `    <!-- People -->\n    <g id="people">\n`;
            app.people.forEach(person => {
                const x = person.x + offsetX;
                const y = person.y + offsetY;
                const width = 150;
                const height = app.viewStyle === 'minimal' ? 60 : 100;
                const radius = 10;
                const isSelected = app.selectedPerson === person.id;
                
                const borderColor = person.gender === 'male' ? maleColor :
                                   person.gender === 'female' ? femaleColor : otherColor;
                const gradientId = person.gender === 'male' ? 'bg-male' :
                                  person.gender === 'female' ? 'bg-female' : 'bg-other';
                
                svg += `        <g class="${isSelected ? 'person-card-selected' : 'person-card'}" style="--accent-color: ${borderColor};">\n`;
                
                // Rounded rectangle
                svg += `            <rect x="${x}" y="${y}" width="${width}" height="${height}" rx="${radius}" ry="${radius}" fill="url(#${gradientId})" stroke="${borderColor}" stroke-width="${isSelected ? 4 : 3}"/>\n`;
                
                // Accent bar
                svg += `            <rect x="${x}" y="${y}" width="${width}" height="20" rx="${radius}" ry="${radius}" fill="${borderColor}" opacity="0.2"/>\n`;
                
                // Gender icon
                const genderIcon = person.gender === 'male' ? '‚ôÇ' : person.gender === 'female' ? '‚ôÄ' : '‚öß';
                svg += `            <text x="${x + 8}" y="${y + 18}" class="gender-icon" fill="${borderColor}">${genderIcon}</text>\n`;
                
                // Name
                svg += `            <text x="${x + width/2}" y="${y + 30}" class="person-text person-name">${escapeXml(person.firstName)} ${escapeXml(person.lastName)}</text>\n`;
                
                if (app.viewStyle !== 'minimal') {
                    // Years
                    const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '';
                    const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : '';
                    const years = birthYear && deathYear ? `${birthYear} - ${deathYear}` :
                                  birthYear ? `‚ú± ${birthYear}` : '';
                    svg += `            <text x="${x + width/2}" y="${y + 50}" class="person-text person-year">${years}</text>\n`;
                    
                    if (person.birthPlace && app.viewStyle === 'detailed') {
                        svg += `            <text x="${x + width/2}" y="${y + 70}" class="person-text person-place">üìç ${escapeXml(person.birthPlace)}</text>\n`;
                    }
                    
                    const age = getPersonAge(person);
                    if (age !== null && app.viewStyle === 'detailed') {
                        const ageText = person.deathDate ? `‚Ä† ${age} let` : `${age} let`;
                        svg += `            <text x="${x + width/2}" y="${y + 88}" class="person-text person-age" fill="${borderColor}">${ageText}</text>\n`;
                    }
                }
                
                svg += `        </g>\n`;
            });
            svg += `    </g>\n`;
            
            svg += `</svg>`;
            
            // Helper function to escape XML special characters
            function escapeXml(unsafe) {
                return unsafe.replace(/[<>&'"]/g, (c) => {
                    switch (c) {
                        case '<': return '&lt;';
                        case '>': return '&gt;';
                        case '&': return '&amp;';
                        case '\'': return '&apos;';
                        case '"': return '&quot;';
                    }
                });
            }
            
            // Download SVG
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rodokmen.svg';
            a.click();
            URL.revokeObjectURL(url);
            
            hideProgress();
        }

        function clearAll() {
            if (!confirm('Opravdu chcete smazat v≈°echna data? Tato akce je nevratn√°!')) return;
            
            app.people = [];
            app.history = [];
            app.historyIndex = -1;
            saveToHistory();
            savePeopleData();
            updateUI();
        }

        function clearAllSettings() {
            if (!confirm('Opravdu chcete smazat v≈°echna data vƒçetnƒõ nastaven√≠? Aplikace se vr√°t√≠ do v√Ωchoz√≠ho stavu. Tato akce je nevratn√°!')) return;
            
            // Clear all localStorage items
            localStorage.removeItem('heritage_theme');
            localStorage.removeItem('heritage_color_male');
            localStorage.removeItem('heritage_color_female');
            localStorage.removeItem('heritage_color_other');
            localStorage.removeItem('heritage_view_style');
            localStorage.removeItem('heritage_layout_style');
            localStorage.removeItem('heritage_show_minimap');
            localStorage.removeItem('heritage_people_data');
            
            // Reset app state
            app.people = [];
            app.history = [];
            app.historyIndex = -1;
            
            // Reload page to reset all settings
            window.location.reload();
        }

        // ==================== STATISTICS ====================
        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getPersonAge(person) {
            if (!person.birthDate) return null;
            
            const birthDate = new Date(person.birthDate);
            
            if (person.deathDate) {
                // Deceased - calculate age at death
                const deathDate = new Date(person.deathDate);
                let age = deathDate.getFullYear() - birthDate.getFullYear();
                const monthDiff = deathDate.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && deathDate.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            } else {
                // Alive - calculate current age
                return calculateAge(birthDate);
            }
        }

        function calculatePositions() {
            // This would implement automatic layout based on layoutStyle
            autoLayout();
        }

        function updateStatistics() {
            // Total
            const total = app.people.length;
            document.getElementById('statTotal').textContent = total;
            
            // Gender with progress bars
            const males = app.people.filter(p => p.gender === 'male').length;
            const females = app.people.filter(p => p.gender === 'female').length;
            document.getElementById('statMale').textContent = males;
            document.getElementById('statFemale').textContent = females;
            
            // Update progress bars
            if (total > 0) {
                const malePercent = (males / total * 100).toFixed(0);
                const femalePercent = (females / total * 100).toFixed(0);
                const maleBar = document.getElementById('statMaleBar');
                const femaleBar = document.getElementById('statFemaleBar');
                if (maleBar) maleBar.style.width = malePercent + '%';
                if (femaleBar) femaleBar.style.width = femalePercent + '%';
            }
            
            // Status (alive/deceased)
            const alive = app.people.filter(p => !p.deathDate).length;
            const deceased = app.people.filter(p => p.deathDate).length;
            const aliveEl = document.getElementById('statAlive');
            const deceasedEl = document.getElementById('statDeceased');
            if (aliveEl) aliveEl.textContent = alive;
            if (deceasedEl) deceasedEl.textContent = deceased;
            
            // Generations
            const maxGen = Math.max(...app.people.map(p => {
                let gen = 0;
                let current = p;
                while (current.parents && current.parents.length > 0) {
                    gen++;
                    current = app.people.find(parent => parent.id === current.parents[0]);
                    if (!current) break;
                }
                return gen;
            }));
            document.getElementById('statGenerations').textContent = maxGen + 1;
            
            // Age statistics
            const ages = app.people
                .filter(p => p.birthDate && !p.deathDate)
                .map(p => calculateAge(new Date(p.birthDate)));
            
            if (ages.length > 0) {
                const avgAge = Math.round(ages.reduce((a, b) => a + b, 0) / ages.length);
                document.getElementById('statAvgAge').textContent = avgAge;
                document.getElementById('statOldest').textContent = Math.max(...ages);
                document.getElementById('statYoungest').textContent = Math.min(...ages);
            } else {
                document.getElementById('statAvgAge').textContent = '-';
                document.getElementById('statOldest').textContent = '-';
                document.getElementById('statYoungest').textContent = '-';
            }
            
            // Common names with badges
            const nameCount = {};
            app.people.forEach(p => {
                nameCount[p.firstName] = (nameCount[p.firstName] || 0) + 1;
            });
            const sortedNames = Object.entries(nameCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const namesEl = document.getElementById('statCommonNames');
            if (namesEl) {
                if (sortedNames.length > 0) {
                    namesEl.innerHTML = sortedNames.map(([name, count]) => 
                        `<span class="stat-badge">${name} <strong>${count}√ó</strong></span>`
                    ).join('');
                } else {
                    namesEl.innerHTML = '<span style="opacity: 0.5;">≈Ω√°dn√° data</span>';
                }
            }
            
            // Common places with badges
            const placeCount = {};
            app.people.forEach(p => {
                if (p.birthPlace) {
                    placeCount[p.birthPlace] = (placeCount[p.birthPlace] || 0) + 1;
                }
            });
            const sortedPlaces = Object.entries(placeCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const placesEl = document.getElementById('statCommonPlaces');
            if (placesEl) {
                if (sortedPlaces.length > 0) {
                    placesEl.innerHTML = sortedPlaces.map(([place, count]) => 
                        `<span class="stat-badge">üìç ${place} <strong>${count}√ó</strong></span>`
                    ).join('');
                } else {
                    placesEl.innerHTML = '<span style="opacity: 0.5;">≈Ω√°dn√° data</span>';
                }
            }
        }

        // ==================== UI UPDATE ====================
        function updateUI() {
            updatePeopleList();
            updateStatistics();
            updateUndoRedoButtons();
            redrawTree();
            
            // Show/hide empty state
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = app.people.length === 0 ? 'block' : 'none';
        }

        function updatePeopleList() {
            const list = document.getElementById('peopleList');
            const filtered = getFilteredPeople();
            
            // Update counter
            const totalCount = app.people.length;
            const filteredCount = filtered.length;
            const countEl = document.getElementById('peopleCount');
            const filteredEl = document.getElementById('peopleFiltered');
            
            if (countEl) {
                countEl.textContent = `${totalCount} ${totalCount === 1 ? 'osoba' : totalCount < 5 ? 'osoby' : 'osob'}`;
            }
            
            if (filteredEl) {
                if (filteredCount < totalCount) {
                    filteredEl.textContent = `Zobrazeno: ${filteredCount}`;
                    filteredEl.style.display = 'block';
                } else {
                    filteredEl.style.display = 'none';
                }
            }
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">
                            ${totalCount === 0 ? '≈Ω√°dn√© osoby' : 'Nenalezeny ≈æ√°dn√© osoby'}
                        </div>
                        <div style="font-size: 13px;">
                            ${totalCount === 0 ? 
                                'P≈ôidejte prvn√≠ osobu kliknut√≠m na "‚ûï Nov√° osoba"' : 
                                'Zkuste zmƒõnit filtr nebo vyhled√°v√°n√≠'}
                        </div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(person => {
                const age = getPersonAge(person);
                const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : null;
                const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : null;
                
                const isSelected = app.selectedPerson === person.id;
                const isAlive = !person.deathDate;
                
                // Create initials for avatar
                const initials = (person.firstName[0] + person.lastName[0]).toUpperCase();
                
                // Gender icon
                const genderIcon = person.gender === 'male' ? '‚ôÇ' : 
                                  person.gender === 'female' ? '‚ôÄ' : '‚öß';
                
                // Compact info line
                const infoItems = [];
                if (birthYear && deathYear) {
                    infoItems.push(`${birthYear}-${deathYear}`);
                } else if (birthYear) {
                    infoItems.push(`‚ú±${birthYear}`);
                }
                if (age !== null) {
                    const ageText = person.deathDate ? `‚Ä† ${age} let` : `${age} let`;
                    infoItems.push(ageText);
                }
                if (person.birthPlace) {
                    infoItems.push(`üìç ${person.birthPlace}`);
                }
                
                const infoText = infoItems.join(' ¬∑ ');
                
                return `
                    <div class="person-card ${person.gender} ${isSelected ? 'selected' : ''}" 
                         onclick="selectPerson('${person.id}')">
                        <div class="person-card-header">
                            <div class="person-avatar ${person.gender}">
                                ${initials}
                                <div class="person-avatar-icon">${genderIcon}</div>
                            </div>
                            <div class="person-card-main">
                                <div class="person-card-name">
                                    ${person.firstName} ${person.lastName}
                                    ${isAlive ? 
                                        '<span class="person-status-badge alive">üíö</span>' : 
                                        '<span class="person-status-badge deceased">üïäÔ∏è</span>'
                                    }
                                </div>
                                ${infoText ? `<div class="person-card-info">${infoText}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectPerson(personId) {
            const person = app.people.find(p => p.id === personId);
            app.selectedPerson = personId;
            updatePeopleList();
            // Don't center tree on canvas click - removed focusPerson(personId)
            redrawTree(); // Just redraw to show selection highlight
            
            // Scroll to selected person in sidebar list
            setTimeout(() => {
                const selectedCard = document.querySelector('.person-card.selected');
                if (selectedCard) {
                    selectedCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center'
                    });
                }
            }, 100);
        }

        function deselectPerson() {
            app.selectedPerson = null;
            updatePeopleList();
            redrawTree();
        }

        function addParentToPerson(personId, parentGender = 'male') {
            const person = app.people.find(p => p.id === personId);
            if (!person) return;
            
            const parentsCount = person.parents ? person.parents.length : 0;
            if (parentsCount >= 2) {
                alert('Tato osoba ji≈æ m√° dva rodiƒçe.');
                return;
            }
            
            // Urƒçen√≠ pohlav√≠ nov√©ho rodiƒçe
            let newGender = 'male'; // V√Ωchoz√≠ hodnota
            let firstName = 'Nov√Ω otec';
            
            if (parentsCount === 0) {
                // ≈Ω√°dn√≠ rodiƒçe - p≈ôid√°me mu≈æe
                newGender = 'male';
                firstName = 'Nov√Ω otec';
            } else if (parentsCount === 1) {
                // Jeden rodiƒç existuje - zjist√≠me jeho pohlav√≠
                const existingParent = app.people.find(p => p.id === person.parents[0]);
                if (existingParent) {
                    if (existingParent.gender === 'male') {
                        // Existuj√≠c√≠ rodiƒç je mu≈æ, p≈ôid√°me ≈æenu
                        newGender = 'female';
                        firstName = 'Nov√° matka';
                    } else if (existingParent.gender === 'female') {
                        // Existuj√≠c√≠ rodiƒç je ≈æena, p≈ôid√°me mu≈æe
                        newGender = 'male';
                        firstName = 'Nov√Ω otec';
                    } else {
                        // Existuj√≠c√≠ rodiƒç je 'other', pou≈æijeme opaƒçn√© pohlav√≠
                        newGender = 'female';
                        firstName = 'Nov√° matka';
                    }
                }
            }
            
            // Vytvo≈ôen√≠ nov√©ho rodiƒçe
            const newParent = {
                id: generateId(),
                firstName: firstName,
                lastName: person.lastName,
                gender: newGender,
                birthDate: '',
                birthPlace: '',
                deathDate: '',
                deathPlace: '',
                notes: '',
                parents: [],
                partners: [],
                x: person.x - 200,
                y: person.y - 200
            };
            
            app.people.push(newParent);
            
            // P≈ôid√°n√≠ rodiƒçe k osobƒõ
            if (!person.parents) {
                person.parents = [];
            }
            person.parents.push(newParent.id);
            
            // Pokud existuje druh√Ω rodiƒç, propoj√≠me je jako partnery
            if (parentsCount === 1) {
                const otherParent = app.people.find(p => p.id === person.parents[0]);
                if (otherParent) {
                    // P≈ôid√°n√≠ partnersk√©ho vztahu
                    if (!newParent.partners) newParent.partners = [];
                    if (!otherParent.partners) otherParent.partners = [];
                    
                    if (!newParent.partners.includes(otherParent.id)) {
                        newParent.partners.push(otherParent.id);
                    }
                    if (!otherParent.partners.includes(newParent.id)) {
                        otherParent.partners.push(newParent.id);
                    }
                }
            }
            
            saveToHistory();
            savePeopleData();
            updateUI();
            
            // Otev≈ôen√≠ modalu pro editaci nov√©ho rodiƒçe
            openPersonModal(newParent.id);
        }

        // ==================== SETTINGS ====================
        function changeTheme() {
            const theme = document.getElementById('themeMode').value;
            
            if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            saveSettings();
            redrawTree();
        }

        function updateColors() {
            const male = document.getElementById('colorMale').value;
            const female = document.getElementById('colorFemale').value;
            const other = document.getElementById('colorOther').value;
            
            document.documentElement.style.setProperty('--male-color', male);
            document.documentElement.style.setProperty('--female-color', female);
            document.documentElement.style.setProperty('--other-color', other);
            
            // Update hex value displays
            const maleValue = document.getElementById('colorMaleValue');
            const femaleValue = document.getElementById('colorFemaleValue');
            const otherValue = document.getElementById('colorOtherValue');
            
            if (maleValue) maleValue.textContent = male;
            if (femaleValue) femaleValue.textContent = female;
            if (otherValue) otherValue.textContent = other;
            
            saveSettings();
            redrawTree();
        }

        function changeViewStyle() {
            app.viewStyle = document.getElementById('viewStyle').value;
            saveSettings();
            redrawTree();
        }

        function changeLayout() {
            app.layoutStyle = document.getElementById('layoutStyle').value;
            saveSettings();
            calculatePositions();
            redrawTree();
        }

        function toggleMiniMap() {
            const show = document.getElementById('showMiniMap').checked;
            document.getElementById('miniMap').style.display = show ? 'block' : 'none';
            saveSettings();
        }

        function toggleRuler() {
            // This would add ruler implementation
            alert('Funkce mƒõ≈ô√≠tka bude dostupn√° v p≈ô√≠≈°t√≠ verzi.');
        }

        // ==================== TUTORIAL ====================
        function showTutorial() {
            document.getElementById('tutorialOverlay').classList.add('active');
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('active');
        }

        // ==================== SAMPLE DATA ====================
        function addSampleData() {
            if (app.people.length > 0 && !confirm('P≈ôidat uk√°zkov√° data? Souƒçasn√° data budou zachov√°na.')) {
                return;
            }
            
            const samples = [
                {
                    id: generateId(),
                    firstName: 'Jan',
                    lastName: 'Nov√°k',
                    gender: 'male',
                    birthDate: '1930-05-15',
                    birthPlace: 'Praha',
                    deathDate: '2010-12-20',
                    deathPlace: 'Praha',
                    x: 300,
                    y: 100
                },
                {
                    id: generateId(),
                    firstName: 'Marie',
                    lastName: 'Nov√°kov√°',
                    gender: 'female',
                    birthDate: '1932-08-22',
                    birthPlace: 'Brno',
                    x: 500,
                    y: 100
                },
                {
                    id: generateId(),
                    firstName: 'Petr',
                    lastName: 'Nov√°k',
                    gender: 'male',
                    birthDate: '1955-03-10',
                    birthPlace: 'Praha',
                    x: 400,
                    y: 250
                },
                {
                    id: generateId(),
                    firstName: 'Eva',
                    lastName: 'Svobodov√°',
                    gender: 'female',
                    birthDate: '1958-11-05',
                    birthPlace: 'Olomouc',
                    x: 600,
                    y: 250
                },
                {
                    id: generateId(),
                    firstName: 'Tom√°≈°',
                    lastName: 'Nov√°k',
                    gender: 'male',
                    birthDate: '1980-07-20',
                    birthPlace: 'Praha',
                    x: 500,
                    y: 400
                }
            ];
            
            // Set relationships
            samples[2].parents = [samples[0].id, samples[1].id];
            samples[2].partners = [samples[3].id];
            samples[3].partners = [samples[2].id];
            samples[4].parents = [samples[2].id, samples[3].id];
            
            app.people = [...app.people, ...samples];
            saveToHistory();
            savePeopleData();
            updateUI();
        }

        // ==================== UTILITIES ====================
        function generateId() {
            return 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Pros√≠m vyberte obr√°zek.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('photoPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('photoText').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function showProgress(message) {
            const bar = document.getElementById('progressBar');
            const fill = document.getElementById('progressBarFill');
            bar.classList.add('active');
            fill.style.width = '50%';
        }

        function hideProgress() {
            const bar = document.getElementById('progressBar');
            bar.classList.remove('active');
        }

        // ==================== INITIALIZATION ====================
        // Load settings and data when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });
    </script>
</body>
</html>
